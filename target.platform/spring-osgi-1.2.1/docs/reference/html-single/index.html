<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Dynamic Modules Reference Guide</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="d18e1"></a>Spring Dynamic Modules Reference Guide</h1></div><div><div xmlns:fo="http://www.w3.org/1999/XSL/Format" class="authorgroup"><h2>Authors</h2><p></p><span class="author"><span class="firstname">Adrian M</span> <span class="surname">Colyer</span> 
            (SpringSource)
            </span>, <span class="author"><span class="firstname">Hal</span> <span class="surname">Hildebrand</span> 
            (Oracle)
            </span>, <span class="author"><span class="firstname">Costin</span> <span class="surname">Leau</span> 
            (SpringSource)
            </span>, <span class="author"><span class="firstname">Andy</span> <span class="surname">Piper</span> 
            (BEA)
            </span></div></div><div><p class="releaseinfo">1.2.1</p></div><div><div class="legalnotice"><a name="d18e39"></a><p>Copies of this document may be made for your own use and for
      distribution to others, provided that you do not charge any fee for such
      copies and further provided that each copy contains this Copyright
      Notice, whether distributed in print or electronically.</p></div></div></div><hr></div><div class="toc"><dl><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="part"><a href="#introduction">I. Introduction</a></span></dt><dd><dl><dt><span class="chapter"><a href="#why-Spring DM">1. Why Spring Dynamic Modules?</a></span></dt><dt><span class="chapter"><a href="#requirements">2. Requirements</a></span></dt><dt><span class="chapter"><a href="#get-started">3. Getting Started</a></span></dt><dd><dl><dt><span class="section"><a href="#get-started:first-steps">3.1. First Steps</a></span></dt><dd><dl><dt><span class="section"><a href="#get-started:first-steps:spring">3.1.1. Knowing Spring</a></span></dt><dt><span class="section"><a href="#get-started:first-steps:osgi">3.1.2. Knowing OSGi</a></span></dt><dt><span class="section"><a href="#get-started:first-steps:samples">3.1.3. Trying Out The Samples</a></span></dt></dl></dd><dt><span class="section"><a href="#get-started:help">3.2. Need Help?</a></span></dt><dd><dl><dt><span class="section"><a href="#get-started:help:community">3.2.1. Community Support</a></span></dt><dt><span class="section"><a href="#get-started:help:professional">3.2.2. Professional Support</a></span></dt></dl></dd><dt><span class="section"><a href="#get-started:up-to-date">3.3. Following Development</a></span></dt></dl></dd><dt><span class="chapter"><a href="#what-is-new">4. What is new?</a></span></dt><dd><dl><dt><span class="section"><a href="#dm-1.2.x">4.1. 1.2.x</a></span></dt><dd><dl><dt><span class="section"><a href="#dm-1.2.x:security">4.1.1. Java 2 Security Integration</a></span></dt><dt><span class="section"><a href="#dm-1.2.x:compendium">4.1.2. Compendium Services Support</a></span></dt><dt><span class="section"><a href="#dm-1.2.x:sym-name-change">4.1.3. Changed Spring DM Symbolic Names</a></span></dt><dt><span class="section"><a href="#dm-1.2.x:ebr-usage">4.1.4. Usage of SpringSource Enterprise Bundle Repository (EBR)</a></span></dt></dl></dd><dt><span class="section"><a href="#dm-1.1.x">4.2. 1.1.x</a></span></dt><dd><dl><dt><span class="section"><a href="#dm-1.1.x:web">4.2.1. Web Support</a></span></dt><dd><dl><dt><span class="section"><a href="#dm-1.1.x:web:spring-mvc">4.2.1.1. Spring-MVC Integration</a></span></dt></dl></dd><dt><span class="section"><a href="#dm-1.1.x:io">4.2.2. Classpath Resource Abstraction</a></span></dt><dt><span class="section"><a href="#dm-1.1.x:configuration">4.2.3. Pluggable Extender Configuration</a></span></dt><dt><span class="section"><a href="#dm-1.1.x:improved-class-loading">4.2.4. Improved Class Loading</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#reference">II. Reference Documentation</a></span></dt><dd><dl><dt><span class="chapter"><a href="#bnd-app-ctx">5. Bundles and Application Contexts</a></span></dt><dd><dl><dt><span class="section"><a href="#bnd-app-ctx:extender">5.1. The Spring Dynamic Modules Extender bundle</a></span></dt><dt><span class="section"><a href="#bnd-app-ctx:app-creation">5.2. Application Context Creation</a></span></dt><dd><dl><dt><span class="section"><a href="#bnd-app-ctx:app-creation:mandatory-deps">5.2.1. Mandatory Service Dependencies</a></span></dt><dt><span class="section"><a href="#bnd-app-ctx:app-creation:app-ctx-publication">5.2.2. Application Context Service Publication</a></span></dt></dl></dd><dt><span class="section"><a href="#bnd-app-ctx:bnd-lifecycle">5.3. Bundle Lifecycle</a></span></dt><dt><span class="section"><a href="#bnd-app-ctx:osgi-resource">5.4. The Resource Abstraction</a></span></dt><dt><span class="section"><a href="#bnd-app-ctx:access-bnd-ctx">5.5. Accessing the BundleContext</a></span></dt><dt><span class="section"><a href="#bnd-app-ctx:app-destruction">5.6. Application Context Destruction</a></span></dt><dt><span class="section"><a href="#bnd-app-ctx:access-bnd-ctx:stop-extender">5.7. Stopping the Extender Bundle</a></span></dt></dl></dd><dt><span class="chapter"><a href="#app-deploy">6. Packaging and Deploying Spring-based OSGi applications</a></span></dt><dd><dl><dt><span class="section"><a href="#app-deploy:headers">6.1. Bundle Format And Manifest Headers</a></span></dt><dt><span class="section"><a href="#app-deploy:extender-configuration">6.2. Extender Configuration Options</a></span></dt><dd><dl><dt><span class="section"><a href="#app-deploy:extender-configuration:events">6.2.1. Listening To Extender Events</a></span></dt></dl></dd><dt><span class="section"><a href="#app-deploy:required-libraries">6.3. Required Spring Framework And Spring Dynamic Modules
      Bundles</a></span></dt><dt><span class="section"><a href="#app-deploy:spring-namespaces">6.4. Spring XML Authoring Support</a></span></dt><dt><span class="section"><a href="#app-deploy:imports-exports">6.5. Importing and Exporting Packages</a></span></dt><dt><span class="section"><a href="#app-deploy:ext-libs">6.6. Considerations When Using External Libraries</a></span></dt><dt><span class="section"><a href="#app-deploy:troubleshooting">6.7. Diagnosing Problems</a></span></dt></dl></dd><dt><span class="chapter"><a href="#service-registry">7. The Service Registry</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:export">7.1. Exporting A Spring Bean As An OSGi Service</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:export:intfs">7.1.1. Controlling The Set Of Advertised Service Interfaces For
        An Exported Service</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:export:auto-export">7.1.1.1. Detecting The Advertised Interfaces At Runtime</a></span></dt></dl></dd><dt><span class="section"><a href="#service-registry:export:props">7.1.2. Controlling The Set Of Advertised Properties For An
        Exported Service</a></span></dt><dt><span class="section"><a href="#service-registry:export:depends-on">7.1.3. The depends-on Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:export:ccl">7.1.4. The context-class-loader Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:export:ranking">7.1.5. The ranking Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:export:service:attributes">7.1.6. <code class="literal">service</code> Element Attributes</a></span></dt><dt><span class="section"><a href="#service-registry:export:lifecycle">7.1.7. Service Registration And Unregistration Lifecycle</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:export:lifecycle:interface">7.1.7.1. Using <code class="interfacename">OsgiServiceRegistrationListener</code> Interface</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#service-registry:refs">7.2. Defining References To OSGi Services</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:refs:singular">7.2.1. Referencing An Individual Service</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:refs:singular:interface">7.2.1.1. Controlling The Set Of Advertised Interfaces For The Imported Service</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:filter">7.2.1.2. The <code class="literal">filter</code> Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:bean-name">7.2.1.3. The <code class="literal">bean-name</code> Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:cardinality">7.2.1.4. The <code class="literal">cardinality</code> Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:depends-on">7.2.1.5. The depends-on Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:tccl">7.2.1.6. The context-class-loader Attribute</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:reference:attributes">7.2.1.7. <code class="literal">reference</code> Element Attributes</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:dynamics">7.2.1.8. <code class="literal">reference</code> And OSGi Service Dynamics</a></span></dt><dt><span class="section"><a href="#service-registry:refs:singular:property-editor">7.2.1.9. Getting A Hold Of The Managed Service Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#service-registry:refs:collection">7.2.2. Referencing A Collection Of Services</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:refs:collection:greedy-proxying">7.2.2.1. Greedy Proxying</a></span></dt><dt><span class="section"><a href="#service-registry:refs:collection:attributes">7.2.2.2. Collection (<code class="literal">list</code> And <code class="literal">set</code>) Element Attributes</a></span></dt><dt><span class="section"><a href="#service-registry:refs:collection:dynamics">7.2.2.3. <code class="literal">list</code> / <code class="literal">set</code> And OSGi Service Dynamics</a></span></dt><dt><span class="section"><a href="#service-registry:refs:collection:iterator">7.2.2.4. <code class="interfacename">Iterator</code> Contract And Service Collections</a></span></dt></dl></dd><dt><span class="section"><a href="#service-registry:refs:dynamics">7.2.3. Dealing With The Dynamics Of OSGi Imported Services</a></span></dt><dt><span class="section"><a href="#service-registry:refs:listener-and-proxies">7.2.4. Listener And Service Proxies</a></span></dt><dt><span class="section"><a href="#service-registry:refs:invoker-bundle-context">7.2.5. Accessing The Caller <code class="interfacename">BundleContext</code></a></span></dt></dl></dd><dt><span class="section"><a href="#service-registry:refs:listener-best-practices">7.3. Exporter/Importer Listener Best Practices</a></span></dt><dd><dl><dt><span class="section"><a href="#service-registry:refs:listener-best-practices:cycles">7.3.1. Listener And Cyclic Dependencies</a></span></dt></dl></dd><dt><span class="section"><a href="#service-registry:refs:global-defaults">7.4. Service Importer Global Defaults</a></span></dt><dt><span class="section"><a href="#service-registry:export-import-relationship">7.5. Relationship Between The Service Exporter And Service Importer</a></span></dt></dl></dd><dt><span class="chapter"><a href="#bundles">8. Working With Bundles</a></span></dt><dt><span class="chapter"><a href="#web">9. Web Support</a></span></dt><dd><dl><dt><span class="section"><a href="#web:supported-containers">9.1. Supported Web Containers</a></span></dt><dt><span class="section"><a href="#web:usage">9.2. Web Support Usage</a></span></dt><dt><span class="section"><a href="#web:classpath">9.3. WAR Classpath In OSGi</a></span></dt><dd><dl><dt><span class="section"><a href="#web:classpath:static-resources">9.3.1. Static Resources</a></span></dt><dt><span class="section"><a href="#web:classpath:servlets">9.3.2. Servlets</a></span></dt><dt><span class="section"><a href="#web:classpath:jsps">9.3.3. Java Server Pages</a></span></dt><dd><dl><dt><span class="section"><a href="#web:classpath:jsps:taglibs">9.3.3.1. Tag Libraries</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#web:configuration">9.4. Configuring The Web Extender</a></span></dt><dd><dl><dt><span class="section"><a href="#web:configuration:changing-deployer">9.4.1. Changing The War Deployer</a></span></dt></dl></dd><dt><span class="section"><a href="#web:configuration:customizing-deployer">9.5. Customizing The Standard Deployers</a></span></dt><dt><span class="section"><a href="#web:osgi-artifacts">9.6. OSGi-ready Libraries And Web Development</a></span></dt><dd><dl><dt><span class="section"><a href="#web:osgi-artifacts:containers">9.6.1. Deploying Web Containers As OSGi Bundles</a></span></dt><dd><dl><dt><span class="section"><a href="#web:osgi-artifacts:containers:tomcat">9.6.1.1. Tomcat 5.5.x/6.0.x</a></span></dt><dt><span class="section"><a href="#web:osgi-artifacts:containers:jetty">9.6.1.2. Jetty 6.1.8+/6.2.0</a></span></dt></dl></dd><dt><span class="section"><a href="#web:osgi-artifacts:common-libraries">9.6.2. Common Libraries</a></span></dt></dl></dd><dt><span class="section"><a href="#web:spring-mvc">9.7. Spring-MVC Integration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#compendium">10. Compendium Services</a></span></dt><dd><dl><dt><span class="section"><a href="#compendium:cm">10.1. Configuration Admin</a></span></dt><dd><dl><dt><span class="section"><a href="#compendium:cm:props">10.1.1. Exposing Configuration Admin Entries As <code class="classname">Properties</code></a></span></dt><dt><span class="section"><a href="#compendium:cm:managed-properties">10.1.2. Managed Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#compendium:cm:managed-properties:update">10.1.2.1. Configuration Admin Runtime Updates</a></span></dt></dl></dd><dt><span class="section"><a href="#compendium:cm:managed-service-factories">10.1.3. Managed Service Factories</a></span></dt><dt><span class="section"><a href="#compendium:cm:dict">10.1.4. Direct Access To Configuration Data</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#testing">11. Testing OSGi based Applications</a></span></dt><dd><dl><dt><span class="section"><a href="#testing:mocks">11.1. OSGi Mocks</a></span></dt><dt><span class="section"><a href="#testing:integration">11.2. Integration Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#testing:integration:simple-test">11.2.1. Creating A Simple OSGi Integration Test</a></span></dt><dt><span class="section"><a href="#testing:integration:provisioning">11.2.2. Installing Test Prerequisites</a></span></dt><dt><span class="section"><a href="#testing:integration:advanced-topics">11.2.3. Advanced Testing Framework Topics</a></span></dt><dd><dl><dt><span class="section"><a href="#testing:integration:customize-manifest">11.2.3.1. Customizing The Test Manifest</a></span></dt><dt><span class="section"><a href="#testing:integration:specify-test-jar-content">11.2.3.2. Customizing Test Bundle Content</a></span></dt><dt><span class="section"><a href="#testing:integration:understanding-manifest-creator">11.2.3.3. Understanding The <code class="code">MANIFEST.MF</code> Generation</a></span></dt></dl></dd><dt><span class="section"><a href="#testing:integration:appContext">11.2.4. Creating An OSGi Application Context</a></span></dt><dt><span class="section"><a href="#testing:integration:specify-platform">11.2.5. Specifying The OSGi Platform To Use</a></span></dt><dt><span class="section"><a href="#testing:integration:specify-test-wait-time">11.2.6. Waiting For The Test Dependencies</a></span></dt><dt><span class="section"><a href="#testing:integration:performance">11.2.7. Testing Framework Performance</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#resources">III. Other Resources</a></span></dt><dd><dl><dt><span class="chapter"><a href="#links">12. Useful Links</a></span></dt></dl></dd><dt><span class="part"><a href="#appendixes">IV. Appendixes</a></span></dt><dd><dl><dt><span class="appendix"><a href="#appendix-extensions">A. Extensions</a></span></dt><dd><dl><dt><span class="section"><a href="#appendix-extensions:annotations">A.1. Annotation-Based Injection</a></span></dt><dd><dl><dt><span class="section"><a href="#appendix-extensions:annotations:enable">A.1.1. Enabling/Disabling Annotation Processing</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#appendix-security">B. Security Integration</a></span></dt><dt><span class="appendix"><a href="#appendix-pde-integration">C. Eclipse Plug-in Development integration</a></span></dt><dt><span class="appendix"><a href="#appendix-archetype">D. Spring Dynamic Modules Maven Archetype</a></span></dt><dd><dl><dt><span class="section"><a href="#archetype:generated-content">D.1. Generated Project Features At-A-Glance</a></span></dt></dl></dd><dt><span class="appendix"><a href="#appendix-tips">E. Useful OSGi tips</a></span></dt><dd><dl><dt><span class="section"><a href="#appendix-tips:fragments">E.1. OSGi Fragments</a></span></dt></dl></dd><dt><span class="appendix"><a href="#appendix-roadmap">F. Roadmap</a></span></dt><dd><dl><dt><span class="section"><a href="#d18e6241">F.1. Access to Service References for Collections</a></span></dt><dt><span class="section"><a href="#d18e6255">F.2. Start Level Integration</a></span></dt><dt><span class="section"><a href="#d18e6282">F.3. Web Library Integration</a></span></dt><dt><span class="section"><a href="#d18e6287">F.4. ORM/Persistence Support</a></span></dt><dt><span class="section"><a href="#d18e6300">F.5. OSGi Standards</a></span></dt></dl></dd><dt><span class="appendix"><a href="#appendix-osgi-repo">G. Spring DM OSGi Repository</a></span></dt><dd><dl><dt><span class="section"><a href="#appendix-osgi-repo:old-repo">G.1. Spring DM Temporary OSGi Repository</a></span></dt><dd><dl><dt><span class="section"><a href="#appendix-osgi-repo:conventions">G.1.1. Repository Conventions</a></span></dt><dt><span class="section"><a href="#appendix-osgi-repo:browsing">G.1.2. Browsing The Repository Content</a></span></dt><dt><span class="section"><a href="#appendix-osgi-repo:maven">G.1.3. Using The Repository With Maven</a></span></dt><dt><span class="section"><a href="#appendix-osgi-repo:ant">G.1.4. Using The Repository With Ant/Ivy</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#appendix-schema">H. Spring Dynamic Modules Schema</a></span></dt><dt><span class="appendix"><a href="#appendix-ack">I. Acknowledgments</a></span></dt></dl></dd></dl></div><div class="preface" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="preface"></a>Preface</h2></div></div></div><p>
	Application development has seen significant changes in the last years, moving towards a simpler, more agile,
	POJO-based programming model in order to keep a fast pace. Dependency injection and Aspect Oriented Programming,
	which were once <span class="emphasis"><em>bleeding edge</em></span> ideas, are used on a daily basis by most developers to manage
	and simplify the complexity of their applications.</p><p>However, in terms of deployment, things have remained mainly unchanged. Even though code bases are divided into
	modules, whether logical, conceptual or physical, at runtime they are seen as one monolithic application in which,
	making a change (be it large or small), requires a restart. <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org" target="_top">OSGi</a> aims
	to change this by allowing applications to be divided into <span class="emphasis"><em>modules</em></span> that can have different
	life cycles, dependencies and still exist as a whole.</p><p>Spring Dynamic Modules focuses on integrating Spring Framework powerful, non-invasive programming model and 
    concepts with the dynamics and modularity of OSGi platform. It allows transparent exporting and importing of OSGi
    services, life cycle management and control.</p><p>
	While every effort has been made to ensure that this documentation is comprehensive and there are no errors, 
	nevertheless some topics might require more explanation and some typos might have crept in. If you do spot any 
	mistakes or even more serious errors and you can spare a few cycles during lunch, please do bring the error 
	to the attention of the Spring Dynamic Modules team by raising an 
	<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://opensource.atlassian.com/projects/spring/browse/OSGI" target="_top">issue</a>. Thank you.
	</p></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="introduction"></a>Part&nbsp;I.&nbsp;Introduction</h1></div></div></div><div class="partintro" lang="en"><div></div><p>
            </p><p>This document is the reference guide for Spring Dynamic Modules. It
			defines Spring Dynamic Modules concepts and semantics, the syntax for the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org" target="_top">
			OSGi Service Platform</a> based namespaces, the Dynamic Modules extender bundle
			and the OSGi manifest header entries defined by Dynamic Modules. 
			For a tutorial introduction to building OSGi-based applications with Spring Dynamic 
			Modules see our online <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springframework.org/osgi" target="_top">page</a>.</p><p>

			</p><p>OSGi developers looking for an introduction to Spring should review
			the introductory <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springframework.org/documentation" target="_top">articles</a> 
			on the springframework.org site.</p><p>

			</p><p><span class="emphasis"><em>Note: OSGi is a trademark of the OSGi Alliance. Project
			name is pending final approval from the Alliance.</em></span></p><p>

			</p><p><span class="emphasis"><em>Note: Please see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="./issues.html" target="_top">known issues</a> page for Spring Dynamic Modules  release.</em></span>
		    </p><p>
          </p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="why-Spring DM"></a>Chapter&nbsp;1.&nbsp;Why Spring Dynamic Modules?</h2></div></div></div><p>The Spring Framework is the leading full-stack Java/JEE
    application framework. It provides a lightweight container and a
    non-invasive programming model enabled by the use of dependency
    injection, AOP, and portable service abstractions. The OSGi Service
    Platform offers a dynamic application execution environment in which
    modules (bundles) can be installed, updated, or removed on the fly. It
    also has excellent support for modularity and versioning.</p><p>Spring Dynamic Modules makes it easy to write Spring applications
    that can be deployed in an OSGi execution environment, and that can take
    advantage of the services offered by the OSGi framework. Spring's OSGi
    support also makes development of OSGi applications simpler and more
    productive by building on the ease-of-use and power of the Spring
    Framework. For enterprise applications, the combination of Spring
    Dynamic Modules and the OSGi platform provides:</p><div class="itemizedlist"><ul type="disc"><li><p>Better separation of application logic into modules, with
        runtime enforcement of module boundaries</p></li><li><p>The ability to deploy multiple versions of a module (or
        library) concurrently</p></li><li><p>The ability to dynamically discover and use services provided
        by other modules in the system</p></li><li><p>The ability to dynamically install, update and uninstall
        modules in a running system</p></li><li><p>Use of the Spring Framework to instantiate, configure,
        assemble, and decorate components within and across modules.</p></li><li><p>A simple and familiar programming model for enterprise
        developers to exploit the features of the OSGi platform.</p></li></ul></div><p>We believe that the combination of OSGi and Spring offers a
    comprehensive model for building enterprise applications.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="requirements"></a>Chapter&nbsp;2.&nbsp;Requirements</h2></div></div></div><p>Spring Dynamic Modules 1.0 supports JDK level 1.4 and above 
      and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www2.osgi.org/Specifications/HomePage?section=2" target="_top">OSGi
      R4</a> and above. Bundles deployed for
      use with Spring Dynamic Modules should specify
      <code class="literal">"Bundle-ManifestVersion: 2"</code> in their manifest (OSGi R4). 
      We test against <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.eclipse.org/equinox/" target="_top">Equinox</a> 3.2.x, <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://felix.apache.org/" target="_top">Felix</a> 1.0.3+, and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.knopflerfish.org/" target="_top">Knopflerfish</a> 2.1.x as part of our
      continuous integration process.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="get-started"></a>Chapter&nbsp;3.&nbsp;Getting Started</h2></div></div></div><p>Learning a new framework is not always straight forward. In this section, we (the Spring DM team) 
    tried to provide, what we think is, an easy to follow guide for starting with Spring Dynamic Modules. 
    Of course, feel free to create your own learning 'path' as you see fit and, if possible, please report back
    any improvements to the documentation that can help others.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="get-started:first-steps"></a>3.1.&nbsp;First Steps</h2></div></div></div><p>As explained in <a href="#why-Spring DM" title="Chapter&nbsp;1.&nbsp;Why Spring Dynamic Modules?">Chapter&nbsp;1, <i xmlns:xlink="http://www.w3.org/1999/xlink">Why Spring Dynamic Modules?</i></a>, Spring DM provides integration between
		Spring framework and OSGi. Thus, it is important to become acquainted with both of these frameworks (libraries or
		environments depending on how you want to name them). Throughout the Spring DM documentation, each section provides
		links to resources relevant however, it is best to become familiar with these topics beforehand.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="get-started:first-steps:spring"></a>3.1.1.&nbsp;Knowing Spring</h3></div></div></div><p>Spring DM uses heavily Spring framework's <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/spring-core.html" target="_top">core</a> functionalty, 
			such as the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html" target="_top">IoC</a> container,
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/resources.html" target="_top">resource</a> abstract or
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/aop.html" target="_top">AOP</a> infrastructure. While it is not important
			to know the Spring APIs, understanding the concepts behind them is. At a minimum, the idea behind IoC should be familiar.
			These being said, the more knowledge one has about the Spring, the faster she will pick Spring Dynamic Modules.
			Besides the very comprehensive (and sometimes disarming) documentation that explains in detail the Spring Framework,
			there are a lot of articles, blog entries and books on the matter - take a look at the Spring framework
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.org/documentation" target="_top">home page</a> for more information. In general, this should be the starting point for 
			OSGi (or Eclipse plugin) developers wanting to try Spring DM.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="get-started:first-steps:osgi"></a>3.1.2.&nbsp;Knowing OSGi</h3></div></div></div><p>Java developers, new to OSGi, can start by reading the OSGi Alliance <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/About/HowOSGi" target="_top">introduction</a>,
			the OSGi <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/Specifications/HomePage" target="_top">specifications</a> or one of the articles/blogs 
			available on the internet (such as the SpringSource <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://blog.springsource.com/category/osgi/" target="_top">blogs</a>).
			Additionally, the Spring DM home <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springframework.org/osgi" target="_top">page</a> hosts various links to useful materials.
			</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="get-started:first-steps:samples"></a>3.1.3.&nbsp;Trying Out The Samples</h3></div></div></div><p>Once one is familiar with the concepts behind Spring and OSGi, she can start reading the Spring DM reference documentation (this document) and
			take the Spring DM samples for a spin. The samples are available either in the .zip distribution or from the Spring DM repository.
			The samples are a convenient way to get started quickly with Spring DM as they show various features of Spring DM and help one get pass the 
			initial struggles with OSGi. However, they are not meant as the definitive guide in using OSGi rather, they aim to be a launching pad 
			for "newbies" trying out OSGi in Spring.
			</p><p>The current distribution contains:</p><div class="itemizedlist"><ul type="disc"><li><p>Simple Service Sample</p><p>A simple example that illustrates OSGi service publication and consumption through Spring DM. This is a good starting point
					for users learning the basics.</p></li><li><p>Weather Sample</p><p>A demo that shows more advanced features of Spring DM and OSGi. The application creates a very simple weather information services 
					presenting some best practices in designing an application to take advantage of the modularity offered by OSGi.</p></li><li><p>Simple Web App Sample</p><p>As the name implies, this is a simple web application, containing Servlets, JSPs and JSP tags, that runs inside OSGi through Spring DM.</p></li><li><p>Web Console Sample</p><p>A more complicated sample that demos a Spring MVC annotation based, web application that runs inside OSGi through Spring DM, featuring 
					class path scanning and various Spring taglib. Additionally, the web application interacts with the OSGi environment through the web UI.</p></li></ul></div><p>Each project contains instructions regarding its content and startup procedure. Users are encouraged to experiment with the samples to get a better
			understanding of the technologies used.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="get-started:help"></a>3.2.&nbsp;Need Help?</h2></div></div></div><p>If you encounter issues or you are just looking for an advice, feel free to use one of the links below:</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="get-started:help:community"></a>3.2.1.&nbsp;Community Support</h3></div></div></div><p>The Spring DM <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://forum.springframework.org/forumdisplay.php?f=43" target="_top">forum</a> is a message board for all Spring DM users to
			share information and help each other. Note that registration is needed <span class="emphasis"><em>only</em></span> for posting.
			</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="get-started:help:professional"></a>3.2.2.&nbsp;Professional Support</h3></div></div></div><p>Professional, from-the-source support, with guaranteed response time, is available from <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.com" target="_top">SpringSource</a>,
			the company behind Spring Dynamic Modules and Spring.  
			</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="get-started:up-to-date"></a>3.3.&nbsp;Following Development</h2></div></div></div><p>For information on the Spring DM source code repository, nightly builds and snapshot artifacts please see the Spring DM home 
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.org/osgi" target="_top">page</a>.   
		</p><p>You can help make Spring DM best serve the needs of the Spring community by interacting with developers through the Spring Community 
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://forum.springsource.org" target="_top">forums</a>.</p><p>If you encounter a bug or want to suggest an improvement, 
		please create a ticket on the Spring DM issue <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://jira.springframework.org/" target="_top">tracker</a>.</p><p>To stay up to date with the latest news and announcements in the Spring eco system, subscribe to the 
		Spring Community <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springframework.org/" target="_top">Portal</a>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="what-is-new"></a>Chapter&nbsp;4.&nbsp;What is new?</h2></div></div></div><p>While a relatively young project, each version of Spring Dynamic Modules (even minor ones) offers new functionality. This chapter is a guide to the new
    and improved feature and intended as a high-level, short summary. Please follow the appropriate links for more in-depth information.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dm-1.2.x"></a>4.1.&nbsp;1.2.x</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.2.x:security"></a>4.1.1.&nbsp;Java 2 Security Integration</h3></div></div></div><p>Since 1.2.x, Spring Dynamic Modules is aware of <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/javase/technologies/security/#overview" target="_top">secured</a> 
			environments by making use of dedicated <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/j2se/1.4.2/docs/guide/security/doprivileged.html" target="_top">privileged blocks</a> 
			for executing security sensitive code. Thus, Spring DM can run as a <span class="emphasis"><em>trusted</em></span> library without requiring escalated 
			permissions for its managed bundles. See <a href="#appendix-security" title="Appendix&nbsp;B.&nbsp;Security Integration">Appendix&nbsp;B, <i xmlns:xlink="http://www.w3.org/1999/xlink">Security Integration</i></a> for more information.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.2.x:compendium"></a>4.1.2.&nbsp;Compendium Services Support</h3></div></div></div><p>1.2.x provides integration with the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/javadoc/r4v401/org/osgi/service/cm/package-summary.html" target="_top">Configuration Admin</a>, 
			part of the OSGi compendium services. <a href="#compendium" title="Chapter&nbsp;10.&nbsp;Compendium Services">Chapter&nbsp;10, <i xmlns:xlink="http://www.w3.org/1999/xlink">Compendium Services</i></a> provides more details on the topic.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.2.x:sym-name-change"></a>4.1.3.&nbsp;Changed Spring DM Symbolic Names</h3></div></div></div><p>Since 1.2.0 M2, the Spring DM bundles symbolic names have been aligned with Spring's 2.5.6+. Thus the prefix 
			<code class="literal">org.springframework.bundle.osgi</code> has been changed to <code class="literal">org.springframework.osgi</code>; for example
			Spring DM extender symbolic name was changed from <code class="literal">org.springframework.bundle.osgi.extender</code> to <code class="literal">org.springframework.osgi.extender</code> 
			(notice the missing <code class="literal">bundle</code> word). Additionally, the documentation has been updated to reflect Spring 2.5.6+ symbolic names.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.2.x:ebr-usage"></a>4.1.4.&nbsp;Usage of SpringSource Enterprise Bundle Repository (EBR)</h3></div></div></div><p>To minimize the number of repositories used and the confusion caused by OSGified vs non-OSGified artifacts especially to users using Spring dm Server,
			after 1.2.0 RC1, Spring Dynamic Modules aligned as many of its dependencies as possible with SpringSource <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.com/repository" target="_top">EBR</a>.
			In practice this means that Spring framework artifacts, such as <code class="literal">spring-aop.jar</code> can be now found as <code class="literal">org.springframework.aop.jar</code>;
			We apologize for any inconvenience created to users relying on these naming conventions.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dm-1.1.x"></a>4.2.&nbsp;1.1.x</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.1.x:web"></a>4.2.1.&nbsp;Web Support</h3></div></div></div><p>The biggest feature in Spring Dynamic Modules 1.1.x is the transparent support for web applications on OSGi platforms. By integrating
			directly with web containers (such as Apache Tomcat and Jetty), Spring DM allows WARs using Servlet, JSP and taglib technologies to 
			be used with little or no effort at all. 
			Please see <a href="#web" title="Chapter&nbsp;9.&nbsp;Web Support">Chapter&nbsp;9, <i xmlns:xlink="http://www.w3.org/1999/xlink">Web Support</i></a> for details.
			</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="dm-1.1.x:web:spring-mvc"></a>4.2.1.1.&nbsp;Spring-MVC Integration</h4></div></div></div><p>Additionally, with 1.1.x it is possible to run Spring-MVC applications inside OSGi environments. See <a href="#web:spring-mvc" title="9.7.&nbsp;Spring-MVC Integration">Section&nbsp;9.7, &#8220;Spring-MVC Integration&#8221;</a>
				for more information.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.1.x:io"></a>4.2.2.&nbsp;Classpath Resource Abstraction</h3></div></div></div><p>1.1.x adds support for <code class="literal">classpath:</code> and <code class="literal">classpath*:</code> prefixes to the OSGi <code class="interfacename">Resource</code>
			abstraction. This allows the discovery of classpath resources (such as Spring's 
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/new-in-2.html#new-in-2-ioc-component-scanning" target="_top">component scanning</a>) to
			work out-of-the-box across multiple bundles on the supported OSGi platforms. See <a href="#bnd-app-ctx:osgi-resource" title="5.4.&nbsp;The Resource Abstraction">Section&nbsp;5.4, &#8220;The Resource Abstraction&#8221;</a> for more information.
			</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.1.x:configuration"></a>4.2.3.&nbsp;Pluggable Extender Configuration</h3></div></div></div><p>1.1.x makes it easy to change the default configuration for the various <a href="#extender-pattern" title="Extender Pattern">extender</a>s used by Spring DM. By using
			<a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragments</a>, users can customize the way application contexts are started, the web container used 
			for web deployment or the thread-pool for running Spring applications. Additionally, it is possible to receive events 
			regarding the OSGi Spring application contexts lifecycle. <a href="#bnd-app-ctx:extender" title="5.1.&nbsp;The Spring Dynamic Modules Extender bundle">Section&nbsp;5.1, &#8220;The Spring Dynamic Modules Extender bundle&#8221;</a> lists the available options and explains them in detail.  
			</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="dm-1.1.x:improved-class-loading"></a>4.2.4.&nbsp;Improved Class Loading</h3></div></div></div><p>In 1.1.x, the proxy creation has been improved, leading to better package wiring for the managed bundles. See the FAQ for more information.  
			</p></div></div></div></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="reference"></a>Part&nbsp;II.&nbsp;Reference Documentation</h1></div></div></div><div class="partintro" lang="en"><div><div><div><h1 class="title"><a name="d18e399"></a>Document structure</h1></div></div></div><p>This part of the reference documentation explains the core functionality
	  offered by Spring Dynamic Modules.</p><p><a href="#bnd-app-ctx" title="Chapter&nbsp;5.&nbsp;Bundles and Application Contexts">Chapter&nbsp;5, <i xmlns:xlink="http://www.w3.org/1999/xlink">Bundles and Application Contexts</i></a> describes the relationship between an OSGi Bundle and a 
      Spring Application Context,
      and introduces the Spring Extender Bundle support for instantiating
      application contexts automatically.</p><p><a href="#app-deploy" title="Chapter&nbsp;6.&nbsp;Packaging and Deploying Spring-based OSGi applications">Chapter&nbsp;6, <i xmlns:xlink="http://www.w3.org/1999/xlink">Packaging and Deploying Spring-based OSGi applications</i></a> describes how to deploy the Spring Framework jar files in
      an OSGi environment, and how to reference external APIs from your
      application bundles should you need to do so. This chapter also explains
      some of the issues to be aware of when using existing enterprise
      libraries not designed for OSGi in an OSGi environment.</p><p><a href="#service-registry" title="Chapter&nbsp;7.&nbsp;The Service Registry">Chapter&nbsp;7, <i xmlns:xlink="http://www.w3.org/1999/xlink">The Service Registry</i></a> describes how to export Spring
      beans as services in the OSGi service registry, and how to inject
      references to OSGi services into beans. This chapter also defines how
      the dynamic life-cycle of OSGi services and bundles is supported.</p><p><a href="#bundles" title="Chapter&nbsp;8.&nbsp;Working With Bundles">Chapter&nbsp;8, <i xmlns:xlink="http://www.w3.org/1999/xlink">Working With Bundles</i></a> describes how to declare a bean
      that represents an OSGi bundle, including support for installing new
      bundles into the OSGi platform.</p><p><a href="#web" title="Chapter&nbsp;9.&nbsp;Web Support">Chapter&nbsp;9, <i xmlns:xlink="http://www.w3.org/1999/xlink">Web Support</i></a> explains how to run web applications inside
      an OSGi environment using Spring DM.</p><p><a href="#compendium" title="Chapter&nbsp;10.&nbsp;Compendium Services">Chapter&nbsp;10, <i xmlns:xlink="http://www.w3.org/1999/xlink">Compendium Services</i></a> describes the support provided
      for the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www2.osgi.org/Release4/Download" target="_top">OSGi
      Compendium Services</a>, specifically the Configuration Admin
      service.</p><p><a href="#testing" title="Chapter&nbsp;11.&nbsp;Testing OSGi based Applications">Chapter&nbsp;11, <i xmlns:xlink="http://www.w3.org/1999/xlink">Testing OSGi based Applications</i></a> explains the
      integration testing support provided by Spring Dynamic Modules. This
      support enables you to write simple JUnit integration tests that can
      start up an OSGi environment, install the bundles needed for the
      integration test, execute the test case(s) inside of OSGi, and return
      the results to the runner. This makes it easy to integrate OSGi
      integration testing into any environment that can work with
      JUnit.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="bnd-app-ctx"></a>Chapter&nbsp;5.&nbsp;Bundles and Application Contexts</h2></div></div></div><p>The unit of deployment (and modularity) in OSGi is the <span class="emphasis"><em>bundle</em></span> (see
    section 3.2 of the OSGi Service Platform Core Specification). A bundle
    known to the OSGi runtime is in one of three steady states: installed,
    resolved, or active. Bundles may export services (objects) to the OSGi
    service registry, and by so doing make these services available for other
    bundles to discover and to use. Bundles may also export Java packages,
    enabling other bundles to import the exported types.</p><p>In Spring the primary unit of modularity is an <span class="emphasis"><em>application context</em></span>,
    which contains some number of beans (objects managed by the Spring
    application context). Application contexts can be configured in a
    hierarchy such that a child application context can see beans defined in a
    parent, but not vice-versa. The Spring concepts of exporters and factory
    beans are used to export references to beans to clients outside of the
    application context, and to inject references to services that are defined
    outside of the application context.</p><p>There is a natural affinity between an OSGi bundle and a Spring
    application context. Using Spring Dynamic Modules, an active bundle may
    contain a Spring application context, responsible for the instantiation,
    configuration, assembly, and decoration of the objects (beans) within the
    bundle. Some of these beans may optionally be exported as OSGi services
    and thus made available to other bundles, beans within the bundle may also
    be transparently injected with references to OSGi services.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:extender"></a>5.1.&nbsp;The Spring Dynamic Modules Extender bundle</h2></div></div></div><div class="sidebar"><a name="extender-pattern"></a><p class="title"><b>Extender Pattern</b></p><p>A common pattern in OSGi applications is the <span class="emphasis"><em>extender</em></span>, that 
		(quoting <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.aqute.biz/Blog/HomePage" target="_top">Peter Kriens</a>, 
		OSGi Technical Director), &#8220;<span class="quote">allows other bundles to extend the functionality in a specific domain</span>&#8221;.
		See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/blog/2007/02/osgi-extender-model.html" target="_top">this</a> OSGi Alliance blog
		entry for an in-depth explanation.
		</p></div><p>Spring Dynamic Modules provides an OSGi bundle
      <code class="literal">org.springframework.osgi.extender</code>. This
      bundle is responsible for instantiating the Spring application contexts
      for your application bundles. It serves the same purpose as the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/webintegration.html" target="_top">ContextLoaderListener</a>
      does for Spring web applications. Once the extender bundle is installed
      and started it looks for any existing Spring-powered bundles that are
      already in the <span class="emphasis"><em>ACTIVE</em></span> state and creates application contexts on their
      behalf. In addition, it listens for bundle starting events and
      automatically creates an application context for any Spring-powered
      bundle that is subsequently started. <a href="#app-deploy:headers" title="6.1.&nbsp;Bundle Format And Manifest Headers">Section&nbsp;6.1, &#8220;Bundle Format And Manifest Headers&#8221;</a>
      describes what the extender recognizes as a "Spring-powered bundle" while 
      <a href="#app-deploy:extender-configuration" title="6.2.&nbsp;Extender Configuration Options">Section&nbsp;6.2, &#8220;Extender Configuration Options&#8221;</a> how the extender can be configured.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:app-creation"></a>5.2.&nbsp;Application Context Creation</h2></div></div></div><p>The extender bundle creates applications contexts asynchronously, on a different thread then the one starting the bundle.
      This behaviour ensures that starting an OSGi Service Platform is fast and that bundles with service inter-dependencies do not 
      cause deadlock (waiting for each other) on startup, as pictured below: </p><div class="mediaobject" align="center"><img src="images/start-diagram.png" align="middle" alt="Application Context Sequence Diagram"></div><p>The extender considers only bundles successfully started, that is, bundles in 
      <span class="emphasis"><em>ACTIVE</em></span> state; bundles in other states are ignored.    
      Therefore a Spring-powered bundle will have its application context created <span class="emphasis"><em>after</em></span>
      it has been started. It is possible to force synchronous/serialized creation of application contexts 
      for started bundles, on a bundle-by-bundle basis. See <a href="#app-deploy:headers" title="6.1.&nbsp;Bundle Format And Manifest Headers">Section&nbsp;6.1, &#8220;Bundle Format And Manifest Headers&#8221;</a> for information 
      on how to specify this behaviour.</p><p>If application context creation fails for any reason then the
      failure cause is logged. The bundle remains in the ACTIVE state. There
      will be no services exported to the registry from the application
      context in this scenario.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="bnd-app-ctx:app-creation:mandatory-deps"></a>5.2.1.&nbsp;Mandatory Service Dependencies</h3></div></div></div><p>If an application context declares mandatory dependencies on the
        availability of certain OSGi services (see <a href="#service-registry" title="Chapter&nbsp;7.&nbsp;The Service Registry">Chapter&nbsp;7, <i xmlns:xlink="http://www.w3.org/1999/xlink">The Service Registry</i></a>) then creation
        of the application context is blocked until all mandatory dependencies
        can be satisfied through matching services available in the OSGi
        service registry. Since a service may come and go at any moment in an
        OSGi environment, this behaviour only guarantees that all mandatory
        services were available at the moment creation of the application
        context began. One or more services may subsequently become
        unavailable again during the process of application context creation.
        <a href="#service-registry" title="Chapter&nbsp;7.&nbsp;The Service Registry">Chapter&nbsp;7, <i xmlns:xlink="http://www.w3.org/1999/xlink">The Service Registry</i></a> describes what happens when a mandatory service reference
        becomes unsatisfied. In practice, for most enterprise applications
        built using Spring Dynamic Modules services, the set of available
        services and bundles will reach a steady state once the platform and
        its installed bundles are all started. In such a world the behaviour of
        waiting for mandatory dependencies simply ensures that bundles A and
        B, where bundle A depends on services exported by bundle B, may be
        started in any order.</p><p>A timeout applies to the wait for mandatory dependencies to be
        satisfied. By default the timeout is set to 5 minutes, but this value
        can be configured using the <code class="literal">timeout</code> directive. See
        <a href="#app-deploy:headers" title="6.1.&nbsp;Bundle Format And Manifest Headers">Section&nbsp;6.1, &#8220;Bundle Format And Manifest Headers&#8221;</a> for details.</p><p>It is possible to change the application context creation
        semantics so that application context creation fails if all mandatory
        services are not immediately available upon startup (see the aformentioned 
        section for more information).
        However, regardless of the configuration chosen, the failure of the
        application context will not change the bundle state.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="bnd-app-ctx:app-creation:app-ctx-publication"></a>5.2.2.&nbsp;Application Context Service Publication</h3></div></div></div><p>Once the application context creation for a bundle has
        completed, the application context object is automatically exported as
        a service available through the OSGi Service Registry. The context is
        published under the interface
        <code class="interfacename">org.springframework.context.ApplicationContext</code> (and
        also all of the visible super-interfaces and types implemented by the
        context). The published service has a service property named
        <code class="literal">org.springframework.context.service.name</code> whose
        value is set to the bundle symbolic name of the bundle hosting the
        application context. It is possible to prevent publication of the
        application context as a service using a directive in the bundle's
        manifest. See <a href="#app-deploy:headers" title="6.1.&nbsp;Bundle Format And Manifest Headers">Section&nbsp;6.1, &#8220;Bundle Format And Manifest Headers&#8221;</a> for details.</p><p>Note: the application context is published as a service
        primarily to facilitate testing, administration, and management.
        Accessing this context object at runtime and invoking
        <code class="literal">getBean()</code> or similar operations is discouraged. The
        preferred way to access a bean defined in another application context
        is to export that bean as an OSGi service from the defining context,
        and then to import a reference to that service in the context that
        needs access to the service. Going via the service registry in this
        way ensures that a bean only sees services with compatible versions of
        service types, and that OSGi platform dynamics are respected.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:bnd-lifecycle"></a>5.3.&nbsp;Bundle Lifecycle</h2></div></div></div><p>OSGi is a dynamic platform: bundles may be installed, started,
      updated, stopped, and uninstalled at any time during the running of the
      framework.</p><p>When an active bundle is stopped, any services it exported during
      its lifetime are automatically unregistered and the bundle returns to
      the resolved state. A stopped bundle should release any resources it has
      acquired and terminate any threads. Packages exported by a stopped
      bundle continue to be available to other bundles.</p><p>A bundle in the resolved state may be uninstalled: packages that
      were exported by an uninstalled bundle continue to be available to
      bundles that imported them (but not to newly installed bundles).A bundle 
      in the resolved state may also be updated. The update
      process migrates from one version of a bundle to another version of the
      same bundle.</p><p>Finally of course, a resolved bundle can be started, which
      transitions it to the active state.</p><p>The diagram below represents the bundle states and its transitions:</p><div class="mediaobject" align="center"><img src="images/bundle-states.png" align="middle" alt="Bundle States"></div><p>The OSGi <code class="literal">PackageAdmin</code>
      <code class="literal">refreshPackages</code> operation refreshes packages across
      the whole OSGi framework or a given subset of installed bundles. During
      the refresh, an application context in an affected bundle will be
      stopped and restarted. After a <code class="literal">refreshPackages</code>
      operation, packages exported by older versions of updated bundles, or
      packages exported by uninstalled bundles, are no longer available.
      Consult the OSGi specifications for full details.</p><p>When a Spring-powered bundle is stopped, the application context
      created for it is automatically destroyed. All services exported by the
      bundle will be unregistered (removed from the service registry) and the
      normal application context tear-down life-cycle is observed
      (<code class="interfacename">org.springframework.beans.factory.DisposableBean</code> implementors 
      and <code class="literal">destroy-method</code>
      callbacks are invoked on beans in the context).</p><p>If a Spring-powered bundle that has been stopped is subsequently
      re-started, a new application context will be created for it.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:osgi-resource"></a>5.4.&nbsp;The Resource Abstraction</h2></div></div></div><p>The Spring Framework defines a resource abstraction for loading
      resources within an application context (see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/resources.html" target="_top">Spring's
      resource abstraction</a>). All resource loading is done through the
      <code class="interfacename">org.springframework.core.io.ResourceLoader</code> associated with the application
      context. The <code class="interfacename">org.springframework.core.io.ResourceLoader</code> is also 
      available to beans wishing to load resources programmatically. Resource paths with
      explicit prefixes - such as <code class="literal">classpath:</code> - are treated uniformly
      across all application context types (for example, web application
      contexts and classpath-based application contexts). Relative resource
      paths are interpreted differently based on the type of application
      context being created. This enables easy integration testing outside
      the ultimate deployment environment.</p><p>OSGi 4.0.x specification defines three different spaces from which a
	  resource can be loaded. Spring DM supports all of them through its dedicated OSGi-specific
	  application context and dedicated prefixes:</p><div class="table"><a name="osgi-search-strategies"></a><p class="title"><b>Table&nbsp;5.1.&nbsp;OSGi resource search strategies</b></p><div class="table-contents"><table summary="OSGi resource search strategies" width="100%" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>OSGi Search Strategy</th><th>Prefix</th><th>Explanation</th></tr></thead><tbody><tr><td>Class Space</td><td><code class="literal">classpath:</code></td><td>Searches the bundle classloader (the bundle, all imported packages and required bundles). Forces the bundle to be resolved.
                This method has similar semantics to 
                <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www2.osgi.org/javadoc/r4/org/osgi/framework/Bundle.html#getResource(java.lang.String)" target="_top"><code class="literal">Bundle#getResource(String)</code></a></td></tr><tr><td>Class Space</td><td><code class="literal">classpath*:</code></td><td>Searches the bundle classloader (the bundle and all imported packages and required bundles). Forces the bundle to be resolved.
                This method has similar semantics to 
                <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www2.osgi.org/javadoc/r4/org/osgi/framework/Bundle.html#getResources(java.lang.String)" target="_top"><code class="literal">Bundle#getResources(String)</code></a>
                </td></tr><tr><td>JAR File (or JarSpace)</td><td><code class="literal">osgibundlejar:</code></td><td>Searches only the bundle jar. Provides low-level access without requiring the bundle to be resolved.</td></tr><tr><td>Bundle Space</td><td><code class="literal">osgibundle:</code></td><td>Searches the bundle jar and its attached fragments (if there are any). Does not create a class loader or force the bundle to be resolved.</td></tr></tbody></table></div></div><br class="table-break"><p>Please consult section 4.3.12 of the OSGi specification for an in depth explanation of the differences between them.
	  </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">If no prefix is specified, the bundle space (<code class="literal">osgibundle:</code>) will be used.</td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">Due to the OSGi dynamic nature, a bundle classpath can change during its life time (for example when dynamic imports are used). This might cause different
	  classpath <code class="interfacename">Resource</code>s to be returned when doing pattern matching based on the running environment or target platform.</td></tr></table></div><p>All of the regular Spring resource prefixes such as <code class="literal">file:</code> and
      <code class="literal">http:</code> are also supported, as are the pattern matching wildcards.
      Resources loaded using such prefixes may come from any location, they
      are not restricted to being defined within the resource-loading bundle
      or its attached fragments.</p><p>OSGi platforms may define their own unique prefixes for accessing
      bundle contents. For example, Equinox defines the <code class="literal">bundleresource:</code> and
      <code class="literal">bundlentry:</code> prefixes. These platform specific prefixes may also be
      used with Spring OSGi, at the cost, of course, of tying yourself to a
      particular OSGi implementation.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:access-bnd-ctx"></a>5.5.&nbsp;Accessing the BundleContext</h2></div></div></div><p>In general there is no need to depend on any OSGi APIs when using
      the Spring Dynamic Modules support. If you <span class="emphasis"><em>do</em></span> need
      access to the OSGi <code class="interfacename">BundleContext</code> object for your
      bundle, then Spring makes this easy to do.</p><p>The OSGi application context created by the Spring extender will
      automatically contain a bean of type <code class="interfacename">BundleContext</code>
      and with name <code class="literal">bundleContext</code>. You can inject a
      reference to this bean into any bean in the application context either
      by-name or by-type. In addition, Spring Dynamic Modules defines the
      interface
      <code class="interfacename">org.springframework.osgi.context.BundleContextAware</code>:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BundleContextAware {
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setBundleContext(BundleContext context);
}</pre><p>Any bean implementing this interface will be injected with a
      reference to the bundle context when it is configured by Spring. If you
      wish to use this facility within a bundle, remember to import the
      package <code class="literal">org.springframework.osgi.context</code> in your
      bundle manifest.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:app-destruction"></a>5.6.&nbsp;Application Context Destruction</h2></div></div></div><p>The application context is bound to the bundle in which it lives. Thus, if the declaring 
      bundle is being shutdown, the application context will be destroyed as well,
      all exported services being unregistered and all service imported dispose of.
      </p><p>As opposed to the application creation, the application context is destroyed in a synchronized manner,
      on the same thread that stops the bundle. This is required since once stopped, a bundle can not longer be used
      (even for class loading) preventing the application context shutdown from executing correctly.
      </p><div class="mediaobject" align="center"><img src="images/stop-diagram.png" align="middle" alt="Application Context Sequence Diagram"></div><p>Note that a bundle can be closed individually or as part of a bigger
      event such as shutting down the entire OSGi platform. In this case or when the extender
      bundle is being closed down, the application contexts will be closed in a managed
      manner, based on the service dependencies between them. Please see the next section for more
      details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bnd-app-ctx:access-bnd-ctx:stop-extender"></a>5.7.&nbsp;Stopping the Extender Bundle</h2></div></div></div><p>If the extender bundle is stopped, then all the application
      contexts created by the extender will be destroyed. Application contexts
      are shutdown in the following order:</p><div class="orderedlist"><ol type="1"><li><p>Application contexts that do not export any services, or that
          export services that are not currently referenced, are shutdown in
          reverse order of bundle id. (Most recently installed bundles have
          their application contexts shutdown first).</p></li><li><p>Shutting down the application contexts in step (1) may have
          released references these contexts were holding such that there are
          now additional application contexts that can be shutdown. If so,
          repeat step 1 again.</p></li><li><p>If there are no more active application contexts, we have
          finished. If there <span class="emphasis"><em>are</em></span> active application
          contexts then there must be a cyclic dependency of references. The
          circle is broken by determining the highest ranking service exported
          by each context: the bundle with the lowest ranking service in this
          set (or in the event of a tie, the highest service id), is shut
          down. Repeat from step (1).</p></li></ol></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="app-deploy"></a>Chapter&nbsp;6.&nbsp;Packaging and Deploying Spring-based OSGi applications</h2></div></div></div><p>A traditional Spring application uses either a single application
    context, or a parent context containing service layer, data layer, and
    domain objects with a child context containing web layer components. The
    application context may well be formed by aggregating the contents of
    multiple configuration files.</p><p>When deploying an application to OSGi the more natural structure is
    to package the application as a set of peer bundles (application contexts)
    interacting via the OSGi service registry. Independent subsystems should
    be packaged as independent bundles or sets of bundles (vertical
    partitioning). A subsystem may be package in a single bundle, or divided
    into several bundles partitioned by layer (horizontal partitioning). A
    straightforward web application may for example be divided into four
    modules (bundles): a web bundle, service layer bundle, data layer bundle,
    and domain model bundle. Such an application would look like this:</p><div class="mediaobject" align="center"><img src="images/spring-osgi-model.png" align="middle" alt="Bundles and Application Contexts"></div><p>In this example the data layer bundle yields a data layer
    application context that contains a number of internal components (beans).
    Two of those beans are made publicly available outside of the application
    context by publishing them as services in the OSGi service
    registry.</p><p>The service layer bundle yields a service layer application context
    that contains a number of internal components (beans). Some of those
    components depend on data layer services, and import those services from
    the OSGi service registry. Two of the service layer components are made
    externally available as services in the OSGi service registry.</p><p>The web component bundle yields a web application context that
    contains a number of internal components (beans). Some of those components
    depend on application services, and import those services from the OSGi
    service registry. Since the domain model bundle contributes only domain
    model types, but does not need to create any components of its own, it has
    no associated application context.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:headers"></a>6.1.&nbsp;Bundle Format And Manifest Headers</h2></div></div></div><p>Each application module should be packaged as an OSGi bundle. A
      bundle is essentially a jar file with a
      <code class="literal">META-INF/MANIFEST.MF</code> file containing a series of
      headers recognized by the OSGi Service Platform. See the OSGi Service
      Platform Core Specification section 3.2 for details. Some OSGi
      implementations may support exploded jar files, but the format remains
      the same.</p><p>The Spring extender recognizes a bundle as "Spring-powered" and
      will create an associated application context when the bundle is started
      and one or both of the following conditions is true:</p><div class="itemizedlist"><ul type="disc"><li><p>The bundle path contains a folder
          <code class="literal">META-INF/spring</code> with one or more files in that
          folder with a '.xml' extension.</p></li><li><p><code class="literal">META-INF/MANIFEST.MF</code> contains a manifest
          header <code class="literal">Spring-Context</code>.</p></li></ul></div><p>In addition, if the optional
      <code class="literal">SpringExtender-Version</code> header is declared in the
      bundle manifest, then the extender will only recognize bundles where the
      specified version constraints are satisfied by the version of the
      extender bundle (<code class="literal">Bundle-Version</code>). The value of the
      <code class="literal">SpringExtender-Version</code> header must follow the syntax
      for a version range as specified in section 3.2.5 of the OSGi Service
      Platform Core Specification.</p><p>In the absence of the <code class="literal">Spring-Context</code> header the
      extender expects every ".xml" file in the
      <code class="literal">META-INF/spring</code> folder to be a valid Spring
      configuration file, and all directives (see below) take on their default
      values.</p><p>An application context is constructed from this set of files. A
      suggested practice is to split the application context configuration
      into at least two files, named by convention
      <span class="emphasis"><em>modulename</em></span>-context.xml and
      <span class="emphasis"><em>modulename</em></span>-osgi-context.xml. The
      <span class="emphasis"><em>modulename</em></span>-context.xml file contains regular bean
      definitions independent of any knowledge of OSGi. The
      <span class="emphasis"><em>modulename</em></span>-osgi-context.xml file contains the bean
      definitions for importing and exporting OSGi services. It may (but is
      not required to) use the Spring Dynamic Modules OSGi schema as the
      top-level namespace instead of the Spring 'beans' namespace.</p><p>The <code class="literal">Spring-Context</code> manifest header may be used
      to specify an alternate set of configuration files. The resource paths
      are treated as relative resource paths and resolve to entries defined in
      the bundle and the set of attached <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragments</a>. 
      When the
      <code class="literal">Spring-Context</code> header defines at least one
      configuration file location, any files in
      <code class="literal">META-INF/spring</code> are ignored unless directly
      referenced from the <code class="literal">Spring-Context</code> header.</p><p>The syntax for the <code class="literal">Spring-Context</code> header value
      is:</p><pre class="programlisting">Spring-Context-Value ::= context ( ',' context ) *
context ::= path ( ';' path ) * (';' directive) *
</pre><p>This syntax is consistent with the OSGi Service Platform common
      header syntax defined in section 3.2.3 of the OSGi Service Platform Core
      Specification.</p><p>For example, the manifest entry:</p><pre class="programlisting">Spring-Context: config/account-data-context.xml, config/account-security-context.xml
</pre><p>will cause an application context to be instantiated using the
      configuration found in the files
      <code class="literal">account-data-context.xml</code> and
      <code class="literal">account-security-context.xml</code> in the bundle jar
      file.</p><p>A number of directives are available for use with the
      <code class="literal">Spring-Context</code> header. These directives are:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="emphasis"><em>create-asynchronously</em></span> (false|true):
          controls whether the application context is created asynchronously
          (the default), or synchronously.</p><p>For example:</p><pre class="programlisting">Spring-Context: *;create-asynchronously:=false 
</pre><p>Creates an application context synchronously, using all of the
      "*.xml" files contained in the <code class="literal">META-INF/spring</code>
      folder.</p><pre class="programlisting">Spring-Context: config/account-data-context.xml;create-asynchrously:=false
</pre><p>Creates an application context synchronously using the
      <code class="literal">config/account-data-context.xml</code> configuration file.
      Care must be taken when specifying synchronous context creation as the
      application context will be created on the OSGi event thread, blocking
      further event delivery until the context is fully initialized. If an
      error occurs during the synchronous creation of the application context
      then a <code class="literal">FrameworkEvent.ERROR</code> event is raised. The bundle will still
      proceed to the <code class="literal">ACTIVE</code> state.</p></li><li><p><span class="emphasis"><em>wait-for-dependencies</em></span> (true|false):
          controls whether or not application context creation should wait for
          any mandatory service dependencies to be satisfied before proceeding
          (the default), or proceed immediately without waiting if
          dependencies are not satisfied upon startup.</p><p>For example:</p><pre class="programlisting">Spring-Context: config/osgi-*.xml;wait-for-dependencies:=false
</pre><p>Creates an application context using all the files matching
      "osgi-*.xml" in the config directory. Context creation will begin
      immediately even if dependencies are not satisfied. This essentially
      means that mandatory service references are treated as though they were
      optional - clients will be injected with a service object that may not
      be backed by an actual service in the registry initially. See 
      <a href="#service-registry:refs:singular:dynamics" title="7.2.1.8.&nbsp;reference And OSGi Service Dynamics">Section&nbsp;7.2.1.8, &#8220;<code class="literal">reference</code> And OSGi Service Dynamics&#8221;</a> for more details.</p></li><li><p><span class="emphasis"><em>timeout</em></span> (300): the time to wait (in
          seconds) for mandatory dependencies to be satisfied before giving up
          and failing application context creation. This setting is ignored if
          <code class="literal">wait-for-dependencies:=false</code> is specified. The
          default is 5 minutes (300 seconds).</p><p>For example:</p><pre class="programlisting">Spring-Context: *;timeout:=60
</pre><p>Creates an application context that waits up to 1 minute (60 seconds)
	  for its mandatory dependencies to appear.
	  </p></li><li><p><span class="emphasis"><em>publish-context</em></span> (true|false): controls
          whether or not the application context object itself should be
          published in the OSGi service registry. The default is to publish
          the context.</p><p>For example:</p><pre class="programlisting">Spring-Context: *;publish-context:=false
</pre><p>If there is no Spring-Context manifest entry, or no value is
      specified for a given directive in that entry, then the directive takes
      on its default value.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:extender-configuration"></a>6.2.&nbsp;Extender Configuration Options</h2></div></div></div><p>Aside from bundle-specific configurations, Spring DM allows the core extender generic behaviour be configured. This is useful when
    	embedding Spring DM inside a managed environment or when a bundles-wide functionality is desired. To allow for extensible configuration,
    	the extender relies on OSGi <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragments</a> to override its defaults. The extender looks for all XML files 
    	under <code class="literal">META-INF/spring/extender</code> folder in its bundle space and assembled them into an application context 
    	(of type <code class="classname">OsgiBundleXmlApplicationContext</code>) 
    	that is used internally as its configuration. To override a default setting of the extender, look up the appropriate bean
    	name from the table below, define it in a suitable manner and then attach it as a <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragment</a> to the 
    	<code class="literal">spring-osgi-extender.jar</code>, using:</p><pre class="programlisting">Fragment-Host: org.springframework.osgi.extender</pre><p>The following beans are currently recognized by the extender:</p><div class="table"><a name="extender-configuration-options"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Extender Configuration Options</b></p><div class="table-contents"><table summary="Extender Configuration Options" width="100%" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>Bean Name</th><th>Type</th><th>Role</th><th>Default Behaviour/Value</th></tr></thead><tbody><tr><td><code class="literal">taskExecutor</code></td><td><code class="interfacename">TaskExecutor</code>
                <sup>[<a name="d18e983" href="#ftn.d18e983">a</a>]</sup></td><td>Creates and runs the Spring application contexts associated with each bundle. The task executor is responsible for managing its own pool
                of threads used by the application contexts</td><td><code class="classname">SimpleAsyncTaskExecutor</code> is used by default which means a new thread will be created for each application contexts. While this
                is suitable for testing and development, we strongly recommend to use a <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Thread_pool_pattern" target="_top">thread pool</a> 
                in a production environment</td></tr><tr><td><code class="literal">shutdownTaskExecutor</code></td><td><code class="interfacename">TaskExecutor</code>
                <sup>[<a name="d18e1005" href="#ftn.d18e1005">b</a>]</sup></td><td>Destroys managed Spring application contexts associated with each bundle. The task executor is responsible for managing its own pool
                of threads used by the application contexts</td><td><code class="classname">TimerTaskExecutor</code> is used by default which means all application context will be destroyed in a serialized manner (which is
                desired). Since the shutdown order normally matters, it is recommended to keep the default implementation or, for managed environments, to use a thread-pool
                that executes only one task at a time (so that contexts are stopped in the given order).</td></tr><tr><td><code class="literal">extenderProperties</code></td><td><code class="classname">java.util.Properties</code></td><td>Defines simple properties such as the maximum time for contexts to gracefully close</td><td>See the <a href="#extender-configuration-options-properties" title="Table&nbsp;6.2.&nbsp;Available extenderProperties">defaults</a> below</td></tr><tr><td><code class="literal">osgiApplicationEventMulticaster</code></td><td><code class="interfacename">ApplicationEventMulticaster</code>
                <sup>[<a name="d18e1038" href="#ftn.d18e1038">c</a>]</sup>
                </td><td><code class="literal"><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/context/event/ApplicationEventMulticaster.html" target="_top">
                ApplicationEventMultiCaster</a></code> used for propagating Spring DM <a href="#app-deploy:extender-configuration:events" title="6.2.1.&nbsp;Listening To Extender Events">events</a>
                to third parties. 
                </td><td>An instance of <code class="classname"><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/context/event/SimpleApplicationEventMulticaster.html" target="_top">
                SimpleApplicationEventMulticaster</a></code> is used.
                See <code class="classname">AbstractApplicationContext</code> 
                <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/context/support/AbstractApplicationContext.html" target="_top">javadoc</a> 
                for more information regarding available beans in an application context.</td></tr><tr><td><a name="extender-configuration-options:acc"></a><code class="literal">applicationContextCreator</code></td><td><code class="interfacename">OsgiApplicationContextCreator</code>
                <sup>[<a name="extender-configuration-options:extender.pkg" href="#ftn.extender-configuration-options:extender.pkg">d</a>]</sup>
                </td><td>Allows customization of the application context created by the extender. This includes changing the application context class type or additional
                processing (see <a href="#extender-configuration-options:obfpp">below</a>).</td><td>The Extender default behaviour applies.</td></tr><tr><td><a name="extender-configuration-options:obfpp"></a><span class="emphasis"><em>(irrelevant)</em></span></td><td><code class="interfacename">OsgiBeanFactoryPostProcessor</code>
                <sup>[<a href="#ftn.extender-configuration-options:extender.pkg">d</a>]</sup>
                </td><td>Similar to Spring's <code class="interfacename">BeanFactoryPostProcessor</code> interface, beans of type
                <code class="interfacename">OsgiBeanFactoryPostProcessor</code> are automatically detected and applied to all contexts created by the
                extender (whether <a href="#extender-configuration-options:acc">user-defined</a> or not). This type of post processor
                is useful as it allows customization of the bean factory such as adding/removing/changing existing bean definitions or adding new bean
                instances.</td><td>The Extender default behaviour applies.</td></tr><tr><td><a name="extender-configuration-options:contextListener"></a><code class="literal">osgiApplicationContextListener</code></td><td><code class="interfacename">OsgiBundleApplicationContextListener</code>
                <sup>[<a name="extender-configuration-options:event.pkg" href="#ftn.extender-configuration-options:event.pkg">e</a>]</sup>
                </td><td>Application context event listener registered automatically by the extender.</td><td>Default implementation provides logging of the managed application contexts lifecycle.</td></tr></tbody><tbody class="footnotes"><tr><td colspan="4"><div class="footnote"><code class="literal"><sup>[<a name="ftn.d18e983" href="#d18e983">a</a>] </sup>org.springframework.core.task</code></div><div class="footnote"><code class="literal"><sup>[<a name="ftn.d18e1005" href="#d18e1005">b</a>] </sup>org.springframework.core.task</code></div><div class="footnote"><code class="literal"><sup>[<a name="ftn.d18e1038" href="#d18e1038">c</a>] </sup>org.springframework.context.event</code></div><div class="footnote"><code class="literal"><sup>[<a name="ftn.extender-configuration-options:extender.pkg" href="#extender-configuration-options:extender.pkg">d</a>] </sup>org.springframework.osgi.extender package</code></div><div class="footnote"><code class="literal"><sup>[<a name="ftn.extender-configuration-options:event.pkg" href="#extender-configuration-options:event.pkg">e</a>] </sup>org.springframework.osgi.context.event package</code></div></td></tr></tbody></table></div></div><br class="table-break"><p>From the <code class="literal">extenderProperties</code> bean, the following properties are recognized:</p><div class="table"><a name="extender-configuration-options-properties"></a><p class="title"><b>Table&nbsp;6.2.&nbsp;Available <code class="literal">extenderProperties</code></b></p><div class="table-contents"><table summary="Available extenderProperties" width="100%" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>Name</th><th>Type</th><th>Description</th><th>Default Value</th></tr></thead><tbody><tr><td><code class="literal">shutdown.wait.time</code></td><td><code class="classname">java.lang.Long</code></td><td>The amount of time the extender will wait for each application context to shutdown gracefully. Expressed in milliseconds.</td><td>10000 ms (10 s)</td></tr><tr><td><code class="literal">process.annotations</code></td><td><code class="classname">java.lang.Boolean</code></td><td>Flag indicating whether or not, the extender will process Spring DM annotations. Note that this can be enabled in each process bundle
                by adding the appropriate bean post processor. See <a href="#appendix-extensions:annotations" title="A.1.&nbsp;Annotation-Based Injection">Section&nbsp;A.1, &#8220;Annotation-Based Injection&#8221;</a> for more information.</td><td>false</td></tr><tr><td><code class="literal">dependencies.wait.time</code></td><td><code class="classname">java.lang.Long</code></td><td>The amount of time the newly created application contexts will wait for their mandatory service dependencies during startup. Expressed
                in milliseconds. This settings is used only if the context owning bundle manifest does <span class="emphasis"><em>not</em></span> define a value. </td><td>300000 ms (300 s or 5 min)</td></tr></tbody></table></div></div><br class="table-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">Since an application context is used, the full power of the Spring IoC container can be used for creating the extender configuration beans</td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="app-deploy:extender-configuration:events"></a>6.2.1.&nbsp;Listening To Extender Events</h3></div></div></div><p>There are cases when the failure or succesful startup of an application context needs to be acknowledged for logging purposes (for example).
    		For these cases, Spring DM offers a dedicated package <code class="literal">org.springframework.osgi.context.event</code> which defines the events that
    		OSGi application contexts can send during their lifecycle. At the moment, the following events are available:</p><div class="table"><a name="app-deploy:extender-configuration:events-table"></a><p class="title"><b>Table&nbsp;6.3.&nbsp;Spring DM build-in events</b></p><div class="table-contents"><table summary="Spring DM build-in events" width="100%" border="1"><colgroup><col><col></colgroup><thead><tr><th>Event</th><th>Explanation</th></tr></thead><tbody><tr><td><code class="classname">OsgiBundleContextRefreshedEvent</code></td><td>Published when an OSGi application context has been succesfully initialized or refreshed (e.g. using the 
	                <code class="methodname">refresh()</code>  method on the <code class="interfacename">ConfigurableApplicationContext</code> interface).
	                There are no guarantees on how many times this event might be received during the lifecycle of an application context - this is
	                left up to the used implementation.</td></tr><tr><td><code class="classname">OsgiBundleContextFailedEvent</code></td><td>Published when an OSGi application context is closed due to a failure. This event can appear any time during the lifecycle
	                of an application context - before, during or after refresh. Usually the cause indicates an error in the configuration - syntax typo,
	                incorrect wiring, missing bean and so forth.</td></tr><tr><td><code class="classname">OsgiBundleContextClosedEvent</code></td><td>Published when an OSGi application context is closed after a successful refresh (normally issued a Spring bundle is being stopped).
	                </td></tr></tbody></table></div></div><br class="table-break"><p>Parties interested in receiving these events should implement <code class="interfacename">OsgiBundleApplicationContextListener</code> and
    		then publish it as an OSGi service. The Spring DM extender will automatically detect the listener and will send the events to it. By taking advantage
    		of the OSGi service registry, the extender decouples the received from the event publisher and moreover, makes the registration/unregistration process
    		easier. For example, there is nothing special a client should do to unregister the listener - simply stopping the bundle will automatically 
    		unregister all its published services (including the listener), an event which will detected by the extender which will remove the listener.
    		Of course, it is also possible for the client to unregister the listener manually during a bundle lifecycle.
			    		
    		</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">The Spring DM events semantics are slightly different then
    		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html#context-functionality-events" target="_top">Spring's</a>. The OSGi events are
    		not sent to beans inside the <span class="emphasis"><em>causing</em></span> application context but to other parties (possible beans in other application contexts)
    		interested in monitoring its behaviour.</td></tr></table></div><p>
    		</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:required-libraries"></a>6.3.&nbsp;Required Spring Framework And Spring Dynamic Modules
      Bundles</h2></div></div></div><p>The Spring Dynamic Modules project provides a number of bundle
      artifacts that must be installed in your OSGi platform in order for the
      Spring extender to function correctly:</p><div class="itemizedlist"><ul type="disc"><li><p>The extender bundle itself,
          <code class="literal">org.springframework.osgi.extender</code></p></li><li><p>The core implementation bundle for the Spring Dynamic Modules
          support, <code class="literal">org.springframework.osgi.core</code></p></li><li><p>The Spring Dynamic Modules I/O support library bundle,
          <code class="literal">org.springframework.osgi.io</code></p></li></ul></div><p>In addition the Spring Framework provides a number of bundles that
      are required to be installed. As of release 2.5 of the Spring Framework,
      the Spring jars included in the Spring distribution are valid OSGi
      bundles and can be installed directly into an OSGi platform. The minimum
      required set of bundles is:</p><div class="itemizedlist"><ul type="disc"><li><p>spring-core.jar (bundle symbolic name
          <code class="literal">org.springframework.core</code>)</p></li><li><p>spring-context.jar (bundle symbolic name
          <code class="literal">org.springframework.context</code>)</p></li><li><p>spring-beans.jar (bundle symbolic name
          <code class="literal">org.springframework.beans</code>)</p></li><li><p>spring-aop.jar (bundle symbolic name
          <code class="literal">org.springframework.aop</code>)</p></li></ul></div><p>In additional the following supporting library bundles are
      required. OSGi-ready versions of these libraries are shipped with the
      Spring Dynamic Modules distribution.</p><div class="itemizedlist"><ul type="disc"><li><p>aopalliance</p></li><li><p>backport-util (when running on JDK 1.4)</p></li><li><p>cglib-nodep (when proxying classes rather then
          interfaces, needed in most cases)</p></li><li><p>commons-logging API (<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.slf4j.org/" target="_top">SLF4J</a> version <span class="emphasis"><em>highly</em></span> recommended:</p><div class="itemizedlist"><ul type="circle"><li><p>SLF4J API (com.springsource.sfl4j.api.jar)</p></li><li><p>SLF4J Implementation Bridge (such as Log4j - com.springsource.sfl4j.log4j.jar)</p></li><li><p>SLF4J commons logging adapter (com.springsource.sfl4j.org.apache.commons.logging.jar)</p></li></ul></div><p>)</p></li><li><p>logging implementation suitable for commons-logging (such as log4j)</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:spring-namespaces"></a>6.4.&nbsp;Spring XML Authoring Support</h2></div></div></div><p>Spring 2.0 introduced (among other things) <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/xsd-config.html" target="_top">
    	easier</a> XML configuration and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/extensible-xml.html" target="_top">
    	extensible</a> XML authoring. The latter gives the ability of creating custom schemas that are discovered automatically (in non-OSGi environment)
    	by the Spring XML infrastructure by including them in the classpath. Spring DM is aware of this process and supports it in OSGi environments so
    	that custom schemas are available to bundles that use them without any extra code or manifest declaration.</p><p>All bundles deployed in the OSGi space (whether they are <code class="literal">Spring-powered</code> or not) are scanned by Spring DM for 
    	custom Spring namespace declaration (by checking the bundle space for<code class="literal">META-INF/spring.handlers</code> and 
    	<code class="literal">META-INF/spring.schemas</code>). If these are found, Spring DM will make the schemas and the namespaces available through an OSGi
    	service that will be automatically used by Spring-powered bundles. This mean that if you deploy a bundle that uses a custom schema, all you have to do
    	is deploy the library that provides the namespace parser and the schema.
    	Bundles that embedded inside their classpath libraries that provide custom schemas will use these over those available in the OSGi space. However,
    	the namespaces of the embedded libraries will not shared with other bundles, that is, they will not be seen by any other bundle.</p><p>
    	In short, with using Spring DM, custom Spring namespaces are supported transparently without any additional work. Embedded namespace providers will
    	have priority but will not be shared, as opposed to providers deployed as bundles which will be seen (and used) by others.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:imports-exports"></a>6.5.&nbsp;Importing and Exporting Packages</h2></div></div></div><p>Refer to the OSGi Service Platform for details of the
      <code class="literal">Import-Package</code> and <code class="literal">Export-Package</code>
      manifest headers. Your bundle will need an
      <code class="literal">Import-Package</code> entry for every external package that
      the bundle depends on. If your bundle provides types that other bundles
      need access to, you will need <code class="literal">Export-Package</code> entries
      for every package that should be available from outside of the
      bundle.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:ext-libs"></a>6.6.&nbsp;Considerations When Using External Libraries</h2></div></div></div><div class="sidebar"><p class="title"><b>What is the context class loader?</b></p><p>
      	The thread context class loader was introduced in J2SE without much fanfare.
      	Below is a short definition for it, quoted from <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/jndi/tutorial/beyond/misc/classloader.html" target="_top">one
      	</a> of the tutorials available on <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/" target="_top">Java</a> site:
      	</p><p>
      	The Java 2 platform also introduced the notion of <span class="emphasis"><em>context class loader</em></span>. A thread's context class loader is, by default, 
      	set to the context class loader of the thread's parent. The hierarchy of threads is rooted at the primordial thread (the one that runs the program). 
      	The context class loader of the primordial thread is set to the class loader that loaded the application. So unless you explicitly change 
      	the thread's context class loader, its context class loader will be the application's class loader. That is, the context class loader can 
      	load the classes that the application can load. This loader is used by the Java runtime such as the RMI (Java Remote Method Invocation) to 
      	load classes and resources on behalf of the user application. The context class loader, like any Java 2 platform class loader, has a parent 
      	class loader and supports the same delegation model for class loading described previously.
      	</p></div><p>Many enterprise application libraries assume that all of the types
      and resources that comprise the application are accessible through the
      context class loader. While most developers do not use the context class 
      loader, the loader is used heavily by application servers, containers or 
      applications that are multi-threaded.</p><p>		      
      In OSGi R4, the set of types and resources
      available through the context class loader is undefined. 
      This means that the OSGi platform does not make a guarantee of the thread context 
      class loader value or in other words, it does not manage it.
      </p><p>
      Thus code (for example libraries) that performs manual class loading or that generates 
      new classes dynamically can cause problems when executed inside an OSGi environment.
      </p><p>Spring Dynamic Modules guarantees that during the creation of an
      application context on behalf of a given bundle, all of the types and
      resources on the bundle's classpath are accessible via the context class
      loader. Spring Dynamic Modules also allows you to control what is
      accessible through the context class loader when invoking external
      services and when servicing requests on exported services. See <a href="#service-registry" title="Chapter&nbsp;7.&nbsp;The Service Registry">Chapter&nbsp;7, <i xmlns:xlink="http://www.w3.org/1999/xlink">The Service Registry</i></a>
      for details on this.</p><p>Work is underway in the OSGi R5 timeframe to provide standardized
      support for dealing with generated classes and implicit class path
      dependencies introduced by third-party libraries. In the interim you may
      need to rely on workarounds such as the
      <code class="literal">DynamicImport-Package</code> manifest header, or the
      facilities provided by specific OSGi implementations such as Equinox's
      buddy mechanism. The Spring Dynamic Modules documentation contains more
      details on known issues with common enterprise libraries and the
      workarounds.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="app-deploy:troubleshooting"></a>6.7.&nbsp;Diagnosing Problems</h2></div></div></div><p>Your chosen OSGi platform implementation should be able to provide
      you with a good deal of information about the current status of the OSGi
      environment. For example, starting Equinox with the
      <code class="literal">-console</code> argument provides a command-line console
      through which you can determine which bundles are installed and their
      states, the packages and services exported by bundles, find out why a
      bundle has failed to resolve, and drive bundles through the
      lifecycle.</p><p>In addition, Spring itself and the Spring Dynamic Modules bundles
      contain extensive logging instrumentation that can help you diagnose
      problems. The recommended approach is to deploy the Simple Logging
      Facade for Java (<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.slf4j.org/" target="_top">slf4j</a>)
      slf4j-api.jar and slf4j-log4j13.jar bundles (the jar files distributed
      by the project are valid OSGi bundles). Then you simply need to create a
      <code class="literal">log4j.properties</code> file in the root of your bundle
      classpath.</p><p>Note that Spring Dynamic Modules uses commons-logging API internally
      which means that its logging implementation is fully pluggable. Please see
      the FAQ and Resources pages for more information on other logging libraries
      besides log4j.
      </p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="service-registry"></a>Chapter&nbsp;7.&nbsp;The Service Registry</h2></div></div></div><p>The OSGi service registry enables a bundle to publish objects to a
    shared registry, advertised via a given set of Java interfaces. Published
    services also have service properties associated with them in the
    registry.</p><p>Spring Dynamic Modules provides an <code class="literal">osgi</code> namespace for Spring (see
    <a href="#appendix-schema" title="Appendix&nbsp;H.&nbsp;Spring Dynamic Modules Schema">Appendix&nbsp;H, <i xmlns:xlink="http://www.w3.org/1999/xlink">Spring Dynamic Modules Schema</i></a>) that can be used to export 
    Spring beans as OSGi services, and
    to define references to services obtained via the service registry. The
    namespace elements may be used nested inside another top-level namespace
    (typically the Spring <code class="literal">beans</code> namespace), or within the top-level
    <code class="literal">osgi</code> element.</p><p>The following example shows the use of the <code class="literal">osgi</code>
    namespace within the familiar Spring beans element:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>                               <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:osgi</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>                               <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans   
       http://www.springframework.org/schema/beans/spring-beans.xsd</span>                      <span class="co"><img src="images/callouts/3.png" alt="(3)"></span><span class="hl-value">
       http://www.springframework.org/schema/osgi  
       http://www.springframework.org/schema/osgi/spring-osgi.xsd"</span>&gt;

    &lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleServiceOsgi"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"simpleService"</span>                             <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
      <span class="hl-attribute">interface</span>=<span class="hl-value">"org.xyz.MyService"</span> /&gt;
&lt;<span class="hl-tag">/beans</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Use Spring Framework <code class="literal">beans</code> schema as the default namespace.
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Import Spring Dynamic Modules schema and associate a prefix with its namespace (<code class="literal">osgi</code> in this example).
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Make sure to import Spring beans schema version <span class="emphasis"><em>2.5</em></span>.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Use Spring Dynamic Modules elements using the declared namespace prefix (in this example <code class="literal">osgi</code>).</p></td></tr></table></div></div><p>Using the OSGi namespace as a top-level namespace, the same service
    would be declared as follows:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans:beans</span>                                                                             <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
   <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>                                    <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>                             <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi  
       http://www.springframework.org/schema/osgi/spring-osgi.xsd
       http://www.springframework.org/schema/beans   
       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;                    <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>

    &lt;<span class="hl-tag">service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleServiceOsgi"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"simpleService"</span>                                  <span class="co"><img src="images/callouts/5.png" alt="(5)"></span>
       <span class="hl-attribute">interface</span>=<span class="hl-value">"org.xyz.MyService"</span> /&gt;

&lt;<span class="hl-tag">/beans:beans</span>&gt;                                                                           <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p><code class="literal">beans</code> root element has to be prefixed with Spring Framework beans schema prefix (<code class="literal">beans</code> in this example).
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Use Spring Dynamic Modules schema as the default namespace.
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Import Spring Framework <code class="literal">beans</code> schema and associate a prefix with its namespace (<code class="literal">beans</code> in this example).
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Make sure to import Spring beans schema version <span class="emphasis"><em>2.5</em></span>.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/5.png" alt="5" border="0"></td><td valign="top" align="left"><p>Use Spring Dynamic Modules elements without any prefix.</p></td></tr></table></div></div><p>Using the OSGi namespace as a top-level namespace is particularly
    convenient when following the recommendation of <a href="#app-deploy:headers" title="6.1.&nbsp;Bundle Format And Manifest Headers">Section&nbsp;6.1, &#8220;Bundle Format And Manifest Headers&#8221;</a> to use a
    dedicated configuration file for all OSGi-related declarations.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-registry:export"></a>7.1.&nbsp;Exporting A Spring Bean As An OSGi Service</h2></div></div></div><p>The <code class="literal">service</code> element is used to define a bean
      representing an exported OSGi service. At a minimum you must specify the
      bean to be exported, and the <span class="emphasis"><em>service interface</em></span> that
      the service advertises.</p><p>For example, the declaration</p><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToPublish"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>/&gt;</pre><p>exports the bean with name <code class="literal">beanToPublish</code> with
      interface <code class="literal">com.xyz.MessageService</code>. The published
      service will have a service property with the name
      <code class="literal">org.springframework.osgi.bean.name</code> set to the name of
      the target bean being registered (<code class="literal">beanToPublish</code> in
      this case).</p><p>The bean <span class="emphasis"><em>defined</em></span> by the
      <code class="literal">service</code> element is of type
      <code class="interfacename">org.osgi.framework.ServiceRegistration</code> and is the
      <code class="interfacename">ServiceRegistration</code> object resulting from registering
      the exported bean with the OSGi service registry. By giving this bean an
      id you can inject a reference to the
      <code class="interfacename">ServiceRegistration</code> object into other beans if
      needed. For example:</p><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myServiceRegistration"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToPublish"</span>
    <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>/&gt;</pre><p>As an alternative to exporting a named bean, the bean to be
      exported to the service registry may be defined as an anonymous inner
      bean of the service element. Typically the top-level namespace would be
      the <code class="literal">beans</code> namespace when using this style:</p><pre class="programlisting">&lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>&gt;
  &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SomeClass"</span>&gt;
     ...
  &lt;<span class="hl-tag">/bean</span>&gt;
&lt;<span class="hl-tag">/osgi:service</span>&gt;</pre><p>If the bean to be exported implements the
      <code class="interfacename">org.osgi.framework.ServiceFactory</code> interface then the
      <code class="interfacename">ServiceFactory</code> contract is honored as per section 5.6
      of the OSGi Service Platform Core Specification. As an alternative to
      implementing this OSGi API, Spring Dynamic Modules introduces a new bean
      scope, the <code class="literal">bundle</code> scope. When a bean with bundle
      scope is exported as an OSGi service then one instance of the bean will
      be created for each unique client (service importer) bundle that
      obtains a reference to it through the OSGi service registry. When a
      service importing bundle is stopped, the bean instance associated with
      it is disposed. To declare a bean with <code class="literal">bundle</code> scope
      simply use the <code class="literal">scope</code> attribute of the
      <code class="literal">bean</code> element:</p><pre class="programlisting">&lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>/&gt;

&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"bundle"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.MessageServiceImpl"</span>/&gt;</pre><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:intfs"></a>7.1.1.&nbsp;Controlling The Set Of Advertised Service Interfaces For
        An Exported Service</h3></div></div></div><p>The OSGi Service Platform Core Specification defines the term
        <span class="emphasis"><em>service interface</em></span> to represent the specification
        of a service's public methods. Typically this will be a Java
        interface, but the specification also supports registering service
        objects under a class name, so the phrase <span class="emphasis"><em>service
        interface</em></span> can be interpreted as referring to either an
        interface or a class.</p><p>There are several options for specifying the service
        interface(s) under which the exported service is registered. The
        simplest mechanism, shown above, is to use the
        <code class="literal">interface</code> attribute to specify a fully-qualified
        interface name. To register a service under multiple interfaces the
        nested <code class="literal">interfaces</code> element can be used in place of
        the <code class="literal">interface</code> attribute.</p><pre class="programlisting">&lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span>&gt;
  &lt;<span class="hl-tag">osgi:interfaces</span>&gt;
     &lt;<span class="hl-tag">value</span>&gt;com.xyz.MessageService&lt;<span class="hl-tag">/value</span>&gt;
     &lt;<span class="hl-tag">value</span>&gt;com.xyz.MarkerInterface&lt;<span class="hl-tag">/value</span>&gt;
  &lt;<span class="hl-tag">/osgi:interfaces</span>&gt;
&lt;<span class="hl-tag">/osgi:service</span>&gt;</pre><p>It is illegal to use both <code class="literal">interface</code> attribute and
		<code class="literal">interfaces</code> element at the same time - use only one of them.
		</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:export:auto-export"></a>7.1.1.1.&nbsp;Detecting The Advertised Interfaces At Runtime</h4></div></div></div><div class="sidebar"><p class="title"><b>Hierarchy visibility</b></p><p>Note that when using <code class="literal">auto-export</code>, only types visible to the
        	bundle exporting the service are registered. For example, a
        	super-interface <code class="literal">SI</code> would not be exported as a
        	supported service interface even when using
        	<code class="literal">auto-export="interfaces"</code> if <code class="literal">SI</code>
        	was not on the exporting bundle's classpath.</p><p>Even if exported service class does implement <code class="literal">SI</code> transitively based
        	on its parent, if the declaring bundle doesn't import the 
        	interface, the class is unknown to the exported service. While this 
        	might seem counter intuitive, it is actually one of the most powerful features of OSGi
        	which give the bundle authors control over the class visibility and path.
        	</p><p>Please see the FAQ for a more detailed explanation.</p></div><p>Using the <code class="literal">auto-export</code> attribute you can avoid
        the need to explicitly declare the service interfaces at all by analyzing the
        object class hierarchy and its interfaces.</p><p> 
        The <code class="literal">auto-export</code> attribute can have one of four
        values:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="literal">disabled</code> : the default value; no auto-detected of service
            interfaces is undertaken and the <code class="literal">interface</code>
            attribute or <code class="literal">interfaces</code> element must be used
            instead.</p></li><li><p><code class="literal">interfaces</code> : the service will be registered using all of the
            Java interface types implemented by the bean to be exported</p></li><li><p><code class="literal">class-hierarchy</code> : the service will be registered using the
            exported bean's implementation type and super-types</p></li><li><p><code class="literal">all-classes</code> : the service will be registered using the exported
            bean's implementation type and super-types plus all interfaces
            implemented by the bean.</p></li></ul></div><p>
		<code class="literal">auto-export</code> and <code class="literal">interface(s)</code> option are not exclusive; both
		can be used at the same time for fine grained control over the advertised interfaces if there is such
		a need. However, the former	option should be enough for most cases. 
		</p><p>For example, to automatically register a bean under all of the
        interfaces that it supports you would declare:</p><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">auto-export</span>=<span class="hl-value">"interfaces"</span>/&gt;</pre><p>Given the interface hierarchy:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SuperInterface {}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SubInterface <span class="hl-keyword">extends</span> SuperInterface {}</pre><p>then a service registered as supporting the
        <code class="literal">SubInterface</code> interface is <span class="emphasis"><em>not</em></span>
        considered a match in OSGi when a lookup is done for services
        supporting the <code class="literal">SuperInterface</code> interface. For this
        reason it is a best practice to export all interfaces supported by the
        service being registered explicitly, using either the
        <code class="literal">interfaces</code> element or
        <code class="literal">auto-export="interfaces"</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:props"></a>7.1.2.&nbsp;Controlling The Set Of Advertised Properties For An
        Exported Service</h3></div></div></div><p>As previously described, an exported service is always
        registered with the service property
        <code class="literal">org.springframework.osgi.bean.name</code> set to the name
        of the bean being exported. Additional service properties can be
        specified using the nested <code class="literal">service-properties</code>
        element. The <code class="literal">service-properties</code> element contains
        key-value pairs to be included in the advertised properties of the
        service. The key must be a string value, and the value must be a type
        recognized by OSGi Filters. See section 5.5 of the OSGi Service
        Platform Core Specification for details of how property values are
        matched against filter expressions.</p><p>The <code class="literal">service-properties</code> element must contain
        at least one nested <code class="literal">entry</code> element from the Spring
        beans namespace. For example:</p><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MyServiceInterface"</span>&gt;
  &lt;<span class="hl-tag">service-properties</span>&gt;
    &lt;<span class="hl-tag">beans:entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myOtherKey"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"aStringValue"</span>/&gt;
    &lt;<span class="hl-tag">beans:entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"aThirdKey"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"beanToExposeAsProperty"</span>/&gt;
  &lt;<span class="hl-tag">/service-properties</span>&gt;
&lt;<span class="hl-tag">/service</span>&gt;</pre><p>The Spring Dynamic Modules roadmap includes support for
        exporting properties registered in the OSGi Configuration
        Administration service as properties of the registered service. See
        <a href="#appendix-roadmap" title="Appendix&nbsp;F.&nbsp;Roadmap">Appendix&nbsp;F, <i xmlns:xlink="http://www.w3.org/1999/xlink">Roadmap</i></a> for more details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:depends-on"></a>7.1.3.&nbsp;The depends-on Attribute</h3></div></div></div><p>Spring will manage explicit dependencies of a service element,
        ensuring for example that the bean to be exported as a service is
        fully constructed and configured before exporting it. If a service has
        implicit dependencies on other components (including other service
        elements) that must be fully initialized before the service can be
        exported, then the optional <code class="literal">depends-on</code> attribute
        can be used to express these dependencies.</p><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MyServiceInterface"</span>
     <span class="hl-attribute">depends-on</span>=<span class="hl-value">"myOtherComponent"</span>/&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:ccl"></a>7.1.4.&nbsp;The context-class-loader Attribute</h3></div></div></div><p>The OSGi Service Platform Core Specification (most current
        version is 4.1 at time of writing) does not specify what types and
        resources are visible through the context class loader when an
        operation is invoked on a service obtained via the service registry.
        Since some services may use libraries that make certain assumptions
        about the context class loader, Spring Dynamic Modules enables you to
        explicitly control the context class loader during service execution.
        This is achieved using the option
        <code class="literal">context-class-loader</code> attribute of the service
        element.</p><p>The permissible values for the
        <code class="literal">context-class-loader</code> attribute are
        <code class="literal">unmanaged</code> (the default) and
        <code class="literal">service-provider</code>. When the
        <code class="literal">service-provider</code> value is specified, Spring Dynamic
        Modules ensures that the context class loader can see all of the
        resources on the class path of the bundle exporting the service.</p><p class="remark"><i><span class="remark">When setting <code class="literal">context-class-loader</code> to <code class="literal">service-provider</code>, the service object will be proxied to
        handle the class loader. If the service advertises any concrete class then CGLIB library is required .</span></i></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:ranking"></a>7.1.5.&nbsp;The ranking Attribute</h3></div></div></div><p>When registering a service with the service registry, you may
        optionally specify a service ranking (see section 5.2.5 of the OSGi
        Service Platform Core Specification). When a bundle looks up a service
        in the service registry, given two or more matching services the one
        with the highest ranking will be returned. The default ranking value
        is zero. To explicitly specify a ranking value for the registered
        service, use the optional <code class="literal">ranking</code> attribute.</p><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MyServiceInterface"</span>
  <span class="hl-attribute">ranking</span>=<span class="hl-value">"9"</span>/&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:service:attributes"></a>7.1.6.&nbsp;<code class="literal">service</code> Element Attributes</h3></div></div></div><p>
       As a summary, the following table lists the attributes names, possible values and
       a short description for each of them.
       </p><div class="table"><a name="service-export-options"></a><p class="title"><b>Table&nbsp;7.1.&nbsp;OSGi &lt;service&gt; attributes</b></p><div class="table-contents"><table summary="OSGi <service&gt; attributes" width="100%" border="1"><colgroup><col><col><col><col><col><col align="justify"></colgroup><thead><tr><th align="center">Name</th><th colspan="4" align="center">Values</th><th align="justify">Description</th></tr></thead><tbody><tr><td align="center">interface</td><td colspan="4" align="center">fully qualified class name (such as <code class="classname">java.lang.Thread</code>)</td><td align="justify">the fully qualified name of the class under which the object will be exported</td></tr><tr><td align="center">ref</td><td colspan="4" align="center">any bean name</td><td align="justify">Reference to the named bean to be exported as a service in the service registry.</td></tr><tr><td align="center">context-class-loader</td><td colspan="2" align="center">unmanaged</td><td colspan="2" align="center">service-provider</td><td align="justify">Defines how the context class loader will be managed when an operation is invoked on the 
                exported service. The default value is <code class="literal">unmanaged</code> which means that no management of 
                the context class loader is attempted. A value of <code class="literal">service-provider</code> guarantees that
                the context class loader will have visibility of all the resources on the class path of 
                bundle exporting the service.</td></tr><tr><td align="center">auto-export</td><td align="center">disabled</td><td align="center">interfaces</td><td align="center">class-hierarchy</td><td align="center">all-classes</td><td align="justify">Enables Spring to automatically manage the set of service interfaces advertised for the
				service. By default this facility is <code class="literal">disabled</code>. A value of <code class="literal">interfaces</code> advertises all 
                of the Java interfaces supported by the exported service. A value of <code class="literal">class-hierarchy</code> 
                advertises all the Java classes in the hierarchy of the exported service. A value of 
                <code class="literal">all-classes</code> advertises all Java interfaces and classes.</td></tr><tr><td align="center">ranking</td><td colspan="4" align="center">any integer value</td><td align="justify">Specify the service ranking to be used when advertising the service. Default value is 0.</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:export:lifecycle"></a>7.1.7.&nbsp;Service Registration And Unregistration Lifecycle</h3></div></div></div><p>The service defined by a <code class="literal">service</code> element is
        registered with the OSGi service registry when the application context
        is first created. It will be unregistered automatically when the
        bundle is stopped and the application context is disposed.</p><p>If you need to take some action when a service is unregistered
        because its dependencies are not satisfied (or when it is registered),
        then you can define a listener bean using the nested
        <code class="literal">registration-listener</code> element.</p><p>The declaration of a registration listener must use either the
        <code class="literal">ref</code> attribute to refer to a top-level bean
        definition, or declare an anonymous listener bean inline. For
        example:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">service</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanToBeExported"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"SomeInterface"</span>&gt;
  &lt;<span class="hl-tag">registration-listener</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myListener"</span>                                                <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
    <span class="hl-attribute">registration-method</span>=<span class="hl-value">"serviceRegistered"</span>                                              <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
    <span class="hl-attribute">unregistration-method</span>=<span class="hl-value">"serviceUnregistered"</span>/&gt;                                        <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
  &lt;<span class="hl-tag">registration-listener</span>
     <span class="hl-attribute">registration-method</span>=<span class="hl-value">"register"</span>&gt;                                                     <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
     &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SomeListenerClass"</span>/&gt;                                                   <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
  &lt;<span class="hl-tag">/registration-listener</span>&gt;
&lt;<span class="hl-tag">/service</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Listener declaration referring to a top-level bean declaration.
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Indicate the <code class="literal">registration</code> and <code class="literal">unregistration</code> methods.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Declare only a <code class="literal">registration</code> custom method for this listener.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Nested listener bean declaration.</p></td></tr></table></div></div><p>The optional <code class="literal">registration-method</code> and
        <code class="literal">unregistration-method</code> attributes specify the names
        of the methods defined on the listener bean that are to be invoked
        during registration and unregistration. A registration and unregistration 
        callback methods must have a signature matching one of the following formats:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(ServiceType serviceInstance, Map serviceProperties);</pre><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(ServiceType serviceInstance, Dictionary serviceProperties);</pre><p>where <code class="literal">ServiceType</code> can be any type compatible
        with the exported service interface of the service.</p><p>The register callback is invoked when the service is initially
        registered at startup, and whenever it is subsequently re-registered.
        The unregister callback is invoked during the service unregistration process, 
        no matter the cause (such as the owning bundle stopping).</p><p>Spring DM will use the declared <code class="literal">ServiceType</code> argument type
        and invoke the registration/unregistration method only when a service of a compatible type
        will be registered/unregistered.</p><p><code class="literal">serviceProperties</code> represents a map holding all the properties
        of the registered/unregistered service. To preserve compatibility with the OSGi specification
        this argument can be cast, if needed, to a <code class="literal">java.util.Dictionary</code>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:export:lifecycle:interface"></a>7.1.7.1.&nbsp;Using <code class="interfacename">OsgiServiceRegistrationListener</code> Interface</h4></div></div></div><p>
        While we discourage, it is possible to implement a Spring DM specific interface, namely 
        <code class="interfacename">org.springframework.osgi.service.exporter.OsgiServiceRegistrationListener</code> which avoids the need
        to declare the <code class="literal">registration-method</code> and <code class="literal">unregistration-method</code>.
        However, by implementing <code class="interfacename">OsgiServiceRegistrationListener</code>, your code
        becomes Spring DM aware (which goes against the POJO philosophy).
        </p><p>It is possible for a listener to implement <code class="interfacename">OsgiServiceRegistrationListener</code> interface and
        declare custom methods. In this case, the Spring DM interface methods will be called first, followed by the custom methods.
        </p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-registry:refs"></a>7.2.&nbsp;Defining References To OSGi Services</h2></div></div></div><p>Spring Dynamic Modules supports the declaration of beans that
      represent services accessed via the OSGi Service Registry. In this
      manner references to OSGi services can be injected into application
      components. The service lookup is made using the service interface type
      that the service is required to support, plus an optional filter
      expression that matches against the service properties published in the
      registry.</p><p>For some scenarios, a single matching service that meets the
      application requirements is all that is needed. The
      <code class="literal">reference</code> element defines a reference to a single
      service that meets the required specification. In other scenarios,
      especially when using the OSGi <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/documents/osgi_technology/whiteboard.pdf" target="_top">whiteboard
      pattern</a>, references to <span class="emphasis"><em>all available</em></span>
      matching services are required. Spring Dynamic Modules supports the
      management of this set of references as a <code class="interfacename">List</code>,
      <code class="interfacename">Set</code> collection.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:refs:singular"></a>7.2.1.&nbsp;Referencing An Individual Service</h3></div></div></div><p>The <code class="literal">reference</code> element is used to define a
        reference to a service in the service registry.</p><p>Since there can be multiple service matching a given description,
        the service returned is the service that would be returned by a call to
        <code class="literal">BundleContext.getServiceReference</code>. This means that
        the service with the highest ranking will be returned, or if there is
        a tie in ranking, the service with the lowest service id (the service
        registered first with the framework) is returned (please see Section 5
        from the OSGi spec for more information on the service selection algorithm).</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:interface"></a>7.2.1.1.&nbsp;Controlling The Set Of Advertised Interfaces For The Imported Service</h4></div></div></div><p>The <code class="literal">interface</code> attribute identifies the service
	        interface that a matching service must implement. For example, the
	        following declaration creates a bean
	        <code class="literal">messageService</code>, which is backed by the service
	        returned from the service registry when querying it for a service
	        offering the <code class="interfacename">MessageService</code> interface.</p><pre class="programlisting">&lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>/&gt;</pre><p>Just like the <code class="literal">service</code> declaration, when specifying
	        multiple interfaces, use the nested <code class="literal">interfaces</code> element instead
	        of <code class="literal">interface</code> attribute:
	        </p><pre class="programlisting">&lt;<span class="hl-tag">osgi:reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"importedOsgiService"</span>&gt;
  &lt;<span class="hl-tag">osgi:interfaces</span>&gt;
     &lt;<span class="hl-tag">value</span>&gt;com.xyz.MessageService&lt;<span class="hl-tag">/value</span>&gt;
     &lt;<span class="hl-tag">value</span>&gt;com.xyz.MarkerInterface&lt;<span class="hl-tag">/value</span>&gt;
  &lt;<span class="hl-tag">/osgi:interfaces</span>&gt;
&lt;<span class="hl-tag">/osgi:reference</span>&gt;</pre><p>It is illegal to use both <code class="literal">interface</code> attribute and
			<code class="literal">interfaces</code> element at the same time - use only one of them.
			</p><p>The bean defined by reference element implements all of the
	        advertised interfaces of the service that are visible to the bundle (called
	        <span class="emphasis"><em>greedy proxying</em></span>).
	        If the registered service interfaces include Java class types (as
	        opposed to interface types) then support for these types is subject to
	        the restrictions of Spring's AOP implementation (see the Spring
	        Reference Guide). In short, if the specified interfaces are classes
	        (rather then interfaces), then <code class="literal">cglib</code> library must be
	        available, and <code class="literal">final</code> methods are not
	        supported.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:filter"></a>7.2.1.2.&nbsp;The <code class="literal">filter</code> Attribute</h4></div></div></div><p>The optional <code class="literal">filter</code> attribute can be used
          to specify an OSGi filter expression and constrains the service
          registry lookup to only those services that match the given
          filter.</p><p>For example:</p><pre class="programlisting">&lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"asyncMessageService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>
  <span class="hl-attribute">filter</span>=<span class="hl-value">"(asynchronous-delivery=true)"</span>/&gt;</pre><p>will match only OSGi services that advertise <code class="interfacename">MessageService</code>
  		  interface and have the property named <code class="literal">asynchronous-delivery</code> set to value <code class="literal">true</code>.
  		  </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:bean-name"></a>7.2.1.3.&nbsp;The <code class="literal">bean-name</code> Attribute</h4></div></div></div><p>The <code class="literal">bean-name</code> attribute is a convenient
          short-cut for specifying a filter expression that matches on the
          <code class="literal">bean-name</code> property automatically set when exporting a bean using the
          <code class="literal">service</code> element (see <a href="#service-registry:export" title="7.1.&nbsp;Exporting A Spring Bean As An OSGi Service">Section&nbsp;7.1, &#8220;Exporting A Spring Bean As An OSGi Service&#8221;</a>).</p><p>Consider the following exporter/importer declarations:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="co"><img src="images/callouts/1.png" alt="(1)"></span><span class="hl-value">messageServiceBean"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"bundle"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.MessageServiceImpl"</span>/&gt;
&lt;<span class="hl-comment">!-- service exporter --</span>&gt;
&lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageServiceExporter"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"</span><span class="co"><img src="images/callouts/1.png" alt="(1)"></span><span class="hl-value">messageServiceBean"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>/&gt;
</pre></div><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">osgi:reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>
   <span class="hl-attribute">bean-name</span>=<span class="hl-value">"</span><span class="co"><img src="images/callouts/1.png" alt="(1)"></span><span class="hl-value">messageServiceBean"</span>/&gt;
</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>the name used with <code class="literal">bean-name</code> attribute</p></td></tr></table></div><p>will match only OSGi services that advertise <code class="interfacename">MessageService</code>
   		  interface and have the property named <code class="literal">org.springframework.osgi.bean.name</code> set
   		  to value <code class="literal">messageServiceBean</code>. In short, this means finding all Spring DM exported
   		  beans that implement interface <code class="interfacename">MessageService</code> and are named
   		  <code class="literal">messageServiceBean</code>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:cardinality"></a>7.2.1.4.&nbsp;The <code class="literal">cardinality</code> Attribute</h4></div></div></div><div class="sidebar"><p class="title"><b>Nested &lt;reference&gt; declarations</b></p><p>In order for Spring DM to detect mandatory dependencies, any
		    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html#beans-inner-beans" target="_top">nested/inner</a>
		    reference declaration will be transformed into top-level
		    one with a generated name.</p></div><p>The <code class="literal">cardinality</code> attribute is used to
          specify whether or not a matching service is required at all times.
          A cardinality value of <code class="literal">1..1</code> (the default)
          indicates that a matching service must always be available. A
          cardinality value of <code class="literal">0..1</code> indicates that a
          matching service is not required at all times (see 
          <a href="#service-registry:refs:singular:dynamics" title="7.2.1.8.&nbsp;reference And OSGi Service Dynamics">Section&nbsp;7.2.1.8, &#8220;<code class="literal">reference</code> And OSGi Service Dynamics&#8221;</a>
          for more details). A <code class="literal">reference</code> with cardinality
          <code class="literal">1..1</code> is also known as a
          <span class="emphasis"><em>mandatory</em></span> service reference and, by default,
          application context creation is deferred until the reference is
          satisfied. More information about context creation and mandatory
          dependencies is available at <a href="#service-registry:refs:singular:dynamics" title="7.2.1.8.&nbsp;reference And OSGi Service Dynamics">Section&nbsp;7.2.1.8, &#8220;<code class="literal">reference</code> And OSGi Service Dynamics&#8221;</a>
          </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">It is an error to declare a mandatory reference to a
          service that is also exported by the same bundle, this behavior can
          cause application context creation to fail through either deadlock
          or timeout.</td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:depends-on"></a>7.2.1.5.&nbsp;The depends-on Attribute</h4></div></div></div><p>The <code class="literal">depends-on</code> attribute is used to specify
          that the service reference should not be looked up in the service
          registry until the named dependent bean has been
          instantiated.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:tccl"></a>7.2.1.6.&nbsp;The context-class-loader Attribute</h4></div></div></div><p>The OSGi Service Platform Core Specification (latest
          version is 4.1 at time of writing) does not specify what types and
          resources are visible through the context class loader when an
          operation is invoked on a service obtained via the service registry.
          Since some services may use libraries that make certain assumptions
          about the context class loader, Spring Dynamic Modules enables you
          to explicitly control the context class loader during service
          invocation. This is achieved using the option
          <code class="literal">context-class-loader</code> attribute of the
          <code class="literal">reference</code> element.</p><div class="sidebar"><p class="title"><b>context class loader management on the importer and exporter</b></p><p>
		      Spring DM has the ability to do context class loader management on both
		      the importer and exporter side. Normally, if Spring DM works on both sides,
		      only one side should have this feature enabled. However, if both sides 
		      (importer and exporter) take advantage of this capability, the last
		      entity in the call chain will win. This means that the exporter setting,
		      if enabled, will always override the importer setting (whatever that is). 
		    </p></div><p>The permissible values for the
          <code class="literal">context-class-loader</code> attribute are:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="literal">client</code> - during the service invocation,
          	the context	class loader is guaranteed to be
          	able to see types on the classpath of the invoking bundle.
          	This is the default option.</p></li><li><p><code class="literal">service-provider</code> - during the service invocation,
          	the context	class loader is guaranteed to be
          	able to see types on the classpath of the bundle exporting
          	the service.</p></li><li><p><code class="literal">unmanaged</code> - no context class loader
          	management will occur during the service invocation</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:reference:attributes"></a>7.2.1.7.&nbsp;<code class="literal">reference</code> Element Attributes</h4></div></div></div><p>
       	As a summary, the following table lists the <code class="literal">reference</code> element 
       	attributes names, possible values and a short description for each of them.
        </p><div class="table"><a name="reference-import-options"></a><p class="title"><b>Table&nbsp;7.2.&nbsp;OSGi &lt;reference&gt; attributes</b></p><div class="table-contents"><table summary="OSGi <reference&gt; attributes" width="100%" border="1"><colgroup><col><col align="center"><col align="center"><col align="center"><col align="center"></colgroup><thead><tr><th>Name</th><th colspan="4" align="center">Values</th><th align="justify">Description</th></tr></thead><tbody><tr><td>interface</td><td colspan="4" align="center">fully qualified class name (such as <code class="classname">java.lang.Thread</code>)</td><td align="justify">The fully qualified name of the class under which the object will be exported.</td></tr><tr><td>filter</td><td colspan="4" align="center">OSGi filter expression (such as <code class="literal">((asynchronous-delivery=true)</code>)</td><td align="justify">OSGi filter expression that is used to constrain the set of matching services
                in the service registry.</td></tr><tr><td>bean-name</td><td colspan="4" align="center">any string value</td><td align="justify">Convenient shortcut for specifying a filter expression that matches on the bean-name property 
                that is automatically advertised for beans published using the &lt;service&gt; element.</td></tr><tr><td>context-class-loader</td><td align="center">client</td><td colspan="2" align="center">service-provider</td><td align="center">unmanaged</td><td align="justify">Defines how the context class loader is managed when invoking operations on a service
                backing this service reference. The default value is <code class="literal">client</code> which means that the context
                class loader has visibility of the resources on this bundle's classpath. Alternate
                options are <code class="literal">service-provider</code> which means that the context class loader has visibility of 
                resources on the bundle classpath of the bundle that exported the service, and <code class="literal">unmanaged</code>
               	which does not do any management of the context class loader.</td></tr><tr><td>cardinality</td><td colspan="2" align="center">0..1</td><td colspan="2" align="center">1..1</td><td align="justify">Defines the required cardinality of the relationship to the backing service. If not specified, 
                the <code class="literal">default-cardinality</code> attribute will apply. A value is '1..1' means that a backing service 
                must exist (this is a mandatory service reference). A value of '0..1' indicates that it is 
                acceptable to be no backing service (an optional service reference).</td></tr><tr><td>timeout</td><td colspan="4" align="center">any positive long</td><td align="justify">The amount of time (in milliseconds) to wait for a backing service to be 
				available when an operation is invoked. If not specified, the <code class="literal">default-timeout</code> attribute will apply.
                </td></tr></tbody></table></div></div><br class="table-break"></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:dynamics"></a>7.2.1.8.&nbsp;<code class="literal">reference</code> And OSGi Service Dynamics</h4></div></div></div><p>
	      The bean defined by the <code class="literal">reference</code> element
	      is unchanged throughout the lifetime of the application context
	      (the object reference remains constant). However, the OSGi service
	      that backs the reference may come and go at any time. For a
	      mandatory service reference (cardinality <code class="literal">1..1</code>),
	      creation of the application context will block until a matching
	      service is available. For an optional service reference 
	      (cardinality <code class="literal">0..1</code>), the
	      reference bean will be created immediately, regardless of whether or
	      not there is currently a matching service.</p><p>When the service backing a <code class="literal">reference</code> bean
	      goes away, Spring Dynamic Modules tries to replace the backing
	      service with another service matching the reference criteria. An
	      application may be notified of a change in backing service by
	      registering a <code class="literal">listener</code>. If no matching service is
	      available, then the <code class="literal">reference</code> is said to be
	      <span class="emphasis"><em>unsatisfied</em></span>. An unsatisfied mandatory service
	      causes any exported service (<code class="literal">service</code> bean) that
	      depends on it to be unregistered from the service registry until
	      such time as the reference is satisfied again. See
	      <a href="#service-registry:export-import-relationship" title="7.5.&nbsp;Relationship Between The Service Exporter And Service Importer">Section&nbsp;7.5, &#8220;Relationship Between The Service Exporter And Service Importer&#8221;</a> for more information.</p><p>When an operation is invoked on an unsatisfied
	      <code class="literal">reference</code> bean (either optional or mandatory),
	      the invocation blocks until the reference becomes satisfied. The
	      optional <code class="literal">timeout</code> attribute of the
	      <code class="literal">reference</code> element enables a timeout value (in
	      milliseconds) to be specified. If a timeout value is specified and
	      no matching service becomes available within the timeout period, an
	      unchecked <code class="classname">ServiceUnavailableException</code> is
	      thrown.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:singular:property-editor"></a>7.2.1.9.&nbsp;Getting A Hold Of The Managed Service Reference</h4></div></div></div><p>Spring DM can automatically convert a managed OSGi service to 
        service reference. That is, if the property into which a reference bean 
        is to be injected, has type <code class="interfacename">ServiceReference</code> (instead of the service
        interface supported by the reference), then the managed OSGi
        <code class="interfacename">ServiceReference</code> for the service will be injected
        in place of the service itself:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BeanWithServiceReference {
	<span class="hl-keyword">private</span> ServiceReference serviceReference;
	<span class="hl-keyword">private</span> SomeService service;
			
	<span class="hl-comment">// getters/setters ommitted</span>
}</pre><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.SomeService"</span>/&gt;
		
&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"BeanWithServiceReference"</span>&gt;
  &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceReference"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span>/&gt;                                      <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
  &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span>/&gt;                                               <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
&lt;<span class="hl-tag">/bean</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Automatic managed service to <code class="interfacename">ServiceReference</code> conversion.
            </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Managed service is injected without any conversion</p></td></tr></table></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
		The injected <code class="interfacename">ServiceReference</code> is managed by Spring DM and will change
		at the same time as the referenced backing OSGi service instance.
		</td></tr></table></div><p>There are cases when the managed <code class="interfacename">ServiceReference</code> is needed to get a hold of the OSGi service. Unfortunately,
		most of the OSGi frameworks expect their own <code class="interfacename">ServiceReference</code> classes and will fail when the
		Spring DM managed reference is used. For such cases, one can get a hold of the native <code class="interfacename">ServiceReference</code> bound
		at that moment, by casting the reference object to <code class="interfacename">ServiceReferenceProxy</code> and then calling 
		<code class="methodname">getTargetServiceReference</code>. Using the example context above, one might use the following code:</p><pre class="programlisting">ServiceReference nativeReference = ((ServiceReferenceProxy)serviceReference).getTargetServiceReference()</pre><p>The returned <code class="literal">nativeReference</code> can be safely passed to the OSGi framework however, since it is not managed by Spring DM,
		in time, it might refer to a service different then the one backing the imported OSGi service.</p><p>To avoid this desynchronization, consider using managed <code class="interfacename">ServiceReference</code> objects mainly for reading the
		bound OSGi service properties rather then getting a hold of OSGi services (which can be simply injected by Spring DM).</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:refs:collection"></a>7.2.2.&nbsp;Referencing A Collection Of Services</h3></div></div></div><div class="sidebar"><p class="title"><b>Natural vs custom ordering</b></p><p>
		 Java collection API defines two interfaces for ordering objects -
		 <code class="interfacename">Comparable</code> and <span class="interface">Comparator</span>.
		 The first is meant to be implemented by objects for providing <span class="emphasis"><em>natural 
		 ordering</em></span>. <code class="classname">String</code>, <code class="classname">Long</code>
		 or <code class="classname">Date</code> are good examples of objects that implement the
		 <code class="interfacename">Comparable</code> interface.</p><p>
		 However, there are cases where sorting is different then the natural ordering or,
		 the objects meant to be sort do not implement <span class="interface">Comparable</span>. To
		 address this cases, <code class="interfacename">Comparator</code> interface was designed. 
		 </p><p>For more information on this subject, please consult the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/docs/books/tutorial/collections/interfaces/order.html" target="_top">
		 Object ordering</a> chapter from Java 
		 <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/docs/books/tutorial/collections/" target="_top">collection</a> tutorial,
		 </p></div><p>Sometimes an application needs access not simply to any service
        meeting some criteria, but to <span class="emphasis"><em>all</em></span> services
        meeting some criteria. Spring DM allows the matching services may be held in a
        <code class="interfacename">List</code> or <code class="interfacename">Set</code> 
        (optionally sorted).</p><p>The difference between using a <code class="interfacename">List</code> and a
        <code class="interfacename">Set</code> to manage the collection is one of equality.
        Two or more services published in the registry (and with distinct
        service ids) may be "equal" to each other, depending on the
        implementation of equals used by the service implementations. Only one
        such service will be present in a set, whereas all services returned
        from the registry will be present in a list. For more details on collections,
        see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/docs/books/tutorial/collections/interfaces/index.html" target="_top">this</a> 
        tutorial.</p><p>The <code class="literal">set</code> and <code class="literal">list</code> schema elements
        are used to define collections of services with set or list semantics
        respectively.</p><p>These elements support the attributes
        <code class="literal">interface</code>, <code class="literal">filter</code>,
        <code class="literal">bean-name</code>, <code class="literal">cardinality</code>, and
        <code class="literal">context-class-loader</code>, with the same semantics as for
        the <code class="literal">reference</code> element. The allowable values for the
        <code class="literal">cardinality</code> attribute are <code class="literal">0..N</code>
        and <code class="literal">1..N</code>.</p><p>A cardinality value of
        <code class="literal">0..n</code> indicates that it is permissible to
        be no matching services. A cardinality value of
        <code class="literal">1..n</code> indicates that at least one matching service
        is required at all times. Such a reference is considered a
        <span class="emphasis"><em>mandatory</em></span> reference and any exported services
        from the same bundle (<code class="literal">service</code> defined beans) that
        depend on a mandatory reference will automatically be unregistered
        when the reference becomes unsatisfied, and reregistered when the
        reference becomes satisfied again.</p><p>The bean defined by a <code class="literal">list</code> element is of type
        <code class="interfacename">java.util.List</code>. The bean defined by a
        <code class="literal">set</code> element is of type
        <code class="interfacename">java.util.Set</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">Make sure the Spring DM collections are injected into properties of compatible types (
        for example <code class="literal">set</code> into <code class="interfacename">Set</code> or <code class="interfacename">
        Collection</code>) since otherwise the container will automatically perform 
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/validation.html#beans-beans-conversion" target="_top">type conversion</a>,
        transforming the Spring DM managed collection into a 'normal' one, unaware of the OSGi dynamics.
        </td></tr></table></div><p>The following example defines a bean of type <code class="interfacename">List</code> that 
        will contain all registered services supporting the
        <code class="literal">EventListener</code> interface:</p><pre class="programlisting">&lt;<span class="hl-tag">list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEventListeners"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.EventListener"</span>/&gt;</pre><p>The members of the collection defined by the bean are managed
        dynamically by Spring. As matching services are registered and
        unregistered in the service registry, the collection membership will
        be kept up to date. Each member of the collection supports the service
        interfaces that the corresponding service was registered with and that
        are visible to the bundle.</p><p>Spring DM supports sorted collections as well, both for set and list.</p><p>It is possible to specify a sorting order using either the
        <code class="literal">comparator-ref</code> attribute, or the nested
        <code class="literal">comparator</code> element. The
        <code class="literal">comparator-ref</code> attribute is used to refer to a
        named bean implementing <code class="interfacename">java.util.Comparator</code>. The
        <code class="literal">comparator</code> element can be used to define an inline
        bean. For example:</p><pre class="programlisting">&lt;<span class="hl-tag">set</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myServices"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MyService"</span>
  <span class="hl-attribute">comparator-ref</span>=<span class="hl-value">"someComparator"</span>/&gt;

&lt;<span class="hl-tag">list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myOtherServices"</span> 
  <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.OtherService"</span>&gt;
  &lt;<span class="hl-tag">comparator</span>&gt;
     &lt;<span class="hl-tag">beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyOtherServiceComparator"</span>/&gt;
  &lt;<span class="hl-tag">/comparator</span>&gt;
&lt;<span class="hl-tag">/list</span>&gt;</pre><p>To sort using a natural ordering instead of an explicit
        comparator, you can use the <code class="literal">natural</code>
        element inside of <code class="literal">comparator</code>. You need to specify
        the basis for the natural ordering: based on the service references,
        following the <code class="interfacename">ServiceReference</code> natural ordering
        defined in the OSGi Core Specification release 4, version 4.1, section 6.1.23; 
        or based on the services themselves (in which case the services must be
        <code class="interfacename">Comparable</code>).</p><pre class="programlisting">&lt;<span class="hl-tag">list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myServices"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MyService"</span>&gt;
  &lt;<span class="hl-tag">comparator</span>&gt;&lt;<span class="hl-tag">natural</span> <span class="hl-attribute">basis</span>=<span class="hl-value">"services"</span>/&gt;&lt;<span class="hl-tag">/comparator</span>&gt;
&lt;<span class="hl-tag">/list</span>&gt;

&lt;<span class="hl-tag">set</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myOtherServices"</span><span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.OtherService"</span>&gt;
  &lt;<span class="hl-tag">comparator</span>&gt;&lt;<span class="hl-tag">natural</span> <span class="hl-attribute">basis</span>=<span class="hl-value">"service-references"</span>/&gt;&lt;<span class="hl-tag">/comparator</span>&gt;
&lt;<span class="hl-tag">/set</span>&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">For a sorted set, a <code class="interfacename">SortedSet</code> implementation will be created.
		However, since the JDK API does not provide a dedicated <code class="interfacename">SortedList</code>interface, 
		the sorted list will implement only the <code class="interfacename">List</code> interface.</td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:collection:greedy-proxying"></a>7.2.2.1.&nbsp;Greedy Proxying</h4></div></div></div><p>All OSGi services imported by a Spring DM service collection publish and are type-compatible with the classes
			declared by the <code class="literal">interfaces</code> property. However, some services might expose additional (optional) 
			classes that could be relevant to your application.</p><p>For these cases, Spring DM collections offer a dedicated attribute called <code class="literal">greedy-proxying</code> which
			will cause the creates proxies to use <span class="emphasis"><em>all</em></span> the classes advertised by the imported services, visible to the consuming
			importing bundle. Thus, it is possible to cast the imported proxies to classes different then those specified in the
			<code class="literal">interfaces</code>. For example, with the following list definition:
			</p><pre class="programlisting">&lt;<span class="hl-tag">list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"services"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.SomeService"</span> <span class="hl-attribute">greedy-proxying</span>=<span class="hl-value">"true"</span>/&gt;</pre><p>one can do the following iteration (assuming <code class="classname">MessageDispatcher</code> type is imported by the bundle):</p><pre class="programlisting"><span class="hl-keyword">for</span> (Iterator iterator = services.iterator(); iterator.hasNext();) {
	SomeService service = (SomeService) iterator.next();
	service.executeOperation();
	<span class="hl-comment">// if the service implements an additional type</span>
	<span class="hl-comment">// do something extra</span>
	<span class="hl-keyword">if</span> (service <span class="hl-keyword">instanceof</span> MessageDispatcher) {
		((MessageDispatcher)service).sendAckMessage();
	}
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">Before using greedy proxies and <code class="literal">instanceof</code> statements, consider using a different
			interface/class for your services which provides better 
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Polymorphism_in_object-oriented_programming" target="_top">polymorphism</a> 
			and is more 
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Object_oriented" target="_top">object-oriented</a>.</td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:collection:attributes"></a>7.2.2.2.&nbsp;Collection (<code class="literal">list</code> And <code class="literal">set</code>) Element Attributes</h4></div></div></div><p>
		<code class="literal">list</code> and <code class="literal">set</code> elements support all the attributes available to
		<code class="literal">reference</code> element except the <code class="literal">timeout</code> attribute.
		
       	See the following table as a summary of the <code class="literal">list</code> and <code class="literal">set</code> element 
       	attribute names, possible values and a short description for each of them.
        </p><div class="table"><a name="collection-import-options"></a><p class="title"><b>Table&nbsp;7.3.&nbsp;&lt;list&gt;/&lt;set&gt; attributes</b></p><div class="table-contents"><table summary="<list&gt;/<set&gt; attributes" width="100%" border="1"><colgroup><col><col align="center"><col align="center"><col align="center"><col align="center"><col align="justify"></colgroup><thead><tr><th>Name</th><th colspan="4" align="justify">Values</th><th align="justify">Description</th></tr></thead><tbody><tr><td>interface</td><td colspan="4" align="justify">fully qualified class name (such as <code class="classname">java.lang.Thread</code>)</td><td align="justify">The fully qualified name of the class under which the object will be exported.</td></tr><tr><td>filter</td><td colspan="4" align="justify">OSGi filter expression (such as <code class="literal">((asynchronous-delivery=true)</code>)</td><td align="justify">OSGi filter expression that is used to constrain the set of matching services
                in the service registry.</td></tr><tr><td>bean-name</td><td colspan="4" align="justify">any string value</td><td align="justify">Convenient shortcut for specifying a filter expression that matches on the bean-name property 
                that is automatically advertised for beans published using the &lt;service&gt; element.</td></tr><tr><td>context-class-loader</td><td align="center">client</td><td colspan="2" align="center">service-provider</td><td align="center">unmanaged</td><td align="justify">Defines how the context class loader is managed when invoking operations on a service
                backing this service reference. The default value is <code class="literal">client</code> which means that the context
                class loader has visibility of the resources on this bundle's classpath. Alternate
                options are <code class="literal">service-provider</code> which means that the context class loader has visibility of 
                resources on the bundle classpath of the bundle that exported the service, and <code class="literal">unmanaged</code>
               	which does not do any management of the context class loader.</td></tr><tr><td>cardinality</td><td colspan="2" align="center">0..N</td><td colspan="2" align="center">1..N</td><td align="justify">Defines the required cardinality of the relationship to the backing service. If not specified, 
                the <code class="literal">default-cardinality</code> attribute will apply. A value is '1..N' means that a backing service 
                must exist (this is a mandatory service reference). A value of '0..N' indicates that it is 
                acceptable to be no backing service (an optional service reference).</td></tr><tr><td>comparator-ref</td><td colspan="4" align="justify">any string value</td><td align="justify">Named reference to a bean acting as comparator for the declaring collection. Declaring a comparator automatically
                makes the declaring collection sorted.</td></tr><tr><td>greedy-proxying</td><td colspan="2" align="center">true</td><td colspan="2" align="center">false</td><td align="justify">Indicates whether the proxies created for the imported OSGi services will be generated using 
                just the classes specified (<code class="literal">false</code>) or all the classes exported by the service and visible to
                the importing bundle (<code class="literal">true</code>). The default value is <code class="literal">false</code>.</td></tr></tbody></table></div></div><br class="table-break"><p>The table below lists the attributes available for the <code class="literal">comparator/natural</code> sub element.</p><div class="table"><a name="collection-import-comparator-options"></a><p class="title"><b>Table&nbsp;7.4.&nbsp;collection &lt;comparator&gt; attributes</b></p><div class="table-contents"><table summary="collection <comparator&gt; attributes" width="100%" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>Name</th><th colspan="2">Values</th><th>Description</th></tr></thead><tbody><tr><td>basis</td><td>service</td><td>service-reference</td><td>Indicate the element on which <span class="emphasis"><em>natural ordering</em></span> should apply - <code class="literal">service</code> for considering
                the service instance and <code class="literal">service-reference</code> for considering the service reference instead of the service.</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:collection:dynamics"></a>7.2.2.3.&nbsp;<code class="literal">list</code> / <code class="literal">set</code> And OSGi Service Dynamics</h4></div></div></div><p>
          A collection of OSGi services will change its content during the lifetime
          of the application context since it needs to reflect the state of the OSGi
          space. As service are registered and unregistered, they will be added or
          removed from the collection.</p><p>While a <code class="literal">reference</code> declaration will try to
          find a replacement if the backing service is unregistered, the collection
          will simply remove the service from the collection. 
          Like <code class="literal">reference</code>, a collection with cardinality <code class="literal">1..N</code>
          is said to be mandatory while a collection with cardinality <code class="literal">0..N</code>
          is referred to as being optional.
          If no matching service is available then only mandatory collections become 
          <span class="emphasis"><em>unsatisfied</em></span>.
          That is if no service is available invoking an operation on:
          </p><div class="itemizedlist"><ul type="disc"><li>mandatory collection - will throw an unchecked <code class="classname">ServiceUnavailableException</code>.</li><li>optional collection - will <span class="emphasis"><em>not</em></span> throw any exceptions (however the collection will be empty).</li></ul></div><p>Just like <code class="literal">reference</code>, mandatory collections
          will trigger the unregistration of any exported service that depends
          upon it. See
	      <a href="#service-registry:export-import-relationship" title="7.5.&nbsp;Relationship Between The Service Exporter And Service Importer">Section&nbsp;7.5, &#8220;Relationship Between The Service Exporter And Service Importer&#8221;</a> for more information.
          </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="service-registry:refs:collection:iterator"></a>7.2.2.4.&nbsp;<code class="interfacename">Iterator</code> Contract And Service Collections</h4></div></div></div><p>The recommend way of traversing a collection is by using an <code class="interfacename">Iterator</code>.
		  However, since OSGi services can come and go, the content of the managed service collection will be adjusted
		  accordingly. Spring DM will transparently update all <code class="interfacename">Iterator</code>s held by 
		  the user so it is possible to safely traverse the collection while it is being modified. Moreover, the 
		  <code class="interfacename">Iterator</code>s will reflect all the changes made to the collection, even if 
		  they occurred after the <code class="interfacename">Iterator</code>s were created (that is during the iteration).
		  Consider a case where a collection shrinks significantly (for example a big number of OSGi
		  services are shutdown) right after an iteration started.
		  To avoid dealing with the resulting 'dead' service references,
		  Spring DM iterators do not take collection snapshots (that can be inaccurate) 
		  but rather are updated on each service event so they reflect the latest collection state, 
		  no matter how fast or slow the iteration is.</p><p>It is important to note that a service update will only influence <code class="interfacename">Iterator</code>
		  operations that are executed after the event occurred. Services already returned by the iterator will not be
		  updated even if the backing service has been unregistered. As a side note, if an operation is invoked on
          such a service that has been unregistered, a <code class="literal">ServiceUnavailableException</code> will be thrown. 
		  </p><p>To conclude, while a <code class="literal">reference</code> declaration will search for candidates in case the
		  backing service has been unregistered, a service collections will not replace unregistered services returned
		  to the user. However, it will remove the unregistered services from the collection so future iterations will not
		  encounter them.
		  </p><p>Please note that the <code class="interfacename">Iterator</code> contract is guaranteed meaning that 
		  <code class="literal">next()</code> method <span class="emphasis"><em>always</em></span> obey the result of the previous 
		  <code class="literal">hasNext()</code> invocation.</p><div class="table"><a name="collection-iterator-contract"></a><p class="title"><b>Table&nbsp;7.5.&nbsp;Dynamic service collection <code class="interfacename">Iterator</code> contract</b></p><div class="table-contents"><table summary="Dynamic service collection Iterator contract" width="100%" border="1"><colgroup><col><col></colgroup><thead><tr><th>hasNext() returned value</th><th>next() behaviour</th></tr></thead><tbody><tr><td>true</td><td><span class="emphasis"><em>Always</em></span> return a non-null value, even when the collection has shrunk as services when away.
                </td></tr><tr><td>false</td><td>per <code class="interfacename">Iterator</code> contract, <code class="classname">NoSuchElementException</code> is thrown.
                This applies even if other services are added to the collection</td></tr></tbody></table></div></div><br class="table-break"><p>
	      The behaviour described above, offers a consistent view over the collection even if its structure changes during iteration.
	      To simply <span class="emphasis"><em>refresh</em></span> the iterator, call <code class="literal">hasNext()</code> again. This will force the
	      <code class="literal">Iterator</code> to check again the collection status for its particular entry in the iteration.</p><p>
	 	  In addition, any elements added to the collection during iteration over a <span class="emphasis"><em>sorted</em></span>
          collection will only be visible if the iterator has not already passed
          their sort point.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:refs:dynamics"></a>7.2.3.&nbsp;Dealing With The Dynamics Of OSGi Imported Services</h3></div></div></div><p>Whether you are using <code class="literal">reference</code>
      or <code class="literal">set</code> or <code class="literal">list</code>, Spring Dynamic
      Modules will manage the backing service. However there are cases
      where the application needs to be aware when the backing service
      is updated.</p><p>Such applications, that need to be aware of when the service
      backing a <code class="literal">reference</code> bean is bound and unbound, can
      register one or more listeners using the nested
      <code class="literal">listener</code> element.
      This element is available on both <code class="literal">reference</code> and
      <code class="literal">set</code>, <code class="literal">list</code> declarations.
      In many respects, the service importer listener declaration 
      is similar to the service exporter listener declaration 
      (<a href="#service-registry:export:lifecycle" title="7.1.7.&nbsp;Service Registration And Unregistration Lifecycle">Section&nbsp;7.1.7, &#8220;Service Registration And Unregistration Lifecycle&#8221;</a>).
      
      The <code class="literal">listener</code> element refers to a bean (either by name, 
      or by defining one inline)
      that will receive bind and unbind notifications. If this bean
      implements Spring DM's
      <code class="interfacename">org.springframework.osgi.service.importer.OsgiServiceLifecycleListener</code>
      interface, then the <code class="literal">bind</code> and
      <code class="literal">unbind</code> operations in this interface will be
      invoked. Instead of implementing this interface (or in addition),
      custom bind and unbind callback methods may be named.</p><p>An example of declaring a listener that implements
      <code class="interfacename">OsgiServiceLifecycleListener</code>:</p><pre class="programlisting">&lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>&gt;
  &lt;<span class="hl-tag">listener</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aListenerBean"</span>/&gt;
&lt;<span class="hl-tag">/reference</span>&gt;</pre><p>An example of declaring an inline listener bean with custom
      bind and unbind methods:</p><pre class="programlisting">&lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.MessageService"</span>&gt;
  &lt;<span class="hl-tag">listener</span> <span class="hl-attribute">bind-method</span>=<span class="hl-value">"onBind"</span> <span class="hl-attribute">unbind-method</span>=<span class="hl-value">"onUnbind"</span>&gt;
     &lt;<span class="hl-tag">beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyCustomListener"</span>/&gt;
  &lt;<span class="hl-tag">/listener</span>&gt;
&lt;<span class="hl-tag">/reference</span>&gt;</pre><p>If the listener bean implements the
      <code class="interfacename">OsgiServiceLifecycleListener</code> interface
      <span class="emphasis"><em>and</em></span> the listener definition specifies custom
      bind and unbind operations then both the
      <code class="literal">OsgiServiceLifecycleListener</code> operation and the
      custom operation will be invoked, in that order.</p><p>The signature of a custom bind or unbind method must be one
      of:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(ServiceType service, Dictionary properties);

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(ServiceType service, Map properties);

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(ServiceReference ref);</pre><p>where <code class="literal">ServiceType</code> can be any type. Please note that
      bind and unbind callbacks are invoked <span class="emphasis"><em>only</em></span>
      if the backing service matches the type declared in the method signature(
      <code class="classname">ServiceType</code>). If you want the callbacks to be called 
      no matter the type, use <code class="classname">java.lang.Object</code> as a 
      <code class="literal">ServiceType</code>.</p><p>
      The <code class="literal">properties</code> parameter contains the set of properties 
      that the service was registered with.</p><p>If the method signature has a single argument of type
      <code class="interfacename">ServiceReference</code> then the
      <code class="interfacename">ServiceReference</code> of the service will be passed to
      the callback in place of the service object itself.</p><p>When the listener is used with a <code class="literal">reference</code> declaration:</p><div class="itemizedlist"><ul type="disc"><li>A <span class="emphasis"><em>bind</em></span> callback is invoked 
      when the reference is initially bound to a backing service, 
      and whenever the backing service is replaced by a new backing service.
      </li><li>An <span class="emphasis"><em>unbind</em></span> callback is only 
      invoked when the current backing service is unregistered, and no 
      replacement service is immediately available 
      (i.e., the <code class="literal">reference</code> becomes unsatisfied).</li></ul></div><p>When the listener is used with a collection declaration (<code class="literal">set</code> or 
	  <code class="literal">list</code>):</p><div class="itemizedlist"><ul type="disc"><li>A <span class="emphasis"><em>bind</em></span> callback is invoked 
      		when a new service is added to the collection.
      		</li><li>An <span class="emphasis"><em>unbind</em></span> callback is 
      		invoked when a service is unregistered and is removed
      		from the collection.</li></ul></div><p>Again note that service collections there is <span class="emphasis"><em>no</em></span> 
      notion of <span class="emphasis"><em>service rebind</em></span>:
      services are added or removed from the collection.</p><p>Bind and unbind callbacks are made synchronously as part of
      processing an OSGi <code class="literal">serviceChanged</code> event for the
      backing OSGi service, and are invoked on the OSGi thread that
      delivers the corresponding OSGi
      <code class="classname">ServiceEvent</code>.</p><p>The table below lists the attributes available for the <code class="literal">reference</code> <code class="literal">listener</code> sub element.</p><div class="table"><a name="reference-import-listener-options"></a><p class="title"><b>Table&nbsp;7.6.&nbsp;OSGi &lt;listener&gt; attributes</b></p><div class="table-contents"><table summary="OSGi <listener&gt; attributes" width="100%" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>Name</th><th>Values</th><th>Description</th></tr></thead><tbody><tr><td>ref</td><td>bean name reference</td><td>Name based reference to another bean acting as listener.</td></tr><tr><td>bind-method</td><td>string representing a valid method name</td><td>The name of the method to be invoked when a backing service is bound.</td></tr><tr><td>unbind-method</td><td>string representing a valid method name</td><td>The name of the method to be invoked when a backing service is bound.</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:refs:listener-and-proxies"></a>7.2.4.&nbsp;Listener And Service Proxies</h3></div></div></div><p>While the importer listener provides access to the OSGi service bound at a certain point, it is important to note that the given argument is <span class="emphasis"><em>not</em></span> 
       the actual service but a <span class="emphasis"><em>proxy</em></span>. This can have subtle side effects especially with regards to service class name 
       and identity. The reason behind using a proxy is to prevent the listener from holding strong reference to the service (which can disappear
       at any point). Listeners interested in tracking certain services should not rely on instance equality (<code class="literal">==</code>). Object equality
       (<code class="methodname">equals</code>/<code class="methodname">hashcode</code>) can be used but only if the backing service has exposed the aforementioned methods
       as part of its contract (normally by declaring them on a certain published interface/class). If these methods are not published, the proxy will invoke its own method, not the targets. This is on purpose since, 
       while the proxy tries to be as transparent as possible, it is up to the developer to define the desired semantics. 
       </p><p>Thus, it is recommended (especially for <code class="literal">reference</code> importers) to do tracking based on just the service interface/contract 
       (not identity), service properties (see <code class="constant">org.osgi.framework.Constants#SERVICE_ID</code>) or service notification (bind/unbind).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:refs:invoker-bundle-context"></a>7.2.5.&nbsp;Accessing The Caller <code class="interfacename">BundleContext</code></h3></div></div></div><p>It is sometime useful for an imported service to know which bundle is using it
      at a certain time. To help with this scenarion, in Spring DM imported services publish
      the importing bundle <code class="interfacename">BundleContext</code> through 
      <code class="classname">LocalBundleContext</code> class. Each time a method on the importer is invoked,
      the caller <code class="interfacename">BundleContext</code> will be made available, using
      a <code class="classname">ThreadLocal</code>, through <code class="methodname">getInvokerBundleContext()</code>.
      </p><p>Please be careful when using this class since it ties your code to Spring DM API.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-registry:refs:listener-best-practices"></a>7.3.&nbsp;Exporter/Importer Listener Best Practices</h2></div></div></div><p>As mentioned above, Spring DM exporter and importer allow listeners to be
      used for receiving notifications on when services are bound, unbound, registered or 
      unregistered. Below you can find some guidance advices when working with listeners:
      </p><div class="itemizedlist"><ul type="disc"><li>
       	Do <span class="emphasis"><em>not</em></span> execute long activity tasks inside the listener. If you really
       	have to, use a separate thread for executing the work. The listener are called synchronously
       	and so try to be as fast as possible. Doing work inside the listener prevents other the event
       	to be sent to other listeners and the OSGi service to resume activity. 
      	</li><li>Use listener custom declaration as much as possible - it doesn't tie your code
      	to Spring DM API and it doesn't enforce certain signature names.</li><li>If find yourself repeating bind/unbind method declarations for your listener definitions,
      	consider using Spring <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html#beans-child-bean-definitions" target="_top">
      	bean definition inheritance</a> to define a common definition that can be reused and customized
      	accordingly.
      	</li><li>Prefer <code class="interfacename">java.util.Map</code> instead of <code class="classname">java.util.Dictionary</code>
      	class. The first is an interface while the latter is a deprecated, abstract class. To preserve compatibility, Spring DM
      	will pass to the listeners a <code class="interfacename">Map</code> implementation that can be casted, if needed, to a 
      	<code class="classname">Dictionary</code>.</li><li>Be careful when using overloaded methods: all methods matching a certain service type will be called which is not
      	always expected. Consider the following listener:
      	<div class="programlistingco"><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyListener {
    <span class="hl-keyword">void</span> register(<span class="co"><img src="images/callouts/1.png" alt="(1)"></span>Object service, Map properties);
    <span class="hl-keyword">void</span> register(<span class="co"><img src="images/callouts/2.png" alt="(2)"></span>Collection dataService, Map properties);
    <span class="hl-keyword">void</span> register(<span class="co"><img src="images/callouts/3.png" alt="(3)"></span>SortedSet orderedDataService , Map properties);
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><a name="service-registry:refs:listener:type.1"></a><p><code class="classname">Object</code> type - will match all services for which the listener is triggered. This method will be always called.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><a name="service-registry:refs:listener:type.2"></a><p><code class="classname">Collection</code> type - if this method is called, the <a href="#service-registry:refs:listener:type.1">
				<code class="classname">Object</code> method</a> is also called.
				</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><a name="service-registry:refs:listener:type.3"></a><p><code class="classname">SortedSet</code> type - if this method is called, then both the <a href="#service-registry:refs:listener:type.1">
				<code class="classname">Object</code></a> and <a href="#service-registry:refs:listener:type.2"><code class="classname">Collection</code></a> 
				methods are called.</p></td></tr></table></div></div></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="service-registry:refs:listener-best-practices:cycles"></a>7.3.1.&nbsp;Listener And Cyclic Dependencies</h3></div></div></div><p>There are cases where an exporter/importer listener needs a reference back to the bean it is defined on:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"listener"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"cycle.Listener"</span>&gt;                                              <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
    &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"importer"</span> /&gt;                                            <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
&lt;<span class="hl-tag">/bean</span>&gt;
	
&lt;<span class="hl-tag">osgi:reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"importer"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"SomeService"</span>&gt;                                   <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
    &lt;<span class="hl-tag">osgi:listener</span> <span class="hl-attribute">bind-method</span>=<span class="hl-value">"bind"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"listener"</span> /&gt;                                  <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
&lt;<span class="hl-tag">/osgi:reference</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Listener bean</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Dependency listener -&gt; importer</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Importer declaration</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Dependency importer -&gt; listener</p></td></tr></table></div></div><p>
         The declaration above while valid, creates a dependecy between the <code class="literal">listener</code> and the importer it is defined upon. 
         In order to create the importer, the <code class="literal">listener</code> has to be resolved and created but in order to do that, 
         the importer called <code class="literal">service</code> needs to be retrieved (instantiated and configured). This cycle needs to be broken
         down so that at least one bean can be fully created and configured. This scenario is supported by Spring DM
         for both exporter and importers however, if the listener is defined as a nested bean, the cycle cannot be resolved:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">osgi:reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"importer"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"SomeService"</span>&gt;                                   <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
    &lt;<span class="hl-tag">osgi:listener</span> <span class="hl-attribute">bind-method</span>=<span class="hl-value">"bind"</span>&gt;                                                   <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
        &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"cycle.Listener"</span>&gt;                                                    <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
            &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"importer"</span> /&gt;                                    <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
        &lt;<span class="hl-tag">/bean</span>&gt;
    &lt;<span class="hl-tag">/osgi:listener</span>&gt;
&lt;<span class="hl-tag">/osgi:reference</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>OSGi service importer</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Dependency between importer -&gt; listener</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Nested listener declaration</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Dependency nested listener -&gt; importer</p></td></tr></table></div></div><div class="sidebar"><p class="title"><b>Beans and Cycles</b></p><p>
         Cyclic dependencies (A depends on B which depends back on A) increase the complexity of your configuration
         and in most cases indicate a design issue. What beans should be created and destroyed first for example? 
         While they are a bad practice, the Spring container makes a best attempt to solve the cyclic configurations 
         when singletons are involved (since the instances can be cached). However this does not work all the time and
         depends heavily on your specific configuration (Can the bean class be partially initialized ? Does it rely on
         special <code class="interfacename">Aware</code> interfaces?  Are <code class="interfacename">BeanPostProcessor</code>s involved?)
         </p></div><p>The example above will fail since <code class="literal">service</code> bean cannot be initialized as it depends on the 
		listener. The same cycle was seen before but in this case there is subtle yet big different from
		the container perspective - the listener is declared as a nested/inner-bean (hence the missing bean <code class="literal">id</code>).
		Inner beans have the same life cycle as their declaring parents and do not have any name. By definition, they are not tracked
		by the container and are simply created on demand. Since the importer cannot be partially created and the nested listener cannot
		be cached, the container cannot break the cycle and create the beans. While the two configurations shown above seem similar, one works
		while the other does not. Another reason to not use cycles unless you really, really have to.</p><p>To conclude, if you need inside the listener to hold a reference to the exporter/importer on which the listener is declared,
		either declare the listener as a <span class="emphasis"><em>top-level</em></span> bean (as shown before) or consider doing <span class="emphasis"><em>dependency lookup</em></span>.
		However, the latter approach requires extra contextual information such as the <code class="interfacename">BeanFactory</code> to use and the bean
		name and is more fragile then <span class="emphasis"><em>dependency injection</em></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>For those interested in the technical details, neither the exporter and importer cannot be partially initialized since 
			they require the application context <code class="classname">ClassLoader</code> which is requested through the 
			<code class="interfacename">BeanClassLoaderAware</code> which relies on a buit-in <code class="interfacename">BeanPostProcessor</code>
			which is applied only after the bean has been configured and is ready for initialization. If the <code class="classname">ClassLoader</code>
			was not required then the exporter/importer could have been partially initialized and the case above supported.</p></td></tr></table></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-registry:refs:global-defaults"></a>7.4.&nbsp;Service Importer Global Defaults</h2></div></div></div><p>The <code class="literal">osgi</code> namespace offers two
  	  global attributes for specifying default behaviours for all
  	  importers declared in that file.</p><p>Thus, when using the <code class="literal">osgi</code> namespace to enclose
      <code class="literal">set</code>, <code class="literal">list</code> or 
      <code class="literal">reference</code> elements, one can use:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="literal">default-timeout</code> - 
      can be used to specify the default timeout (in milliseconds) for all
      importer elements that do not explicitly specify one. For
      example:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
      <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
      <span class="hl-attribute">xmlns:osgi</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>                            <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
          <span class="hl-attribute">osgi:default-timeout</span>=<span class="hl-value">"5000"</span>&gt;                                                   <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>

  &lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.AService"</span>/&gt;                             <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>

  &lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someOtherService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.BService"</span>
       <span class="hl-attribute">timeout</span>=<span class="hl-value">"1000"</span>/&gt;                                                                  <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>

&lt;<span class="hl-tag">/beans:beans</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Declare <code class="literal">osgi</code> namespace prefix.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Declare <code class="literal">default-timeout</code>(in miliseconds) on the root element. 
			If the default is not set, it will have a value of 5 minutes. In this example, the 
			default value is 5 seconds.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>This <code class="literal">reference</code> will inherit the default timeout value since 
			it does not specify one. 
			This service reference will have a timeout of 5 seconds.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>This <code class="literal">reference</code> declares a timeout, overriding the default value.
			 This service reference will have a timeout of 1 second.</p></td></tr></table></div></div></li><li><p><code class="literal">default-cardinality</code> -
		can be used to specify the default cardinality for all
      	importer elements that do not explicitly specify one.
      	Possible values are <code class="literal">0..X</code> and <code class="literal">1..X</code>
      	where <code class="literal">X</code> is substituted at runtime to <code class="literal">1</code>
      	for <code class="literal">reference</code> elements or <code class="literal">N</code>
      	for collection types such as <code class="literal">set</code> or <code class="literal">list</code>.
      	</p><p>Consider the following example:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">beans:beans</span>
      <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>                                 <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
      <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
      <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>                          <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
      <span class="hl-attribute">xmlns:osgi</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>                            <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
         <span class="hl-attribute">osgi:default-cardinality</span>=<span class="hl-value">"0..X"</span>                                                 <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
         <span class="hl-attribute">default-lazy-init</span>=<span class="hl-value">"false"</span>&gt;                                                      <span class="co"><img src="images/callouts/5.png" alt="(5)"></span>

  &lt;<span class="hl-tag">reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.AService"</span>/&gt;                             <span class="co"><img src="images/callouts/6.png" alt="(6)"></span>

  &lt;<span class="hl-tag">set</span> <span class="hl-attribute">id</span>=<span class="hl-value">"someSetOfService"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.BService"</span>/&gt;                              <span class="co"><img src="images/callouts/7.png" alt="(7)"></span>

  &lt;<span class="hl-tag">list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherListOfServices"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"com.xyz.CService"</span> <span class="hl-attribute">cardinality</span>=<span class="hl-value">"1..N"</span>/&gt;     <span class="co"><img src="images/callouts/8.png" alt="(8)"></span>

&lt;<span class="hl-tag">/beans:beans</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Declare Spring Dynamic Modules schema as the default namespace.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Import Spring Framework beans schema and associate a prefix with its namespace 
		    (<code class="literal">beans</code> in this example).</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Import Spring Dynamic Modules schema and associate a prefix with its namespace 
		    (<code class="literal">osgi</code> in this example). This is required since the global attributes
		    have to be declared to an element (<code class="literal">beans</code>) belonging to another schema.
		    To avoid ambiguity, the Spring DM schema is imported under a specified prefix as well.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Declare <code class="literal">default-cardinality</code> on the root element. 
			If the default is not set, it will have a value of <code class="literal">1..N</code>. In this example, the 
			default value is <code class="literal">0..N</code>. Note the <code class="literal">osgi</code> prefix added to
			the global attribute.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/5.png" alt="5" border="0"></td><td valign="top" align="left"><p><code class="literal">beans</code> element attributes (such as <code class="literal">default-lazy-init</code>) 
			do not need a prefix since they are declared as being local and unqualified 
			(see the beans schema for more information).</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/6.png" alt="6" border="0"></td><td valign="top" align="left"><p>
			The <code class="literal">reference</code> declaration will inherit the default cardinality value since it does not specify one.
			As <code class="literal">reference</code> represents a single service, its cardinality will be <code class="literal">0..1</code>.
			</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/7.png" alt="7" border="0"></td><td valign="top" align="left"><p>
			The <code class="literal">set</code> declaration will inherit the default cardinality value since it does not specify one.
			As <code class="literal">set</code> (or <code class="literal">list</code>) represents a collection of service, 
			its cardinality will be <code class="literal">0..N</code>.
			</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/8.png" alt="8" border="0"></td><td valign="top" align="left"><p>The <code class="literal">list</code> declaration specifies its cardinality (<code class="literal">1..N</code>),
			 overriding the default value.</p></td></tr></table></div></div></li></ul></div><p>The <code class="literal">default-*</code> attributes allow for concise and shorter declarations as well
      as easy propagation of changes (such as increasing or decreasing the timeout).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-registry:export-import-relationship"></a>7.5.&nbsp;Relationship Between The Service Exporter And Service Importer</h2></div></div></div><p>An exported service may depend, either directly or indirectly,
        on other services in order to perform its function. If one of these
        services is considered a <span class="emphasis"><em>mandatory</em></span> dependency
        (has cardinality <code class="literal">1..x</code>) and the 
        dependency can no longer be satisfied
        (because the backing service has gone away and there is no suitable
        replacement available) then the exported service that depends on it
        will be automatically unregistered from the service registry - meaning
        that it is no longer available to clients. If the mandatory dependency
        becomes satisfied once more (by registration of a suitable service),
        then the exported service will be re-registered in the service
        registry.</p><p>This automatic unregistering and re-registering of exported
        services based on the availability of mandatory dependencies only
        takes into account declarative dependencies. If exported service
        <code class="literal">S</code> depends on bean <code class="literal">A</code>, which in
        turn depends on mandatory imported service <code class="literal">M</code>, and
        these dependencies are explicit in the Spring configuration file as
        per the example below, then when <code class="literal">M</code> becomes
        unsatisfied <code class="literal">S</code> will be unregistered. When
        <code class="literal">M</code> becomes satisfied again, <code class="literal">S</code>
        will be re-registered.</p><pre class="programlisting">&lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"S"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"A"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"SomeInterface"</span>/&gt;

&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"A"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SomeImplementation"</span>&gt;
   &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"helperService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"M"</span>/&gt;
&lt;<span class="hl-tag">/bean</span>&gt; 

&lt;<span class="hl-comment">!-- the reference element is used to refer to a service
     in the service registry --</span>&gt;
&lt;<span class="hl-tag">osgi:reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"M"</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"HelperService"</span>
     <span class="hl-attribute">cardinality</span>=<span class="hl-value">"1..1"</span>/&gt;</pre><p>If however the dependency from <code class="literal">A</code> on
        <code class="literal">M</code> is not established through configuration as shown
        above, but instead at runtime through for example passing a reference
        to <code class="literal">M</code> to <code class="literal">A</code> without any
        involvement from the Spring container, then Spring Dynamic Modules
        will <span class="emphasis"><em>not</em></span> track this dependency.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="bundles"></a>Chapter&nbsp;8.&nbsp;Working With Bundles</h2></div></div></div><p>Spring DM offers a dedicated schema element for interacting with existing
    bundles or for installing new ones. While it is not intended to be used as a replacement
    for proper OSGi services, the <code class="literal">bundle</code> element offers a very
    easy way of executing actions on bundles based on the lifecycle of the application
    context. 
    </p><p>The <code class="literal">bundle</code> element defines a bean of type
    <code class="interfacename">org.osgi.framework.Bundle</code>. It provides a simple way to
    work directly with bundles, including driving their lifecycle. In the
    simplest case all you need to do is specify the
    <code class="literal">symbolic-name</code> of the bundle you are interested
    in:</p><pre class="programlisting">&lt;<span class="hl-tag">bundle</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aBundle"</span> <span class="hl-attribute">symbolic-name</span>=<span class="hl-value">"org.xyz.abundle"</span>/&gt;</pre><p>The bean <code class="literal">aBundle</code> can now be injected into any property of 
    type <code class="interfacename">Bundle</code>.</p><p>If the needed bundle is not installed, one can use <code class="literal">location</code> attribute
    to indicate install or/and the <code class="literal">action</code>/<code class="literal">destroy-action</code> attributes
    provide declarative control over the bundle's lifecycle. The <code class="literal">location</code> attribute is 
    used to specify a URL where the bundle jar file artifact can be found. The
    <code class="literal">action</code> attribute specifies the lifecycle operation to
    be invoked on the bundle object. The supported action values are
    <code class="literal">install</code>, <code class="literal">start</code>,
    <code class="literal">update</code>, <code class="literal">stop</code>, and
    <code class="literal">uninstall</code>. These actions have the same semantics as the
    operations of the corresponding names defined on the
    <code class="literal">Bundle</code> interface (see the OSGi Service Platform Core
    Specification), with the exception that pre-conditions are weakened to
    allow for example a <span class="emphasis"><em>start</em></span> action to be specified against a bundle that
    is not currently installed (it will be installed first).</p><p>The following table shows how actions are interpreted for the given
    Bundle states:</p><div class="table"><a name="bundle-factory-actions"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;&lt;bundle&gt; <code class="literal">action</code> values</b></p><div class="table-contents"><table summary="<bundle&gt; action values" width="100%" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>Action</th><th><code class="literal">UNINSTALLED</code></th><th><code class="literal">INSTALLED/RESOLVED</code></th><th><code class="literal">ACTIVE</code></th></tr></thead><tbody><tr><td><code class="literal">START</code></td><td>installs and starts the bundle</td><td>starts the bundle</td><td>no action taken, bundle already started</td></tr><tr><td><code class="literal">UPDATE</code></td><td>installs the bundle and then updates it (`Bundle.update()`)</td><td>updates the bundle</td><td>updates the bundle</td></tr><tr><td><code class="literal">STOP</code></td><td>no action taken</td><td>no action taken</td><td>bundle is stopped</td></tr><tr><td><code class="literal">UNINSTALL</code></td><td>no action taken</td><td>bundle is uninstalled</td><td>bundle is stopped and then uninstalled</td></tr></tbody></table></div></div><br class="table-break"><p>For example:</p><pre class="programlisting">&lt;<span class="hl-comment">!-- ensure this bundle is installed and started --</span>&gt;
&lt;<span class="hl-tag">bundle</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aBundle"</span> <span class="hl-attribute">symbolic-name</span>=<span class="hl-value">"org.xyz.abundle"</span>
   <span class="hl-attribute">location</span>=<span class="hl-value">"http://www.xyz.com/bundles/org.xyz.abundle.jar"</span>
   <span class="hl-attribute">action</span>=<span class="hl-value">"start"</span>/&gt;</pre><p>The following table lists the <code class="literal">bundle</code> element attributes names, 
    possible values and a short description for each of them:
    </p><div class="table"><a name="bundle-options"></a><p class="title"><b>Table&nbsp;8.2.&nbsp;&lt;bundle&gt; attributes</b></p><div class="table-contents"><table summary="<bundle&gt; attributes" width="100%" border="1"><colgroup><col><col align="center"><col align="center"><col align="center"><col align="center"><col align="center"><col align="justify"></colgroup><thead><tr><th>Name</th><th colspan="5" align="justify">Values</th><th align="justify">Description</th></tr></thead><tbody><tr><td>symbolic-name</td><td colspan="5" align="justify">any valid symbolic-name String</td><td align="justify">The symbolic name of the bundle object. Normally used when interacting with an already 
             installed bundle.</td></tr><tr><td>location</td><td colspan="5" align="justify">String that can be converted into an <code class="literal">URL</code></td><td align="justify">Location used to install, update or/and identify a bundle.</td></tr><tr><td>action</td><td align="center">start</td><td align="center">stop</td><td align="center">install</td><td align="center">uninstall</td><td align="center">update</td><td align="justify">Lifecyle action to drive on the bundle. The action is executed at startup.</td></tr><tr><td>destroy-action</td><td colspan="5" align="justify">(same as action)</td><td align="justify">Lifecyle action to drive on the bundle. The action is executed at shutdown.</td></tr></tbody></table></div></div><br class="table-break"><p>The samples that ship with the Spring Dynamic Modules project
    include further support for a <code class="literal">virtual-bundle</code> element
    that can be used to create and install OSGi bundles on the fly from
    existing artifacts.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="web"></a>Chapter&nbsp;9.&nbsp;Web Support</h2></div></div></div><div class="sidebar"><p class="title"><b>OSGi bundles and WARs</b></p><p>
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/WAR_%28file_format%29" target="_top">Web ARchives</a>, or in short WARs, are specialized JAR for packaging web applications.
      Since the same archive format is used (Java ARchive), each war can be considered an OSGi bundle if the proper OSGi manifest entries are present.
      Note that it is not required for a bundle to have a <code class="literal">.jar</code> file extension, which means <code class="literal">.war</code> files can be installed
      just as well.
      </p></div><div class="sidebar"><p class="title"><b>Deployment scenarios</b></p><p>
      Users new to OSGi can benefit greatly from the SpringSource dm Server <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.org/dmserver" target="_top">documentation</a> which explains
      how OSGi can work in various development and production scenarios.
      </p></div>
    
    This will help you to understand how osgi can work in a development / production environment. The programmer guide describes the sophisticated eclipse tooling in detail.
    

    <p>A major feature introduced in the 1.1.0 release is <span class="emphasis"><em>support for web applications</em></span> which enables easy deployment of web artifacts 
    to OSGi.</p><p>
    The biggest problems in running web applications in OSGi involve resource and class loading; there is no notion of <span class="emphasis"><em>bundle space</em></span> or 
    <span class="emphasis"><em>imported packages</em></span> in a web application. Each web container has its own class loading hierarchy and classpath assumption 
    which can conflict with the OSGi space. 
    Spring DM addresses these problems by bridging the web container and the OSGi space so loading is no longer a concern. Unique in its functionality, 
    the web support in Spring DM integrates directly with the web container so the WAR processing is literally handled by the server, giving full 
    access to its configuration and capabilities(non-blocking vs blocking IO, thread pool, specification support (Servlet 2.3, 2.4, 2.5) and so on).
    The entire <code class="literal">web.xml</code> syntax is supported (without any parsing on Spring DM behalf), as well as any custom configuration file 
    particular to the target container. In short, everything that the target container supports is available to the OSGi WAR through Spring DM.
    </p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/admons/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">As a complement to this chapter, the Spring DM distribution contains a number of web samples involving static resources, Servlets and JSPs running inside
    OSGi.</td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">For more information on web applications on Java platform, please see the Servlet home <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/servlet/" target="_top">page</a>.</td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:supported-containers"></a>9.1.&nbsp;Supported Web Containers</h2></div></div></div><p>Currently, Spring DM supports <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://tomcat.apache.org" target="_top">Apache Tomcat</a> 5.5.x/6.0.x and 
    	<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://jetty.mortbay.org/" target="_top">Jetty</a> 6.1.8+/6.2.x out of the box (other containers can be easily plugged in). The web support is JDK 1.4 
    	compatible. Please check the chosen container requirements for more information on the required JVM. In general, Servlet 2.4/JSP 2.0 require JDK 1.4 
    	while Servlet 2.5/JSP 2.1 require JDK 1.5.
    	</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:usage"></a>9.2.&nbsp;Web Support Usage</h2></div></div></div><div class="sidebar"><p class="title"><b>WAR vs Web Application</b></p><p>
	   	  This document understand by web application an instance of a WAR: a WAR is a definition while a web application a runtime instance of a definition. 
	   	  This is similar to the difference between a class and an object: the class represents a (bytecode) definition while the object, 
	   	  the instance of a class.
	      </p></div><p>Just like with non-WAR bundles, Spring DM Web uses the <a href="#extender-pattern" title="Extender Pattern">extender pattern</a> to detect and install WARs. However,
    	one crucial difference from the standard Spring DM <a href="#bnd-app-ctx:extender" title="5.1.&nbsp;The Spring Dynamic Modules Extender bundle">Extender</a> is that Spring DM will 
    	only trigger the install and uninstall of the WAR - the actual web application creation and thread management is delegated to the web container in 
    	which the WAR is installed. That is, Spring DM Web <span class="emphasis"><em>only</em></span> dictates when a WAR is deployed to and undeployed from a web container; 
    	it is up to the web container to create and manage the equivalent web application.    
    	</p><p>To use Spring DM Web, install:
    	</p><div class="itemizedlist"><ul type="disc"><li><code class="literal">spring-osgi-web.jar</code> - Spring DM web support
    		</li><li><code class="literal">spring-osgi-web-extender.jar</code> - Spring DM web extender
	   		</li></ul></div><p>
    	bundles to detect started OSGi WAR bundles and to deploy them to one of the supported web containers. Note that the web extender consider a war a bundle
    	that has trailing <code class="literal">.war</code> in its location or contains a <code class="literal">WEB-INF</code> entry. 
    	By default, Tomcat will be used but this can be changed to Jetty or to another custom server. When the war bundle is stopped, 
    	Spring DM will also stop and uninstall the web application associated with it. Different from 
    	<span class="emphasis"><em>traditional</em></span> web development, the Servlet classes need to be explicitly imported as the OSGi class path always takes priority
    	(see <a href="#web:classpath" title="9.3.&nbsp;WAR Classpath In OSGi">below</a>).</p><p>Since, when running a web application, it's the web container that does the bootstrapping and instantiation, there is no need to 
    	place the Spring .xml files under <code class="literal">META-INF/spring</code> or use the Spring DM <a href="#app-deploy:headers" title="6.1.&nbsp;Bundle Format And Manifest Headers">manifest entries</a>.
    	Simply bundle your files in the WAR and use your web framework (or <code class="interfacename">Servlet</code>s/<code class="interfacename">Listener</code>s) 
    	to bootstrap the Spring container. See <a href="#web:spring-mvc" title="9.7.&nbsp;Spring-MVC Integration">Section&nbsp;9.7, &#8220;Spring-MVC Integration&#8221;</a> for Spring-MVC integration and/or Spring reference
    	<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html#context-create" target="_top">documentation</a> for more information.
    	These being said, the Spring Extender is still required as it performs namespace handlers discovery - without it, it would not be possible to use
    	Spring namespaces (like <code class="literal">osgi:</code>, <code class="literal">aop:</code> or even <code class="literal">beans:</code> for that matter).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:classpath"></a>9.3.&nbsp;WAR Classpath In OSGi</h2></div></div></div><p>The servlet specification defines a number of rules and locations which special meaning inside a WAR. This section will explain how these are
    	handled in an OSGi environment.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="web:classpath:static-resources"></a>9.3.1.&nbsp;Static Resources</h3></div></div></div><p>When installing a WAR bundle, for static resources, Spring DM will only consider what is available in the bundle space - this means what 
    		is available in the bundle jar and its attached fragments. Conforming to the Servlet spec, resources under <code class="literal">WEB-INF</code> folder
    		will be available through the <code class="interfacename">ServletContext</code> API but not to remote clients connecting to the web application.
    		In addition, any resource available in the classpath (imported packages, required bundles or dynamic imports) can be loaded and used by
    		the application code but cannot be seen <span class="emphasis"><em>outside</em></span> of it.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="web:classpath:servlets"></a>9.3.2.&nbsp;Servlets</h3></div></div></div><p>The main difference from the <span class="emphasis"><em>traditional</em></span> WAR deployment is that the Servlet packages need to be imported so they are
    		available to the WAR bundle. To do that, add the following packages to the <code class="literal">Import-Package</code> entry:</p><pre class="programlisting">Import-Package: javax.servlet,javax.servlet.http,javax.servlet.resources</pre><p>Additionally, the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/servlet/" target="_top">servlet</a> 
    		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/servlet/reference/api/index.html" target="_top">specification</a> 
    		defines the classpath of a WAR, based on some predefined locations. To quickly recap, these are: </p><div class="itemizedlist"><ul type="disc"><li><code class="literal">WEB-INF/classes</code> - all resources under <code class="literal">WEB-INF/classes</code></li><li><code class="literal">WEB-INF/lib/*.jar</code> - all jars under <code class="literal">WEB-INF/lib</code></li></ul></div><p>In addition, each container implementation can provide <span class="emphasis"><em>common</em></span> libraries that are appended to the war classpath. Since OSGi, 
			with its class wiring, versioning, reloading, superseeds the WAR classpath, Spring DM will ignore the WAR predefined locations and will <span class="emphasis"><em>always</em></span>
			use	the OSGi classpath instead. This means that classes imported by a WAR bundle can be used even if they are not present under <code class="literal">WEB-INF/classes</code>
			folder or inside a jar under <code class="literal">WEB-INF/lib</code>. This also means that any class under <code class="literal">WEB-INF/classes</code> will not be considered
			if it's not available in the WAR OSGi classpath.
			</p><p>One of the easiest ways to support the pre-defined WAR locations, is to add them to the bundle classpath, by adding them to the bundle manifest:</p><pre class="programlisting">Bundle-Classpath: .,WEB-INF/classes,WEB-INF/lib/some.jar,WEB-INF/lib/lib.jar</pre><p>Make sure the default <code class="literal">Bundle-Classpath</code> location (<code class="literal">.</code>) is present and there are no whitespaces between the commas.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">Since the OSGi API doesn't provide a hook for bundles to be pre-processed, Spring DM cannot automate this process in a reliable way. However, we are 
			working on finding a suitable solution. Note that there are tools (<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.aqute.biz/Code/Bnd" target="_top">bnd</a>) that can add these entries 
			during packaging.</td></tr></table></div><p>Before creating entries for embedded libraries, consider whether they can be installed as OSGi bundles - doing so allows them to be 
			shared with other WARs if needed and since OSGi allows versioning, it is perfectly okay to have multiple versions of the same library inside the same VM.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="web:classpath:jsps"></a>9.3.3.&nbsp;Java Server Pages</h3></div></div></div><p>For <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/jsp" target="_top">JSPs</a>, Spring DM integrates with Tomcat <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Tomcat_Jasper" target="_top">Jasper 2</a> Engine 
    		which means JSP 1.2, 2.0 and 2.1 are supported. OSGified versions for Jasper (from Tomcat 5.5.x and 6.0.x distribution respectively) are available in the Spring DM OSGi 
    		repository. No imports on Jasper classes are required for the OSGi bundle.
    		</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="web:classpath:jsps:taglibs"></a>9.3.3.1.&nbsp;Tag Libraries</h4></div></div></div><p>The JSP spec allows the creation of tag libraries to &#8220;<span class="quote">define declarative, modular functionality that can be reused by any JSP page</span>&#8221;. 
    			Also known as taglibs, these reusable components consist of Java classes (the tag implementation) and description files that indicate how the tags can be used.
    			Spring DM extends the JSP convention, of placing the taglibs either packed as a jar under <code class="literal">WEB-INF/lib</code> or unpacked under 
    			<code class="literal">WEB-INF/classes</code>, by detecting any taglib defined in the bundle classpath (imported packages or required bundles).</p><p>Spring DM will automatically look for any taglib file (<code class="literal">*.tld</code>) available in the bundle classpath and will make them available to the Jasper engine.
    			However, while the tag definitions are automatically discovered, the tag classes are not - again, the OSGi classpath takes priority. This means that in order to use a tag,
    			the war bundle would have to import the tag corresponding classes since otherwise, they are not seen by the bundle and the tag cannot be used.</p><p>When dealing with libraries that export a lot of tags, one can use the <code class="literal">Require-Bundle</code> header instead of <code class="literal">Import-Package</code> for 
    			importing the tags:</p><pre class="programlisting">Require-Bundle: org.springframework.osgi.jstl.osgi</pre><p>Using the manifest entry above, all the classes (and thus tag implementations) exported by the JSP Standard Tag Library (or 
    			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/jsp/jstl/index.jsp" target="_top">JSTL</a> in short), are seen by the war bundle and thus can be
    			used inside the JSPs.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/admons/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">Before using <code class="literal">Require-Bundle</code> on a large scale, please read the OSGi specification (section 3.13) 
    			for an in-depth review of its implications.</td></tr></table></div></div></div><p>No matter what mechanism you decide to use for the war classpath, due to the OSGi capabilities, it is possible to create libraries that are <span class="emphasis"><em>shared</em></span>
    between multiple WARs while having full control over the used packages. Each bundle can import only the packages (and the versions) needed not an entire library jar - in fact,
    packages from different bundles/jars can be selectively used to obtain the desired behaviour - a very powerful capability which should make web application deployment easier.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:configuration"></a>9.4.&nbsp;Configuring The Web Extender</h2></div></div></div><p>Just like the <a href="#app-deploy:extender-configuration" title="6.2.&nbsp;Extender Configuration Options">core extender</a>, the web extender can be configured by using OSGi <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragments</a>.
    	Following a similar pattern, the web extender looks for all XMLs under <code class="literal">META-INF/spring/extender</code> folder in <span class="emphasis"><em>its</em></span> bundle space and assembles them into
    	an application context that is used internally as its configuration. To override a default setting of the web extender, look up the appropriate bean
    	name from the table below, define it in a suitable manner and then attach it as a <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragment</a> to the <code class="literal">spring-osgi-web.jar</code>,
    	using:</p><pre class="programlisting">Fragment-Host: org.springframework.osgi.web.extender</pre><p>The following beans are currently recognized by the web extender:</p><div class="table"><a name="web-extender-configuration-options"></a><p class="title"><b>Table&nbsp;9.1.&nbsp;Web Extender Configuration Options</b></p><div class="table-contents"><table summary="Web Extender Configuration Options" width="100%" border="1"><colgroup><col><col><col><col><col></colgroup><thead><tr><th>Bean Name</th><th>Type</th><th>Role</th><th>Default Class</th><th>Default Behaviour</th></tr></thead><tbody><tr><td><code class="literal">warDeployer</code></td><td><code class="interfacename">WarDeployer</code>
                <sup>[<a name="interface-package" href="#ftn.interface-package">a</a>]</sup>
                </td><td>Installs OSGi bundles as web applications. The deployers takes care of locating the required web container and installing and 
                uninstalling web applications.</td><td><code class="classname">TomcatWarDeployer</code>
                <sup>[<a name="d18e4241" href="#ftn.d18e4241">b</a>]</sup>
                </td><td>Installs OSGi WARs to Tomcat 5.5.x/6.0.x. The servers needs to be installed, started and published as OSGi services as explained  
                <a href="#web:osgi-artifacts:containers:tomcat" title="9.6.1.1.&nbsp;Tomcat 5.5.x/6.0.x">here</a>.</td></tr><tr><td><code class="literal">contextPathStrategy</code></td><td><code class="interfacename">ContextPathStrategy</code><sup>[<a href="#ftn.interface-package">a</a>]</sup></td><td>Determines the context path associated with an OSGi bundle/WAR. The returned path is used by the war deployer to install the war application.</td><td><code class="classname">DefaultContextPathStrategy</code><sup>[<a name="d18e4266" href="#ftn.d18e4266">c</a>]</sup>
                </td><td>Returns as context path of the war based on the <code class="literal">Web-ContextPath</code> manifest header or (if missing),
                the file name from the bundle location, falling back to the bundle name and bundle symbolic name respectively. 
                If neither of these is present, the bundle object identity will be used.</td></tr></tbody><tbody class="footnotes"><tr><td colspan="5"><div class="footnote"><p><sup>[<a name="ftn.interface-package" href="#interface-package">a</a>] </sup>Part of <code class="literal">org.springframework.osgi.web.deployer</code> package</p></div><div class="footnote"><p><sup>[<a name="ftn.d18e4241" href="#d18e4241">b</a>] </sup>Part of <code class="literal">org.springframework.osgi.web.deployer.tomcat</code> package</p></div><div class="footnote"><p><sup>[<a name="ftn.d18e4266" href="#d18e4266">c</a>] </sup>Part of <code class="literal">org.springframework.osgi.web.deployer.support</code> package</p></div></td></tr></tbody></table></div></div><br class="table-break"><p>Note that to properly support wars, whether they are using Servlet 2.5 or not, the Spring DM web extender considers as WARs bundles that
    	contains a <code class="literal">.war</code> extension.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="web:configuration:changing-deployer"></a>9.4.1.&nbsp;Changing The War Deployer</h3></div></div></div><p>To change the Tomcat deployer to Jetty for example, one can create a configuration file <code class="literal">META-INF/spring/extender/jetty-deployer.xml</code> with
    		the following content:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans   
       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;

    &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"warDeployer"</span>                                                               <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.osgi.web.deployer.jetty.JettyWarDeployer"</span> /&gt;          <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
&lt;<span class="hl-tag">/beans</span>&gt;
</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p><a href="#web-extender-configuration-options" title="Table&nbsp;9.1.&nbsp;Web Extender Configuration Options">Pre-defined</a> bean name used by the web extender</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Bean implementing <code class="interfacename">org.springframework.osgi.web.deployer.WarDeployer</code> interface</p></td></tr></table></div></div><p>Once the file is created, it should be bundled in an OSGi fragment attached to the Spring DM Web Extender bundle by adding the 
    		<code class="literal">Fragment-Host</code> header:</p><pre class="programlisting">Fragment-Host: org.springframework.osgi.web.extender</pre><p>Now the fragment can be deployed alongside <code class="literal">spring-osgi-web.jar</code> bundle to plug in Jetty.</p><p>A pre-packed Jetty fragment is available in the Spring DM <a href="#appendix-osgi-repo" title="Appendix&nbsp;G.&nbsp;Spring DM OSGi Repository"> maven repository</a> under 
			<code class="literal">jetty.web.extender.fragment.osgi</code> artifactId (make sure to use version 1.0.1+).</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:configuration:customizing-deployer"></a>9.5.&nbsp;Customizing The Standard Deployers</h2></div></div></div><p>By default, the out of the box deployers look up the needed services, at startup. As the services are considered mandatory, the deployers will wait for
    	them and, in case they are not found, will throw an exception. In cases where the default timeout or service lookup filter is not be appropriate, one
    	can customize the service used through a Spring DM <a href="#service-registry:refs" title="7.2.&nbsp;Defining References To OSGi Services">reference</a>: 
    	</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:osgi</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>
   <span class="hl-attribute">xmlns:p</span>=<span class="hl-value">"http://www.springframework.org/schema/p"</span>                                     <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans   
     http://www.springframework.org/schema/beans/spring-beans.xsd
     http://www.springframework.org/schema/osgi
     http://www.springframework.org/schema/osgi/spring-osgi.xsd"</span>&gt;

    &lt;<span class="hl-tag">osgi:reference</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTomcatServer"</span>                                                  <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
		<span class="hl-attribute">interface</span>=<span class="hl-value">"org.apache.catalina.Service"</span> 
		<span class="hl-attribute">filter</span>=<span class="hl-value">"(environment=testing)"</span>
		<span class="hl-attribute">cardinality</span>=<span class="hl-value">"0..1"</span>/&gt;
		
    &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"warDeployer"</span>                                                               <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.osgi.web.deployer.tomcat.TomcatWarDeployer"</span>
        <span class="hl-attribute">p:service-ref</span>=<span class="hl-value">"myTomcatServer"</span>/&gt;                                                 <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>

&lt;<span class="hl-tag">/beans</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>User defined OSGi service lookup</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Deployer definition (name is important)</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p><span class="emphasis"><em>Service</em></span> property assignment (through <code class="literal">p</code> namespace) </p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Spring's <code class="literal">p</code> namespace declaration - 
            see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://blog.springsource.com/main/2006/11/25/xml-syntax-sugar-in-spring-20/" target="_top">this</a> blog entry
            for more information</p></td></tr></table></div></div><p>Make sure to add the packages on which your configuration depends to the fragment manifest (since the web extender bundle imports only the packages
    	it needs: Spring DM web support's). For the example above, one must import Catalina <code class="interfacename">Service</code>'s package. Since the 
    	<code class="interfacename">Service</code> interface signature depends on the <code class="interfacename">Connector</code> class from another package, its package
    	needs to be imported as well - not doing so results in <code class="classname">ClassNotFoundException/NoClassDefFoundError</code>s:</p><pre class="programlisting"><em class="lineannotation"><span class="lineannotation"># Catalina packages</span></em>
Import-Package: org.apache.catalina,org.apache.catalina.connector
<em class="lineannotation"><span class="lineannotation"># Spring DM Web Extender</span></em>
Fragment-Host: org.springframework.osgi.web.extender</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:osgi-artifacts"></a>9.6.&nbsp;OSGi-ready Libraries And Web Development</h2></div></div></div><p>Unfortunately, at the moment most libraries used for web development are not OSGi bundles, which means they cannot be used inside the OSGi space unless they
    	are embedded in other bundles. To address this problem, the Spring DM project has osgified most of the common libraries and made them available through a dedicated
    	Maven repository (which can be found in the <a href="#appendix-osgi-repo" title="Appendix&nbsp;G.&nbsp;Spring DM OSGi Repository">appendix</a>). Please note that the current repository, for now, is <span class="emphasis"><em>provided as-is</em></span> without any support.
    	These being said, we hope you find it useful.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="web:osgi-artifacts:containers"></a>9.6.1.&nbsp;Deploying Web Containers As OSGi Bundles</h3></div></div></div><p>Spring DM web support expects the web containers to be installed as OSGi services. Since neither the Tomcat nor the Jetty distribution do this, 
    	Spring DM offers two simple yet useful OSGi <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www2.osgi.org/javadoc/r4/org/osgi/framework/BundleActivator.html" target="_top">Activator</a>s for 
    	both containers	at the Spring DM OSGi repository. Once installed, these will programmatically start the appropriate web container based on a default configuration (which can be customized
		and publish it as an OSGi service. While the activators are generic, they can be easily customized for advance usages or even replaced - it's up to each 
		deployer to decide how the server instances are looked up.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">The activator binaries and sources can be found either in the Spring DM repository (see below) or under the <code class="literal">lib/</code> folder 
		inside the Spring DM (<code class="literal">with-dependencies</code>) distribution</td></tr></table></div><p>All entries in the repository belong to the <code class="literal">org.springframework.osgi</code> group and have an <code class="literal">.osgi</code> termination to differentiate
		them from the original jars.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="web:osgi-artifacts:containers:tomcat"></a>9.6.1.1.&nbsp;Tomcat 5.5.x/6.0.x</h4></div></div></div><p>Apache Tomcat version 5.5.x and 6.0.x are available as OSGi artifacts in the repository under <code class="literal">catalina.osgi</code> artifactId.
			The jars require only commons-logging, JMX and Servlet/JSP libraries to be present.
			</p><p>In addition to the Catalina artifacts, the repository contains also a Tomcat activator (that works with both 5.5.x and 6.0.x versions) named
			<code class="literal">catalina.osgi.start</code>. The activator understands Tomcat XML configuration and contains a default, minimal setup that starts the 
			server on <code class="literal">localhost</code>,	port <code class="literal">8080</code>. This behaviour can be customized by placing the desired configuration 
			(which will override the default one) under	<code class="literal">conf/server.xml</code> location (following the Tomcat folder layout) 
			in a fragment attached to the Tomcat activator.</p><p>To attach <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragments</a> to the Tomcat activator, specify the following host name in the fragment 
			manifest:</p><pre class="programlisting">Fragment-Host: org.springframework.osgi.catalina.start.osgi</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="web:osgi-artifacts:containers:jetty"></a>9.6.1.2.&nbsp;Jetty 6.1.8+/6.2.0</h4></div></div></div><p>Since Jetty is OSGi-ready by default, the official distribution can be installed without any transformation/processing on the OSGi platform. However,
			since there is no activator, Spring DM provides one, similar in functionality to the one available for Tomcat. The activator has 
			<code class="literal">jetty.start.osgi</code> as artifact id. Similar to the Tomcat case, a default configuration bundle (named <code class="literal">jetty.etc.osgi</code>) is provided for starting a Jetty instance on <code class="literal">localhost</code>, port <code class="literal">8080</code>. To change the defaults, place your Jetty configuration under <code class="literal">etc/jetty.xml</code> location (either by updating the provided bundle by using a custom one).</p><p>To attach <a href="#appendix-tips:fragments" title="E.1.&nbsp;OSGi Fragments">fragments</a> to the Jetty activator, specify the following host name in the fragment manifest:</p><pre class="programlisting">Fragment-Host: org.springframework.osgi.jetty.start.osgi</pre></div><p>Just like the extender, each activator uses a default configuration which can be overridden by the user. For the latter case, one should use fragments 
		(as mentioned above) to provide a customized configuration and to avoid modifying the distribution jar.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="web:osgi-artifacts:common-libraries"></a>9.6.2.&nbsp;Common Libraries</h3></div></div></div><p>The Servlet, Java Server Pages, Standard Taglib, Commons-EL and other web libraries are available as well in the Spring DM repository. When browsing
			use an <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://aws.amazon.com/s3" target="_top">S3</a> compatible application .</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web:spring-mvc"></a>9.7.&nbsp;Spring-MVC Integration</h2></div></div></div><p>Since 1.1, Spring DM integrates closely with 
	   <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/mvc.html" target="_top">Spring-MVC</a> framework.
	   This section details how Spring-MVC applications can be run into OSGi environments (it is assumed the reader 
	   is familiar with Spring-MVC concepts and APIs).
	   </p><p>In order to be properly used inside an OSGi platform, a Spring-MVC application needs to adapt to its new environment.
     Spring DM provides a dedicated, OSGi-aware, web application context (called <code class="classname">OsgiBundleXmlWebApplicationContext</code>) 
     that offers the same functionality and behaviour to its Spring-MVC brethren, <code class="classname">
     <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/web/context/support/XmlWebApplicationContext.html" target="_top">
     XmlWebApplicationContext</a></code>. The application context is aware of the web application <code class="interfacename">BundleContext</code>
     and thus is able to load resources from the OSGi space, import and export OSGi services and support the 
     <code class="interfacename">BundleContextAware</code> and component scanning across the bundles included in the classpath.</p><p>To use this application context instead of the default one, use the <code class="literal">contextClass</code> parameters supported by 
     Spring's <code class="classname">ContextLoaderListener</code> and <code class="classname">DispatcherServlet</code> inside your web application 
     <code class="literal">WEB-INF/web.xml</code>:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">context-param</span>&gt;
  &lt;<span class="hl-tag">param-name</span>&gt;contextClass&lt;<span class="hl-tag">/param-name</span>&gt;                                                                         <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
  &lt;<span class="hl-tag">param-value</span>&gt;org.springframework.osgi.web.context.support.OsgiBundleXmlWebApplicationContext&lt;<span class="hl-tag">/param-value</span>&gt;    <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
&lt;<span class="hl-tag">/context-param</span>&gt;

&lt;<span class="hl-tag">listener</span>&gt;
  &lt;<span class="hl-tag">listener-class</span>&gt;org.springframework.web.context.ContextLoaderListener&lt;<span class="hl-tag">/listener-class</span>&gt;                        <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
&lt;<span class="hl-tag">/listener</span>&gt;

&lt;<span class="hl-tag">servlet</span>&gt;
  &lt;<span class="hl-tag">servlet-name</span>&gt;petclinic&lt;<span class="hl-tag">/servlet-name</span>&gt;
  &lt;<span class="hl-tag">servlet-class</span>&gt;org.springframework.web.servlet.DispatcherServlet&lt;<span class="hl-tag">/servlet-class</span>&gt;                              <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
  &lt;<span class="hl-tag">load-on-startup</span>&gt;2&lt;<span class="hl-tag">/load-on-startup</span>&gt;
  &lt;<span class="hl-tag">init-param</span>&gt;
    &lt;<span class="hl-tag">param-name</span>&gt;contextClass&lt;<span class="hl-tag">/param-name</span>&gt;                                                                       <span class="co"><img src="images/callouts/5.png" alt="(5)"></span>
    &lt;<span class="hl-tag">param-value</span>&gt;org.springframework.osgi.web.context.support.OsgiBundleXmlWebApplicationContext&lt;<span class="hl-tag">/param-value</span>&gt;  <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
  &lt;<span class="hl-tag">/init-param</span>&gt;
&lt;<span class="hl-tag">/servlet</span>&gt;
</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Name of the <code class="literal">context-param</code> used by Spring's <code class="literal">ContextLoaderListener</code>
            to determine the root web application context type</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Fully qualified name of the OSGi-aware web application context class</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>Spring configuration bootstrap listener</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>Spring MVC front controller</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/5.png" alt="5" border="0"></td><td valign="top" align="left"><p>Name of the <code class="literal">init-param</code> used by Spring's <code class="classname">DispatcherServlet</code> to determine 
         	the	web application context type</p></td></tr></table></div></div><p>With this configuration, deployed Spring-MVC bundles will be able to look up the existing <code class="interfacename">BundleContext</code> and
     be aware of the OSGi environment.
     </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
     You still need to add the proper package imports to your Spring-MVC application - the WAR is still a bundle 
     after all which means without the proper manifest entries, it will have an invalid class path and will not be able to work properly.
     </td></tr></table></div><p>
     </p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="compendium"></a>Chapter&nbsp;10.&nbsp;Compendium Services</h2></div></div></div><p>The OSGi Service Platform Service Compendium specification defines a
    number of additional services that may be supported by OSGi
    implementations. Spring Dynamic Modules supports an additional
    "compendium" namespace that provides integration with some of these services.
    By convention, the prefix <code class="literal">osgix</code> is used for this
    namespace:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans:beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:</span><span class="co"><img src="images/callouts/1.png" alt="(1)"></span><span class="hl-attribute">osgix</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi-compendium"</span>                      <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
   <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi  
       	http://www.springframework.org/schema/osgi/spring-osgi.xsd
     http://www.springframework.org/schema/osgi-compendium</span>                                    <span class="co"><img src="images/callouts/2.png" alt="(2)"></span><span class="hl-value">
       	http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd</span>       <span class="co"><img src="images/callouts/3.png" alt="(3)"></span><span class="hl-value">
     http://www.springframework.org/schema/beans   
       	http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;

   &lt;<span class="hl-comment">!-- use the OSGi namespace elements directly --</span>&gt;
   &lt;<span class="hl-tag">service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleServiceOsgi"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"simpleService"</span>
       <span class="hl-attribute">interface</span>=<span class="hl-value">"org.xyz.MyService"</span> /&gt;

   &lt;<span class="hl-comment">!-- qualify compendium namespace elements --</span>&gt;
   &lt;<span class="hl-tag">osgix:cm-properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cm"</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"com.xyz.myapp"</span>/&gt;

&lt;<span class="hl-tag">/beans:beans</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Compendium namespace declaration (bound to <code class="literal">osgix</code> prefix)</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Schema location (namespace URI)</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>XML schema to use for the compendium namespace</p></td></tr></table></div></div><p>At present this namespace provides support for the Configuration
    Admin service. Support for other compendium services may be added in
    future releases.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="compendium:cm"></a>10.1.&nbsp;Configuration Admin</h2></div></div></div><p>One of the most important compendium services, is the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/javadoc/r4v401/org/osgi/service/cm/package-summary.html" target="_top">Configuration Admin</a>
	  which, as a name implies, provides configuration to interested bundles through the OSGi service registry. Spring DM provides dedicated support
	  for Configuration Admin (CM), allowing consumption and injection of the configuration data in a declarative way.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="compendium:cm:props"></a>10.1.1.&nbsp;Exposing Configuration Admin Entries As <code class="classname">Properties</code></h3></div></div></div><p>In its simplest form, the CM can be seen as a configuration source, namely a <code class="classname">Dictionary</code> whose
        keys are always <code class="classname">String</code>s. Spring DM can expose entries in the CM as a <code class="classname">Properties</code> object,
        through the <code class="literal">cm-properties</code> element. A minimal declaration looks as follows:</p><pre class="programlisting">&lt;<span class="hl-tag">osgix:cm-properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ds.cfg"</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"data.source.office.1"</span>/&gt;</pre><p>The configuration above, exposes the properties available in the CM under <span class="emphasis"><em>data.source.office.1</em></span> entry as a bean named
        <span class="emphasis"><em>ds.cfg</em></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">persistent-id</code> attribute must refer to the
        persistent-id of an OSGi <code class="interfacename">ManagedService</code>, it is a
        configuration error to specify a factory persistent id referring to a
        <code class="interfacename">ManagedServiceFactory</code>.</p></td></tr></table></div><p>Those familiar with Spring's 
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/xsd-config.html#xsd-config-body-schemas-util" target="_top">util namespace</a> will
        find <code class="literal">&lt;osgi:cm-properties/&gt;</code> element similar to <code class="literal">&lt;util:properties/&gt;</code>.</p><p>It is possible to specify a default set of property values to be used in the event that the configuration dictionary does not contain
        an entry for a given key. The declaration is similar to the <code class="literal">props</code> element inside the Spring beans namespace:</p><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans:beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi-compendium"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:osgix</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi-compendium"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
      http://www.springframework.org/schema/beans 
        http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/osgi-compendium 
        http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd"</span>&gt;

   &lt;<span class="hl-tag">osgix:cm-properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cfg.with.defaults"</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"data.source.office.2"</span>&gt;
      &lt;<span class="hl-tag">beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"host"</span>&gt;localhost&lt;<span class="hl-tag">/beans:prop</span>&gt;
      &lt;<span class="hl-tag">beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"port"</span>&gt;3306&lt;<span class="hl-tag">/beans:prop</span>&gt;
   &lt;<span class="hl-tag">/osgix:cm-properties</span>&gt;

&lt;<span class="hl-tag">/beans:beans</span>&gt;</pre><p>By default, the properties found in the Configuration Admin entry will override the local properties. Thus, for the previous example, if the 
		<code class="literal">data.source.office.2</code> configuration contains a <span class="emphasis"><em>host</em></span> entry, its value will override the locally defined
		<code class="literal">localhost</code>. For cases where this behaviour is undesired, the attribute <code class="literal">local-override</code> 
		(default <code class="literal">false</code>) allows one to revert the merging algorithm, forcing the local properties to override the entries in the CM.</p><p>Since <code class="literal">cm-properties</code> exposes the CM entries as <code class="classname">Properties</code>, it can be used with Spring's <code class="classname">
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html#beans-factory-placeholderconfigurer" target="_top">PropertyPlaceholderConfigurer</a></code> 
		and <code class="classname"><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/beans.html#beans-factory-overrideconfigurer" target="_top">PropertyOverrideConfigurer</a></code> 
		to externalize and customize environment-specific properties:</p><pre class="programlisting">&lt;<span class="hl-tag">?xml version="1.0" encoding="UTF-8"?</span>&gt;
&lt;<span class="hl-tag">beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:osgix</span>=<span class="hl-value">"http://www.springframework.org/schema/osgi-compendium"</span>
   <span class="hl-attribute">xmlns:ctx</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
	http://www.springframework.org/schema/beans 
	  http://www.springframework.org/schema/beans/spring-beans.xsd
	http://www.springframework.org/schema/context 
	  http://www.springframework.org/schema/context/spring-context.xsd
	http://www.springframework.org/schema/osgi-compendium 
	  http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd"</span>&gt;

   &lt;<span class="hl-comment">!-- Configuration Admin entry --</span>&gt;
   &lt;<span class="hl-tag">osgix:cm-properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cmProps"</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"com.xyz.myapp"</span>&gt;
      &lt;<span class="hl-tag">prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"host"</span>&gt;localhost&lt;<span class="hl-tag">/prop</span>&gt;
   &lt;<span class="hl-tag">/osgix:cm-properties</span>&gt;

   &lt;<span class="hl-comment">!-- placeholder configurer --</span>&gt;
   &lt;<span class="hl-tag">ctx:property-placeholder</span> <span class="hl-attribute">properties-ref</span>=<span class="hl-value">"cmProps"</span> /&gt;

   &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">...&gt;</span>
      <span class="hl-attribute">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${host}"</span>/&gt;
      &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${timeout}"</span>/&gt;
   &lt;<span class="hl-tag">/bean</span>&gt;
	
&lt;<span class="hl-tag">/beans</span>&gt;</pre><p>An important aspect of <code class="literal">cm-properties</code> is does <span class="emphasis"><em>not</em></span> reflect
        any that any subsequent changes made to the entry it represents, made through the Configuration Admin API.
        That is, once resolved, the <code class="literal">cm-properties</code> content remains the same, regardless of any updates
        made the to CM entry it represents.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="compendium:cm:managed-properties"></a>10.1.2.&nbsp;Managed Properties</h3></div></div></div><p>Based on a configuration admin entry, Spring DM can autowire by name, the properties of a given bean. To use this feature, define
	  	a nested <code class="literal">managed-properties</code> inside the bean definition:</p><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"managedComponent"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MessageTank"</span>&gt;
   &lt;<span class="hl-tag">osgix:managed-properties</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"com.xyz.messageservice"</span>/&gt; 
&lt;<span class="hl-tag">/bean</span>&gt;</pre><p>For each key in the dictionary stored by Configuration Admin under the given persistent id, 
		if the bean type has a property with a matching name (following JavaBeans conventions), 
		then that component property will be dependency injected with the value stored in Configuration Admin under the key. 
		If the definition of <code class="classname">SomeClass</code> from the example above is as follows:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MessageTank {
  <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> amount;
  <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getAmount() { <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.amount; }
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAmount(<span class="hl-keyword">int</span> amount) { <span class="hl-keyword">this</span>.amount = amount; }
}</pre><p>and the configuration dictionary stored under the pid <code class="literal">com.xyz.messageservice</code> contains an entry 
		<code class="literal">amount=200</code>, then the <code class="literal">setAmount</code> method will be invoked on the bean 
		instance during configuration, passing in the value <code class="literal">200</code>.</p><p>If a property value is defined both in the configuration dictionary stored in the Configuration Admin service and in a 
		property element declaration nested in the component element, then the value from Configuration Admin takes precedence:</p><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"managedComponent"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MessageTank"</span>&gt;
   &lt;<span class="hl-tag">osgix:managed-properties</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"com.xyz.messageservice"</span>/&gt;
   &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"amount"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span>/&gt;
   &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threshold"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"500"</span>/&gt; 
&lt;<span class="hl-tag">/bean</span>&gt;</pre><p>Property values specified via property elements can therefore be treated as default values to be used if none is available through 
		Configuration Admin.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/admons/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">Do not share the same <span class="emphasis"><em>persistent-id</em></span> (PID) between multiple bundles or definitions, as <span class="emphasis"><em>only one</em></span>
		of them will receive notifications. <code class="literal">managed-properties</code> relies on <code class="literal">org.osgi.service.cm.ManagedService</code>
		contract which mandates that each <code class="literal">ManagedService</code> instance must be identified with its own unique PID.
		Please see the Configuration Admin spec, specifically section 104.3 and 104.5</td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="compendium:cm:managed-properties:update"></a>10.1.2.1.&nbsp;Configuration Admin Runtime Updates</h4></div></div></div><p>A powerful feature of Configuration Admin is the ability to update (or delete) entries at runtime. That is, the configuration data 
			stored in Configuration Admin may be updated after the bean has been created. By default, any post-creation updates will be ignored. However,
			one can configure <code class="literal">managed-properties</code> element to receive configuration updates through the <code class="literal">update-strategy</code>
			attribute, which can have a value of either <code class="literal">bean-managed</code> or <code class="literal">container-managed</code>.</p><p><code class="literal">bean-managed</code> strategy will pass all the updates made to the configuration to a callback present on the bean, specified
			through the <code class="literal">update-method</code> attribute (which becomes required). The update method must have one of the following signatures:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(Map properties)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anyMethodName(Map&lt;String,?&gt; properties); <span class="hl-comment">// for Java 5</span></pre><p>In contrast, the <code class="literal">container-managed</code> update strategy will re-inject bean properties by name based on the new properties 
		    received in the update. For <code class="literal">container-managed</code> updates, the component class must provide setter methods for the component properties 
		    that it wishes to have updated. Consider the following class definitions:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContainerManagedBean {
  <span class="hl-comment">// will be reinjected (since it has a setter)</span>
  <span class="hl-keyword">private</span> Integer integer;
  <span class="hl-comment">// will not be reinjected (no setter present)</span>
  <span class="hl-keyword">private</span> Long waitTime; 
  
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setInteger(Integer integer) { <span class="hl-keyword">this</span>.integer = integer; }
}


<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SelfManagedBean {
  
  <span class="hl-comment">// update callback</span>
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> updateCallback(Map properties) {
	System.out.println(<span class="hl-string">"Received properties "</span> + properties);
	System.out.println(<span class="hl-string">"Props can be used as a Dictionary "</span> + (Dictionary) properties);
	<span class="hl-comment">// do more work ... </span>
  }
}</pre><p>and configuraton:</p><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"containerManaged"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ContainerManagedBean"</span>&gt;
   &lt;<span class="hl-tag">osgix:managed-properties</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"labX"</span> <span class="hl-attribute">update-strategy</span>=<span class="hl-value">"container-managed"</span>/&gt;
   &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"integer"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"23"</span>/&gt;
&lt;<span class="hl-tag">/bean</span>&gt;
	
&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beanManaged"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SelfManagedBean"</span>&gt;
   &lt;<span class="hl-tag">osgix:managed-properties</span> <span class="hl-attribute">persistent-id</span>=<span class="hl-value">"labY"</span> <span class="hl-attribute">update-strategy</span>=<span class="hl-value">"bean-managed"</span> <span class="hl-attribute">update-method</span>=<span class="hl-value">"updateCallback"</span>/&gt;
&lt;<span class="hl-tag">/bean</span>&gt;</pre><p>Any updates made to the CM entry <code class="literal">labX</code> will be automatically reinjected on existing instances of 
		    <code class="literal">containerManaged</code> bean while the <code class="literal">labY</code> updates will be passed to <code class="methodname">updateCallback</code>
		    method.</p><p>The update options are summarized in the table below:</p><div class="table"><a name="compendium-cm-managed-properties-options"></a><p class="title"><b>Table&nbsp;10.1.&nbsp;Managed Properties Update Options</b></p><div class="table-contents"><table summary="Managed Properties Update Options" width="100%" border="1"><colgroup><col><col><col></colgroup><thead><tr><th><code class="literal">update-strategy</code></th><th><code class="literal">update-method</code></th><th>Behaviour</th></tr></thead><tbody><tr><td><code class="literal">container-managed</code></td><td><span class="emphasis"><em>ignored</em></span></td><td>Reinjects the bean properties, using the properties present in the update. The re-injection will be applied while locking (through
	              	  a <code class="literal">synchronized</code> instruction) the bean instance. If the locking or re-injection strategy is not suitable, consider using
	              	  the <code class="literal">bean-managed</code> approach.</td></tr><tr><td><code class="literal">bean-managed</code></td><td><span class="emphasis"><em>required</em></span></td><td>Invokes the <code class="literal">update-method</code> callback on the bean instance, passing the updated configuration (as a 
	              	  <code class="interfacename">Map</code> object that can be safely cast to a <code class="classname">Dictionary</code> if needed). No locking is
	              	  performed.</td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="compendium:cm:managed-service-factories"></a>10.1.3.&nbsp;Managed Service Factories</h3></div></div></div><p>The Configuration Admin service supports a notion of a <span class="emphasis"><em>managed service factory</em></span>(see section 104.6 in the Compendium Specification). 
	  	A managed service factory is identified by a factory pid which allows <span class="emphasis"><em>multiple</em></span> <code class="interfacename">Configuration</code> objects 
	  	to be associated with the factory. <code class="interfacename">Configuration</code> objects associated with the factory can be added or removed at any point.
	  	The main intent of a factory is to create an OSGi service for each configuration: adding a new <code class="interfacename">Configuration</code> entry results
	  	in a new OSGi service being registered, removing a <code class="interfacename">Configuration</code>, unregisters the service.
		Spring DM provides support for the <span class="emphasis"><em>managed service factory</em></span> concept through the <code class="literal">managed-service-factory</code> element. Once
		defined, the configuration associated with the factory pid will automatically create (or remove) bean instances which will be registered (or unregistered)
		in the OSGi space based on a <span class="emphasis"><em>template</em></span> bean definition and the CM configuration.</p><p>This might sound more complicated then it actually is, so let's look at a simplistic example:</p><div class="programlistingco"><pre class="programlisting">&lt;osgix:managed-service-factory id=<span class="hl-string">"simple-msf"</span> 
   factory-pid=<span class="hl-string">"com.xyz.messageservice"</span>                                                            <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
   auto-export=<span class="hl-string">"all-classes"</span>&gt;                                                                      <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
	
   &lt;bean <span class="hl-keyword">class</span>=<span class="hl-string">"com.xyz.MessageTank"</span>/&gt;                                                             <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
&lt;/osgix:managed-service-factory&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>factory persistent id (pid)</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>Shortcut flag used to determine under what interfaces the OSGi service is published (more info below)</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>bean definition <span class="emphasis"><em>template</em></span>. For each detected configuration, a new service will be created using
					the bean definition template.</p></td></tr></table></div></div><p>In its simplest form, the <code class="literal">managed-service-factory</code> requires the <span class="emphasis"><em>factory pid</em></span>, a <span class="emphasis"><em>bean definition</em></span>
		used as a template and some information on how possible bean instances are published as services. Basically, the definition above instructs Spring DM to
		to monitor the given factory pid (through a dedicated <code class="interfacename">ManagedServiceFactory</code> implementation (see the Compendium Spec for 
		more info)) and for every <code class="interfacename">Configuration</code> object associated with the factory pid, to create a new, anonymous instance of 
		the nested bean declared and export that instance as an OSGi service. The lifecycle of these beans instances is tied to the lifecycle of the 
		associated <code class="interfacename">Configuration</code> objects. If a new configuration is added, a new bean is created and exported.
		If a configuration object is deleted or disassociated from the factory pid then the corresponding bean instance is destroyed.</p><p>In many regards, <code class="literal">managed-service-factory</code> acts as a specialized service exporter, similar to the 
		<a href="#service-registry:export" title="7.1.&nbsp;Exporting A Spring Bean As An OSGi Service"><code class="literal">service</code></a> element but supporting the concept of 
		<a href="#compendium:cm:managed-properties" title="10.1.2.&nbsp;Managed Properties">managed properties</a>. In fact, many of
		<code class="literal">service</code>'s attributes that indicate how a bean is exported, are found in <code class="literal">managed-service-factory</code> (as you saw in the
		previous example with <code class="literal">auto-export</code>) as are the <code class="literal">managed-properties</code> attributes.</p><p>The list of attributes can be found below:</p><div class="table"><a name="compendium-cm-msf-options"></a><p class="title"><b>Table&nbsp;10.2.&nbsp;Managed Service Factory Options</b></p><div class="table-contents"><table summary="Managed Service Factory Options" width="100%" border="1"><colgroup><col><col><col><col><col><col></colgroup><thead><tr><th align="center">Name</th><th colspan="4" align="center">Values</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">interface</td><td colspan="4" align="center">fully qualified class name (such as <code class="classname">java.lang.Thread</code>)</td><td align="center">the fully qualified name of the class under which the object will be exported</td></tr><tr><td align="center">context-class-loader</td><td colspan="2" align="center">unmanaged</td><td colspan="2" align="center">service-provider</td><td align="center">Defines how the context class loader will be managed when an operation is invoked on the 
                  exported service. The default value is <code class="literal">unmanaged</code> which means that no management of 
                  the context class loader is attempted. A value of <code class="literal">service-provider</code> guarantees that
                  the context class loader will have visibility of all the resources on the class path of 
                  bundle exporting the service.</td></tr><tr><td align="center">auto-export</td><td align="center">disabled <code class="literal">(default)</code></td><td align="center">interfaces</td><td align="center">class-hierarchy</td><td align="center">all-classes</td><td align="center">Enables Spring to automatically manage the set of service interfaces advertised for the
				  service. By default this facility is <code class="literal">disabled</code>. A value of <code class="literal">interfaces</code> advertises all 
                  of the Java interfaces supported by the exported service. A value of <code class="literal">class-hierarchy</code> 
                  advertises all the Java classes in the hierarchy of the exported service. A value of 
                  <code class="literal">all-classes</code> advertises all Java interfaces and classes.</td></tr><tr><td align="center">update-strategy</td><td align="center">none <code class="literal">(default)</code></td><td align="center">bean-managed</td><td colspan="2" align="center">container-managed</td><td align="center">Defines the update strategy for configuration modifications made after the associated beans have been created.</td></tr></tbody></table></div></div><br class="table-break"><p>Similar to the <code class="literal">service</code> element, a list of interfaces or/and registration listeners can be declared to be notified when a 
		service is being registered/unregistered. For more information on the semantics, please see <a href="#service-registry:export:intfs" title="7.1.1.&nbsp;Controlling The Set Of Advertised Service Interfaces For An Exported Service">Section&nbsp;7.1.1, &#8220;Controlling The Set Of Advertised Service Interfaces For
        An Exported Service&#8221;</a> and 
		<a href="#service-registry:export:lifecycle" title="7.1.7.&nbsp;Service Registration And Unregistration Lifecycle">Section&nbsp;7.1.7, &#8220;Service Registration And Unregistration Lifecycle&#8221;</a> chapters.</p><p>Now that the <code class="literal">managed-service-factory</code> options have been explained, let's look at a more complex configuration:</p><div class="programlistingco"><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueTracker"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.xyz.queue.QueueTracker"</span>/&gt;
			
&lt;<span class="hl-tag">osgix:managed-service-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"data-msf"</span> 
   <span class="hl-attribute">factory-pid</span>=<span class="hl-value">"org.xyz.labX"</span>                                                                      <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
   <span class="hl-attribute">update-strategy</span>=<span class="hl-value">"bean-managed"</span>                                                                  <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
   <span class="hl-attribute">update-method</span>=<span class="hl-value">"refresh"</span>&gt;                                                                        <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
   &lt;<span class="hl-tag">osgix:interfaces</span>&gt;
       &lt;<span class="hl-tag">value</span>&gt;java.util.Collection&lt;<span class="hl-tag">/value</span>&gt;                                                         <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
       &lt;<span class="hl-tag">value</span>&gt;java.util.Queue&lt;<span class="hl-tag">/value</span>&gt;                                                              <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
   &lt;<span class="hl-tag">/osgix:interfaces</span>&gt;
   &lt;<span class="hl-tag">osgix:registration-listener</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queueTracker"</span>                                                 <span class="co"><img src="images/callouts/5.png" alt="(5)"></span>
       <span class="hl-attribute">registration-method</span>=<span class="hl-value">"track"</span>                                                                 <span class="co"><img src="images/callouts/6.png" alt="(6)"></span>
       <span class="hl-attribute">unregistration-method</span>=<span class="hl-value">"untrack"</span>/&gt;                                                           <span class="co"><img src="images/callouts/7.png" alt="(7)"></span>
		
   &lt;<span class="hl-tag">bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.ResizableQueue"</span>&gt;                                                           <span class="co"><img src="images/callouts/8.png" alt="(8)"></span>
       &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"size"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span>/&gt;
       &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"concurrency"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span>/&gt;
       &lt;<span class="hl-tag">property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fair"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span>/&gt;
   &lt;<span class="hl-tag">/bean</span>&gt;
&lt;<span class="hl-tag">/osgix:managed-service-factory</span>&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p><code class="interfacename">ManagedServiceFactory</code> factory persistent id</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>how should Spring DM behave when a <code class="interfacename">Configuration</code> is updated</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>the method to invoke when for <code class="literal">bean-managed</code> updates</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>the interfaces under which the nested beans are published as OSGi services</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/5.png" alt="5" border="0"></td><td valign="top" align="left"><p>listener notified when a service (based on the CM <code class="interfacename">Configuration</code>) is registered/unregistered</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/6.png" alt="6" border="0"></td><td valign="top" align="left"><p>custom (optional) service registration method</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/7.png" alt="7" border="0"></td><td valign="top" align="left"><p>custom (optional) service unregistration method</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/8.png" alt="8" border="0"></td><td valign="top" align="left"><p>bean definition template</p></td></tr></table></div></div><p>The example above, creates a imaginary <code class="classname">ResizeableQueue</code> instance for each <code class="interfacename">Configuration</code> entry
		present under the <code class="literal">org.xyz.labX</code> factory pid. Each instance has default values assigned to <code class="literal">size</code>, <code class="literal">concurrency</code>
		and <code class="literal">fair</code> parameters. However, just like <code class="literal">managed-properties</code>, during the bean creation, the values received from the 
		Configuration Admin will be injected by name, possibly overriding existing settings. Once created and configured, each nested, anonymous bean instance
		is registered as an OSGi service under the <code class="interfacename">java.util.Collection</code> and <code class="interfacename">java.util.Queue</code> 
		interfaces. The OSGi service lifecycle is monitored by a registration listener, namely the bean <code class="literal">queueTracker</code>.
		Finally, due to the specified <code class="literal">update-strategy</code>, any updates executed to each CM configuration will cause the 
		<code class="methodname">refresh</code> callback to be invoked on the associated bean instance.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="compendium:cm:dict"></a>10.1.4.&nbsp;Direct Access To Configuration Data</h3></div></div></div><p>The simplest way to work directly with the configuration data stored under a given persistent id or factory persistent id, 
        is to register a service that implements either the <code class="interfacename">ManagedService</code> or <code class="interfacename">ManagedServiceFactory</code>
        interface and specify the pid that you are interested in as a service property (for more information, see the Configuration Admin chapter
        in the OSGi compendium spec). For example:</p><pre class="programlisting">&lt;<span class="hl-tag">osgi:service</span> <span class="hl-attribute">interface</span>=<span class="hl-value">"org.osgi.service.cm.ManagedService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myManagedService"</span>&gt;
   &lt;<span class="hl-tag">osgi:service-properties</span>&gt;
     &lt;<span class="hl-tag">entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"service.pid"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"my.managed.service.pid"</span>/&gt;
   &lt;<span class="hl-tag">/osgi:service-properties</span>&gt;
&lt;<span class="hl-tag">/osgi:service</span>&gt;

&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myManagedService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.MyManagedService"</span>/&gt;</pre></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="testing"></a>Chapter&nbsp;11.&nbsp;Testing OSGi based Applications</h2></div></div></div><p>By following best practices and using the Spring Dynamic Modules
    support, your bean classes should be easy to unit test as they will have
    no hard dependencies on OSGi, and the few OSGi APIs that you may interact
    with (such as <code class="interfacename">BundleContext</code>) are interface-based 
    and easy to mock. Whether you want to do unit testing or <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Integration_testing" target="_top">
    integration</a> testing, Spring DM can ease your task.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing:mocks"></a>11.1.&nbsp;OSGi Mocks</h2></div></div></div><div class="sidebar"><p class="title"><b>Mocks vs Stubs</b></p><p>There are various strategies to unit test code
     that requires collaborators. The two most popular strategies
     are <span class="emphasis"><em>stubs</em></span> and <span class="emphasis"><em>mocks</em></span>.
     </p><p>
     See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://martinfowler.com/articles/mocksArentStubs.html" target="_top">
     this</a> article by Martin Fowler which describes in detail the difference 
     between them.</p></div><p>
    Even though most OSGi API are interfaces and creating mocks using a specialized
    library like <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.easymock.org/" target="_top">EasyMock</a> is fairly
    simple, in practice the amount of code of setting the code (especially on JDK 1.4)
    becomes cumbersome. To keep the tests short and concise, Spring DM provides OSGi
    mocks under <code class="literal">org.springframework.osgi.mock</code> package.</p><p>It's up to you to decide whether they are useful or not however, we make extensive
    use of them inside Spring DM test suite. Below you can find a code snippet that you
    are likely to encounter in our code base:</p><pre class="programlisting"><span class="hl-keyword">private</span> ServiceReference reference;
<span class="hl-keyword">private</span> BundleContext bundleContext;
<span class="hl-keyword">private</span> Object service;
    
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> setUp() <span class="hl-keyword">throws</span> Exception {
	reference = <span class="hl-keyword">new</span> MockServiceReference();
	bundleContext = <span class="hl-keyword">new</span> MockBundleContext() {

		<span class="hl-keyword">public</span> ServiceReference getServiceReference(String clazz) {
			<span class="hl-keyword">return</span> reference;
		}

		<span class="hl-keyword">public</span> ServiceReference[] getServiceReferences(String clazz, String filter) 
				<span class="hl-keyword">throws</span> InvalidSyntaxException {
			<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ServiceReference[] { reference };
		}
		
		<span class="hl-keyword">public</span> Object getService(ServiceReference ref) {
		    <span class="hl-keyword">if</span> (reference == ref)
		       <span class="hl-keyword">return</span> service;
		    <span class="hl-keyword">super</span>.getService(ref);
		}
	};

	...
}
	
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testComponent() <span class="hl-keyword">throws</span> Exception {
    OsgiComponent comp = <span class="hl-keyword">new</span> OsgiComponent(bundleContext);
    
    assertSame(reference, comp.getReference());
    assertSame(object, comp.getTarget());
}</pre><p>As ending words, experiment with them and choose whatever style or library you feel most confortable with.
    In our test suite we use the aforementioned mocks, EasyMock library and plenty of integration testing (see below).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing:integration"></a>11.2.&nbsp;Integration Testing</h2></div></div></div><div class="sidebar"><p class="title"><b>What about JUnit4/TestNG?</b></p><p>While JUnit4/TestNG overcome the class inheritance
     problem that appears when building base JUnit classes, by decoupling
     the runner from the test through annotations, Spring DM cannot use
     them since it has to support Java 1.4.</p><p>However, it is planned for the future to provide an optional,
     JVM 5-based testing extension to integrate the existing testing framework
     with the aforementioned libraries.
     </p></div><p>In a restricted environment such as OSGi, it's important to test the visibility and versioning of your classes, 
    the manifests or how your bundles interact with each other (just to name a few).</p><p> To ease integration testing, the Spring Dynamic Modules project provides a test class hierarchy
    (based on <code class="classname">org.springframework.osgi.test.AbstractOsgiTests</code>) that
    provides support for writing regular <code class="literal">JUnit</code> test cases that are then
    automatically executed in an OSGi environment.</p><p>In general, the scenario supported by Spring DM testing framework is:</p><div class="itemizedlist"><ul type="disc"><li><p>start the OSGi framework (Equinox, Knopflerfish, Felix)</p></li><li><p>install and start any specified bundles required for the
        test</p></li><li><p>package the test case itself into a <code class="literal">on the fly</code> bundle,
        generate the manifest (if none is provided) and install it in the OSGi 
        framework</p></li><li><p>execute the test case inside the OSGi framework</p></li><li><p>shut down the framework</p></li><li><p>passes the test results back to the originating test case
        instance that is running outside of OSGi</p></li></ul></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/admons/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">The testing framework is aimed at running OSGi integration tests from a non-OSGi environment (like Ant/Maven/IDE). The testing framework
	is NOT meant to be used as an OSGi bundle (nor will it work for that matter). In practice this means that the testing bundle should be separate from the bundle(s) it
	tests (similar to unit testing, where tests are separate from the classes they test).</td></tr></table></div><p>By following this sequence it is trivial to write JUnit-based
    integration tests for OSGi and have them integration into any environment
    (IDE, build (ant, maven), etc.) that can work with JUnit.</p><p>The rest of this chapter details (with examples) the features
    offered by Spring DM testing suite.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:simple-test"></a>11.2.1.&nbsp;Creating A Simple OSGi Integration Test</h3></div></div></div><p>
      While the testing framework contains several classes that offer specific
      features, it is most likely that your test cases will extend
      <code class="classname">org.springframework.osgi.test.AbstractConfigurableBundleCreatorTests</code> (at least
      this is what we use in practice).
      </p><p>Let's extend this class and interact with the OSGi platform through
      the <code class="literal">bundleContext</code> field:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleOsgiTest <span class="hl-keyword">extends</span> AbstractConfigurableBundleCreatorTests {

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testOsgiPlatformStarts() <span class="hl-keyword">throws</span> Exception {
	System.out.println(bundleContext.getProperty(Constants.FRAMEWORK_VENDOR));
	System.out.println(bundleContext.getProperty(Constants.FRAMEWORK_VERSION));
	System.out.println(bundleContext.getProperty(Constants.FRAMEWORK_EXECUTIONENVIRONMENT));
	}
}</pre><p>Simply execute the test as you normally do with any JUnit test. On Equinox 3.2.x,
    the output is similar to:</p><pre class="programlisting">Eclipse
1.3.0
OSGi/Minimum-1.0,OSGi/Minimum-1.1,JRE-1.1,J2SE-1.2,J2SE-1.3,J2SE-1.4}</pre><p class="remark"><i><span class="remark">It is likely that you will see different log statements made by the testing
    framework during your own test execution, but these can be disabled as they only have an informative
    value and do not affect the actual execution.</span></i></p><p>Note that you did not have to create any bundle, write any MANIFEST or
    bother with imports or exports, let alone starting and shutting down the OSGi
    platform. The testing framework takes care of these automatically
    when the test is executed.</p><p>Let's do some quering and figure out what the environment in which the tests run is.
    A simple way to do that is to query the <code class="interfacename">BundleContext</code>
    for the installed bundles:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testOsgiEnvironment() <span class="hl-keyword">throws</span> Exception {
	Bundle[] bundles = bundleContext.getBundles();
	<span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = 0; i &lt; bundles.length; i++) {
		System.out.print(OsgiStringUtils.nullSafeName(bundles[i]));
		System.out.print(<span class="hl-string">", "</span>);
	}
	System.out.println();
}</pre><p>The output should be similar to:</p><pre class="programlisting">OSGi System Bundle, ObjectWeb ASM, log4j.osgi, spring-test, spring-osgi-test, spring-osgi-core, 
    spring-aop, spring-osgi-io, slf4j-api, 
spring-osgi-extender, etc... TestBundle-testOsgiPlatformStarts-com.your.package.SimpleOsgiTest, 
</pre><p>As you can see, the testing framework installs the mandatory requirements required for running the 
    test such as the Spring, Spring DM, slf4j jars among others.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:provisioning"></a>11.2.2.&nbsp;Installing Test Prerequisites</h3></div></div></div><div class="sidebar"><p class="title"><b>OSGi-friendly libraries</b></p><p>To work in OSGi environments, jars need to declare in their
       <code class="literal">MANIFEST.MF</code>, Export or Import packages; that is
       declare what classes they need or offer to other bundles.
       Most libraries are OSGi unaware and do not provide the proper manifest
       entries which means they are unusable in an OSGi environment.</p><p>At the moment, there are several initiatives in the open source space
       to provide the proper manifest - please see the FAQ for more information.
       </p></div><p>Besides the Spring DM jars and the test itself is highly likely that you depend on 
     several libraries or your own code for the integration test.</p><p>Consider the following test that relies on Apache Commons 
     <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://commons.apache.org/lang/" target="_top">Lang</a>:</p><pre class="programlisting"><span class="hl-keyword">import</span> org.apache.commons.lang.time.DateFormatUtils;
    ...
  	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testCommonsLangDateFormat() <span class="hl-keyword">throws</span> Exception {
		System.out.println(DateFormatUtils.format(<span class="hl-keyword">new</span> Date(), <span class="hl-string">"HH:mm:ssZZ"</span>));
	}
}</pre><p>Running the test however yields an exception:</p><pre class="programlisting">java.lang.IllegalStateException: Unable to dynamically start generated unit test bundle
     ...
Caused by: org.osgi.framework.BundleException: The bundle could not be resolved. 
Reason: Missing Constraint: Import-Package: org.apache.commons.lang.time; version="0.0.0"
    ...
	... 15 more
	</pre><p>The test requires <code class="literal">org.apache.commons.lang.time</code> package but there is no bundle
     that exports it. Let's fix this by installing a commons-lang bundle (make sure you use at least version 2.4
     which adds the proper OSGi entries to the jar manifest).</p><p>One can specify the bundles that she wants
     to be installed using <code class="literal">getTestBundlesNames</code> or <code class="literal">getTestBundles
     </code> method. The first one returns an array of String that indicate the bundle
     name, package and versioning through as a String while the latter returns an array of
     <code class="literal">Resource</code>s that can be used directly for installing the bundles.
     That is, use <code class="literal">getTestBundlesNames</code> when you rely on somebody else to locate
     (the most common case) the bundles and <code class="literal">getTestBundles</code> when you want to 
     locate the bundles yourself.
     </p><p>By default, the test suite performs a lookup for artifacts, similar to the one used by 
     <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://maven.apache.org" target="_top">Maven2</a>, searching first the items as being relative to the 
     current project and then falling back to the local repository. 
     The locator expects the bundle String to be a comma separated values containing the artifact group, name, version and (optionally) type.
     
     It's likely that in the future, various other locators will be available. One can plug in their own 
     locator through the <code class="interfacename">org.springframework.osgi.test.provisioning.ArtifactLocator</code> interface.
     </p><p>Let's fix our integration test by installing the required bundle (and some extra osgi libraries):</p><pre class="programlisting"><span class="hl-keyword">protected</span> String[] getTestBundlesNames() {
	 <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] { <span class="hl-string">"net.sourceforge.cglib, com.springsource.net.sf.cglib, 2.1.3"</span>,
	 	<span class="hl-string">"javax.transaction, com.springsource.javax.transaction, 1.1.0"</span>,
	 	<span class="hl-string">"commons-lang, commons-lang, 2.4"</span> };
	 };
}</pre><p>Rerunning the test should show that these bundles are now installed in the OSGi platform.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">The artifacts mentioned above have to exist in your local maven repository.</td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:advanced-topics"></a>11.2.3.&nbsp;Advanced Testing Framework Topics</h3></div></div></div><p>The testing framework allows a lot of customization to be made. This chapter
      details some of the existing hooks that you might want to know about. However, these
      are advanced topics as they increase the complexity of your test infrastructure.
      </p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="testing:integration:customize-manifest"></a>11.2.3.1.&nbsp;Customizing The Test Manifest</h4></div></div></div><p>There are cases where the auto-generated test manifest does not suite the needs of the test.
      For example the manifest requires some different headers or a certain package needs to be an optional import.</p><p>
      For simple cases, one can work directly with the generated manifest - in the example below, the bundle class path
      is being specified:
      </p><pre class="programlisting"><span class="hl-keyword">protected</span> Manifest getManifest() {
      <span class="hl-comment">// let the testing framework create/load the manifest</span>
      Manifest mf = <span class="hl-keyword">super</span>.getManifest();
      <span class="hl-comment">// add Bundle-Classpath:</span>
      mf.getMainAttributes().putValue(Constants.BUNDLE_CLASSPATH, <span class="hl-string">".,bundleclasspath/simple.jar"</span>);
      <span class="hl-keyword">return</span> mf;
}</pre><p>      
      Another alternative is to provide your own manifest by overriding <code class="literal">getManifestLocations()</code>:</p><pre class="programlisting"><span class="hl-keyword">protected</span> String getManifestLocation() {
      <span class="hl-keyword">return</span> <span class="hl-string">"classpath:com/xyz/abc/test/MyTestTest.MF"</span>;
}</pre><p>However each manifest needs the following entry:</p>&#8220;<span class="quote">Bundle-Activator: org.springframework.osgi.test.JUnitTestActivator</span>&#8221;<p>since without it, the testing infrastructure cannot function properly. Also, one needs to 
	  import JUnit, Spring and Spring DM specific packages used by the base test suite:</p><pre class="programlisting">Import-Package: junit.framework,
  org.osgi.framework,
  org.apache.commons.logging,
  org.springframework.util,
  org.springframework.osgi.service,
  org.springframework.osgi.util,
  org.springframework.osgi.test,
  org.springframework.context</pre><p>Failing to import a package used by the test class will cause the test to fail with a 
	  <code class="literal">NoDefClassFoundError</code> error.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="testing:integration:specify-test-jar-content"></a>11.2.3.2.&nbsp;Customizing Test Bundle Content</h4></div></div></div><p>By default, for the on-the-fly bundle, the testing infrastructure uses all the classes, xml and properties files
      found under <code class="literal">./target/test-classes</code> folder. This matches the project layout for maven which is used 
      (at the moment by Spring DM). These settings can be configured in two ways:</p><div class="orderedlist"><ol type="1"><li><p>programmatically by overriding <code class="classname">AbstractConfigurableBundleCreatorTests</code> <code class="literal">getXXX</code>
         methods.</p></li><li><p>declaratively by creating a properties file having a similar name with the test case. For example, test
        <code class="literal">com.xyz.MyTest</code> will have the properties file named <code class="literal">com/xyz/MyTest-bundle.properties</code>.
        If found, the following properties will be read from the file:</p><div class="table"><a name="integration-test-jar-setting-file"></a><p class="title"><b>Table&nbsp;11.1.&nbsp;Default test jar content settings</b></p><div class="table-contents"><table summary="Default test jar content settings" width="100%" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>Property Name</th><th>Default Value</th><th>Description</th></tr></thead><tbody><tr><td>root.dir</td><td><code class="literal">file:./target/test-classes</code></td><td>the root folder considered as the jar root</td></tr><tr><td>include.patterns</td><td><code class="literal">/**/*.class,/**/*.xml,/**/*.properties</code></td><td>Comma-separated string of Ant-style patterns</td></tr><tr><td>manifest</td><td>(empty)</td><td>manifest location given as a String. By default it's empty meaning the manifest
	        will be created by the test framework rather then being supplied by the user.</td></tr></tbody></table></div></div><br class="table-break"><p>This option is handy when creating specific tests that need to include certain resources (such as localization files 
		or images).</p></li></ol></div><p>Please consult <code class="classname">AbstractConfigurableBundleCreatorTests</code> and 
		<code class="classname">AbstractOnTheFlyBundleCreatorTests</code> tests for more customization hooks.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="testing:integration:understanding-manifest-creator"></a>11.2.3.3.&nbsp;Understanding The <code class="code">MANIFEST.MF</code> Generation</h4></div></div></div><p>A useful feature of the testing framework represents the automatic creation of the test manifest based on the test bundle content. The manifest 
      creator component uses byte-code analysis to determine the packages imported by the test classes so that it can generate the proper OSGi directives for them.
      Since the generated bundle is used for running a test, the creator will use the following assumptions:</p><div class="itemizedlist"><ul type="disc"><li><p>No packages will be exported.</p><p>The <span class="emphasis"><em>on-the-fly</em></span> bundle is used for running a test which 
      	(usually) consumes OSGi packages for its execution. This behaviour can be changed by <a href="#testing:integration:customize-manifest" title="11.2.3.1.&nbsp;Customizing The Test Manifest">customizing</a> 
      	the manifest.</p></li><li><p>Split packages (i.e. classes from the same package can come from different bundles) are not supported.</p><p> 
      	This means that packages present in the test framework are considered complete and no <code class="code">Import-Package</code> entry will be generated for them. 
      	To avoid this problem, consider using sub-packages or moving the classes inside one bundle. Note that split packages are discouraged due to the
      	issues associated with them (see the OSGi Core spec, Chapter 3.13 - Required Bundles).</p></li><li><p>The test bundle contains only test classes.</p><p>The byte-code parser will look only at the test classes hierarchy. Any other class included in the bundle, will not be considered so no imports
      	will be generated for it. To change the default behaviour, override <code class="methodname">createManifestOnlyFromTestClass</code> to return 
      	<code class="literal">false</code>:</p><pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">boolean</span> createManifestOnlyFromTestClass() {
	<span class="hl-keyword">return</span> false;
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">The time required to generate the manifest might increase depending on the number and size of classes in the bundle.</td></tr></table></div><p>
      	Additionally consider customizing the manifest yourself or attaching the extra code as inner classes to the test class (so it gets parsed automatically).</p></li></ul></div><p>
      The reason behind <span class="emphasis"><em>the lack of such features</em></span> is the byte-code parser is aimed to be simple and fast at creating test manifests - 
      it is not meant as a general-purpose tool for creating OSGi artifacts.  
      </p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:appContext"></a>11.2.4.&nbsp;Creating An OSGi Application Context</h3></div></div></div><p>Spring DM testing suite builds on top of Spring testing classes. To create an application context
	  (OSGi specific), one should just override <code class="literal">getConfigLocations[]</code> method and indicate
	  the location of the application context configuration. At runtime, an OSGi application context will be created
	  and cached for the lifetime of the test case.</p><pre class="programlisting"><span class="hl-keyword">protected</span> String[] getConfigLocations() {
   <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] { <span class="hl-string">"/com/xyz/abc/test/MyTestContext.xml"</span> };
}</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:specify-platform"></a>11.2.5.&nbsp;Specifying The OSGi Platform To Use</h3></div></div></div><p>The testing framework supports out of the box, three OSGi 4.0 implementations namely:
      Equinox, Knopflerfish and Felix. To be used, these should be in the test classpath. By default,
      the testing framework will try to use Equinox platform. This can be configured in several ways:</p><div class="orderedlist"><ol type="1"><li><p>programmatically through <code class="literal">getPlatformName()</code> method</p>.
      <p>Override the aforementioned method and indicate the fully qualified name of
      the <code class="interfacename">Platform</code> interface implementation. Users can use the <code class="classname">Platforms</code> 
      class to specify one of the supported platforms:</p><pre class="programlisting"><span class="hl-keyword">protected</span> String getPlatformName() {
   <span class="hl-keyword">return</span> Platforms.FELIX;
}</pre></li><li><p>declaratively 
      through <code class="literal">org.springframework.osgi.test.framework</code> system property.</p><p>If this property is set, 
      the testing framework will use its value as a fully qualified name of a Platform implementation. 
      It that fails, it will fall back to Equinox after logging a warning message.
      This option is useful for building tools (such as ant or maven) since it indicates a certain
      target environment without changing and test code.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:specify-test-wait-time"></a>11.2.6.&nbsp;Waiting For The Test Dependencies</h3></div></div></div><p>A built-in feature of the testing framework is the ability to wait until all dependencies are deployed before
      starting the test execution. Since the OSGi platforms are concurrent by nature, installing a bundle doesn't mean that
      all its services are running. By running a test before its dependency services are fully initialized can cause sporadic
      errors that pollute the test results. By default, the testing framework inspects all bundles installed by the user and,
      if they are Spring-powered bundles, waits until they are fully started (that is their application context is published
      as an OSGi service). This behaviour can be disabled by overriding <code class="literal">shouldWaitForSpringBundlesContextCreation</code>
      method. Consult <code class="classname">AbstractSynchronizedOsgiTests</code> for more details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="testing:integration:performance"></a>11.2.7.&nbsp;Testing Framework Performance</h3></div></div></div><p>Considering all the functionality offered by the testing framework, one might wonder if this doesn't become a 
      performance bottleneck. First, it's worth noting that all the work done automatically by the testing infrastructure 
      has to be done anyway (such as creating the manifest or creating a bundle for the test or installing the bundles).
      Doing it manually simply does not work as it's too error prone and time consuming. 
      In fact, the current infrastructure started as way to do efficient, automatic testing without worrying 
      about deployment problems and redundancy.</p><p>As for the numbers, the current infrastructure has been used internally for the last half a year - our integration tests
      (around 120) run in about 3:30 minutes on a laptop. Most of this time is spent on starting and stopping the OSGi platform: the "testing 
      framework" takes around 10% (as shown in our profiling so far).
      For example, the manifest generation has proved to take less then 0.5 seconds in general, while the jar creation around 1
      second.</p><p>However, we are working on making it even faster and smarter so that less configuration options are needed and
      the contextual information available in your tests is used as much as possible. If you have any ideas or suggestion,
      feel free to use our issue tracker or/and forum.     
      </p></div><p>Hopefully this chapter showed how Spring DM testing infrastructure can simplify OSGi integration testing and 
    how it can be customized. Consider consulting the javadocs for more information.
    </p></div></div></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="resources"></a>Part&nbsp;III.&nbsp;Other Resources</h1></div></div></div><div class="partintro" lang="en"><div></div><p>
              In addition to this reference documentation, there are a number of
              other resources that may help you learn how to use OSGi and Spring Dynamic
              Modules. These additional, third-party resources are enumerated in this 
              section.
          </p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="links"></a>Chapter&nbsp;12.&nbsp;Useful Links</h2></div></div></div><div class="itemizedlist"><ul type="disc"><li><span class="emphasis"><em>Spring DM Home Page</em></span> - <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springframework.org/osgi/" target="_top">here</a></li><li><span class="emphasis"><em>SpringSource OSGi blog</em></span> - <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://blog.springsource.com/category/osgi/" target="_top">here</a></li><li><span class="emphasis"><em>Spring DM Demos</em></span> - <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springframework.org/osgi/demos" target="_top">here</a></li><li><span class="emphasis"><em>Getting Started with OSGi</em></span> - by Neil Bartlett 
	<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://neilbartlett.name/blog/osgi-articles/" target="_top">here</a> and 
	<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.eclipse.org/resources/?author=Neil%20Bartlett" target="_top">here</a>.
	</li><li><span class="emphasis"><em>Equinox Documents</em></span> - 
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.eclipse.org/equinox/documents/" target="_top">here</a></li><li><span class="emphasis"><em>Felix-related presentations</em></span> - various 
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://felix.apache.org/site/presentations.html" target="_top">presentations</a>
		hosted by Apache Felix project.
	</li><li><span class="emphasis"><em>Launching Spring Dynamic Modules using pax-runner</em></span> - 
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://wiki.ops4j.org/confluence/display/ops4j/Pax+Runner+-+Screencast+-+Spring+OSGi" target="_top">
		screencast</a></li><li><span class="emphasis"><em>OSGi Alliance Blog</em></span> - <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/blog/" target="_top">here</a></li></ul></div></div></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="appendixes"></a>Part&nbsp;IV.&nbsp;Appendixes</h1></div></div></div><div class="partintro" lang="en"><div><div><div><h1 class="title"><a name="d18e5665"></a>Document structure</h1></div></div></div><p>
	  Various appendixes outside the reference documentation.
      </p><p><a href="#appendix-extensions" title="Appendix&nbsp;A.&nbsp;Extensions">Appendix&nbsp;A, <i xmlns:xlink="http://www.w3.org/1999/xlink">Extensions</i></a> describes extensions that are included in
      the 1.0 distribution, but are not guaranteed to be maintained in a
      backward-compatible form in future point releases. We anticipate these
      features moving into the core specification over time.</p><p><a href="#appendix-security" title="Appendix&nbsp;B.&nbsp;Security Integration">Appendix&nbsp;B, <i xmlns:xlink="http://www.w3.org/1999/xlink">Security Integration</i></a> provides information on how to run Spring DM 
      in an OSGi environment with a <code class="classname">SecurityManager</code> enabled 
      (Java 2 Security activated).
      </p><p><a href="#appendix-pde-integration" title="Appendix&nbsp;C.&nbsp;Eclipse Plug-in Development integration">Appendix&nbsp;C, <i xmlns:xlink="http://www.w3.org/1999/xlink">Eclipse Plug-in Development integration</i></a> describes how to integrate Spring DM
      with Eclipse Plug-in Development Environment.</p><p><a href="#appendix-archetype" title="Appendix&nbsp;D.&nbsp;Spring Dynamic Modules Maven Archetype">Appendix&nbsp;D, <i xmlns:xlink="http://www.w3.org/1999/xlink">Spring Dynamic Modules Maven Archetype</i></a> describes the Spring DM Maven 2 archetype
      usage.</p><p><a href="#appendix-tips" title="Appendix&nbsp;E.&nbsp;Useful OSGi tips">Appendix&nbsp;E, <i xmlns:xlink="http://www.w3.org/1999/xlink">Useful OSGi tips</i></a> provides some useful OSGi tips, especially
      meaningful when used along with Spring DM.</p><p><a href="#appendix-roadmap" title="Appendix&nbsp;F.&nbsp;Roadmap">Appendix&nbsp;F, <i xmlns:xlink="http://www.w3.org/1999/xlink">Roadmap</i></a> describes some features that are included in
      the 1.0 distribution but are still considered early-access. The
      externals of these features may change in future releases. This appendix
      also discusses other planned features for which no implementation yet
      exists.</p><p><a href="#appendix-osgi-repo" title="Appendix&nbsp;G.&nbsp;Spring DM OSGi Repository">Appendix&nbsp;G, <i xmlns:xlink="http://www.w3.org/1999/xlink">Spring DM OSGi Repository</i></a> describes the repository used by Spring DM
      for its osgi artifacts.</p><p><a href="#appendix-schema" title="Appendix&nbsp;H.&nbsp;Spring Dynamic Modules Schema">Appendix&nbsp;H, <i xmlns:xlink="http://www.w3.org/1999/xlink">Spring Dynamic Modules Schema</i></a> defines the schemas provided by Spring Dynamic
      Modules.</p></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-extensions"></a>Appendix&nbsp;A.&nbsp;Extensions</h2></div></div></div><div class="sidebar"><p class="title"><b>Spring DM and Spring annotations</b></p><p>This chapter describes the annotations present in Spring DM and how
	  to enable/disable them. Spring DM annotatations are separate from the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/new-in-2.html#new-in-2-ioc-annotations" target="_top">annotation</a> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/new-in-2.html#new-in-2-ioc-component-scanning" target="_top">support</a> in Spring
	  framework; enabling or disabling one does not interfere with the other.</p></div><p>This appendix describes extensions to the core functionality that
    are shipped with the 1.0 distribution, but are not guaranteed to have
    backwards compatibility across point releases. We anticipate these
    features migrating into the core specification in future releases.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-extensions:annotations"></a>A.1.&nbsp;Annotation-Based Injection</h2></div></div></div><p>The
      <code class="literal">org.springframework.osgi.extensions.annotation</code> bundle
      that ships with Spring Dynamic Modules provides early access to
      annotation-based support for injecting references to OSGi services. JDK
      1.5 or above is required to use this feature.</p><p>Bean class (setter) methods may be annotated with
      <code class="literal">org.springframework.osgi.extensions.annotation.ServiceReference</code>.
      By default the property type of the annotated property is used to look
      up a service with a matching service interface in the OSGi service
      registry and inject the result. For example, given the
      configuration:</p><pre class="programlisting">&lt;<span class="hl-tag">bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"annotationDriven"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyAnnotationDrivenBeanClass"</span>/&gt;
      </pre><p>and the class declaration:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAnnotationDrivenBeanClass {

  @ServiceReference
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMessageService(MessageService aService) { ... }

}</pre><p>then a service lookup for services implementing the
      <code class="interfacename">MessageService</code> interface will be performed, and the
      best match (using the same algorithm as documented for the
      <code class="literal">reference</code> element) will be injected.</p><p>The <code class="classname">ServiceReference</code> annotation class has a
      number of attributes that can be used to control the service lookup (for
      example, to specify a filter string) that mirror the options provided by
      the <code class="literal">reference</code> element. See the javadoc for more
      information.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-extensions:annotations:enable"></a>A.1.1.&nbsp;Enabling/Disabling Annotation Processing</h3></div></div></div><p>By default, as Spring-OSGi is JDK 1.4 compatible, annotation injection is disabled. There are
		currently two ways for enabling it:</p><div class="itemizedlist"><ul type="disc"><li><p>through Spring DM extender (see <a href="#app-deploy:extender-configuration" title="6.2.&nbsp;Extender Configuration Options">Section&nbsp;6.2, &#8220;Extender Configuration Options&#8221;</a>).</p><p>This is an extender wide configuration which means all bundles started by the extender will have annotation injection applied to them.
			  </p></li><li><p>by specifying a dedicated bean post processor</p><p>By specifying the Spring DM annotation extension processor, one
			can enable <span class="emphasis"><em>per-bundle</em></span> annotation injection. To do that, add the following to your bundle configuration:</p><pre class="programlisting">&lt;!-- annotation processor --&gt;
&lt;bean class="org.springframework.osgi.extensions.annotation.ServiceReferenceInjectionBeanPostProcessor"/&gt;</pre></li></ul></div><p>As a reminder, for the annotations to work, the containing bundle needs to import <code class="literal">org.springframework.osgi.extensions.annotation</code>
		package, which is available in the <code class="literal">spring-osgi-annotation</code> bundle.</p></div></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-security"></a>Appendix&nbsp;B.&nbsp;Security Integration</h2></div></div></div><p>Since 1.2.0, Spring DM integrates with Java 2 <a href="#">security</a>. 
    Namely Spring DM uses <a href="#">privileged blocks</a> for executing security 
    sensitive operations using its own permissions.  
    </p><p>Being a framework, Spring DM needs to introspect bundles to determine their content and configuration. In general, it is recommended to grant
    <code class="classname">java.security.AllPermission</code> to Spring DM bundles. For those that would like to restrict the properties, below you can find a list
    of permissions that are needed for Spring DM to work properly. However, we <span class="emphasis"><em>strongly</em></span> recommend to test whether the permissions are needed or
    not for your environment since the minimum number depends heavily on what parts of the framework are used. 
    </p><div class="table"><a name="spring-dm-permission-table"></a><p class="title"><b>Table&nbsp;B.1.&nbsp;Spring DM Permission Table</b></p><div class="table-contents"><table summary="Spring DM Permission Table" width="100%" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>Permission</th><th>Target</th><th>Action</th><th>Usage</th></tr></thead><tbody><tr><td><code class="classname">java.io.FilePermission</code></td><td><span class="emphasis"><em>depends</em></span>, &lt;&lt;ALL FILES&gt;&gt; recommended</td><td>read/write</td><td>Required by the logging system and web extender for installing the wars and JSP taglibs</td></tr><tr><td><code class="classname">java.lang.RuntimePermission</code></td><td>*</td><td>accessDeclaredMembers</td><td>Used in some cases for reflection (such as accessing the <code class="interfacename">BundleContext</code> from a 
              	given <code class="interfacename">Bundle</code> (on	R4.0 platforms).</td></tr><tr><td><code class="classname">java.lang.reflect.ReflectPermission</code></td><td>*</td><td>suppressAccessChecks</td><td>Used for accessing (through reflection) non-public methods or fields internally.</td></tr><tr><td><code class="classname">java.util.PropertyPermission</code></td><td>*</td><td>read,write</td><td>In use by the testing framework mainy. Useful for reading the environment, including OSGi properties.</td></tr><tr><td><code class="classname">org.osgi.framework.AdminPermission</code></td><td>*</td><td>class, execute, listener, metadata, resolve, resource</td><td>Used by the extender to listen read the content of started bundles.</td></tr><tr><td><code class="classname">org.osgi.framework.BundlePermission</code></td><td>*</td><td>HOST</td><td>Useful when attaching a custom configuration (as fragment) to the extender/web extender.</td></tr><tr><td><code class="classname">org.osgi.framework.PackagePermission</code></td><td>*</td><td>EXPORT, IMPORT</td><td>Basic permission used for importing and exporting the Spring DM bundles content.</td></tr><tr><td><code class="classname">org.osgi.framework.ServicePermission</code></td><td>*</td><td>get,register</td><td>Used for publishing and lookup of Spring DM internal services (such as the Spring namespace handlers/resolvers).</td></tr></tbody></table></div></div><br class="table-break"><p>As a general recommendation, for security sensible environments, to determine the minimum number of permissions start with a basic set of bundles 
    and no permissions. This way, on each run, one can find out what permissions are needed and by whom and tweak the system accordingly.</p></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-pde-integration"></a>Appendix&nbsp;C.&nbsp;Eclipse Plug-in Development integration</h2></div></div></div><p>Eclipse <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.eclipse.org/pde/" target="_top">PDE</a> &#8220;<span class="quote">provides comprehensive OSGi tooling, which makes it 
    an ideal environment for component programming, not just Eclipse plug-in development</span>&#8221;.
    In fact, Eclipse IDE is built on top of OSGi and uses at its core the Equinox OSGi implementation. Moreover, all the Eclipse 
    plug-ins are OSGi bundles. This makes Eclipse with PDE a very attractive tool for creating OSGi bundles.
    While Spring Dynamic Modules artifacts can be integrated as <span class="emphasis"><em>normal</em></span> libraries, through 
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springide.org" target="_top">Spring IDE</a>, Spring DM can be installed as a 
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://help.eclipse.org/stable/index.jsp?topic=/org.eclipse.pde.doc.user/guide/tools/preference_pages/target_platform.htm" target="_top">
    target platform</a> ready to be used with PDE.
   </p><div class="procedure"><p>The following steps illustrate how to install Spring IDE extension for OSGi and how to use it in your project. Please see 
     <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://springide.org/project/wiki/SpringideInstall" target="_top">Spring IDE installation page</a> for information on its requirement
     and install process.</p><ol type="1"><li><p class="title"><b>Set Up Nightly Update Site</b></p><p>At the moment, the OSGi extension is available only on Spring-IDE nightly builds update site. Add it to the Eclipse configuration by
   	 	opening the software update menu:
   	 	</p><p>
		  </p><div class="mediaobject" align="left"><img src="images/pde/find-install.png" align="left"></div><p>
          
		  </p><div class="mediaobject" align="central"><img src="images/pde/springide-site.png" align="central"></div><p>        
          
        </p><p>and create a new update site pointing to <code class="literal">http://www.springide.org/updatesite_nightly</code></p></li><li><p class="title"><b>Select Spring IDE OSGi extension</b></p><p>After using the nightly update site and performing the update, Eclipse will show the search results. Unfold the <span class="emphasis"><em>Extension</em></span> menu and select <code class="literal">Spring IDE OSGi Extension</code>:</p><p>
		  </p><div class="mediaobject" align="center"><img src="images/pde/spring-osgi-plugin.png" align="middle" alt="Select Spring IDE OSGI extension"></div><p>        
        </p><p>and proceed with the instalation.</p></li><li><p class="title"><b>Select Spring Dynamic Modules Target Platform</b></p><p>Once the plug-in has been installed, Spring Dynamic Modules can be selected as a PDE target platform. Select Window/Preferences/Plug-in Development and then
   	 	Target Platform.</p><p>
		  </p><div class="mediaobject" align="center"><img src="images/pde/target-select.png" align="middle" alt="Select Spring DM target platform"></div><p>
        </p><p>Select the Spring DM version that you desire from the Pre-defined Target (1) drop box and press Load Target (2). Eclipse will load the target and all bundles defined
        by it - this includes Spring DM bundles and all of its dependencies (SLF4J is used for logging). The configuration can be customised appropriately by removing
        and adding bundles.</p><p>In its current form, the plug-in offers two predefined targets - one for the stable released versions and one for the SNAPSHOT/nightly Spring DM jars. The latter
        does not contain any jars as it is expected for the user to download them manually. Simply locate the path where the plug-ins should be located (3), enter that folder 
        and do a </p><pre class="programlisting">mvn install</pre><p>The latest Spring DM SNAPSHOT will be downloaded along with all of its dependencies.
        Simply click on the reload button (4) and Eclipse will pick up the bundles. </p></li><li><p class="title"><b>Select PDE Perspective</b></p><p>Once the installation is completed just select the PDE perspective:</p><p>
		  <span class="inlinemediaobject"><img src="images/pde/select-pde-1.png" align="left"></span>
		  <span class="inlinemediaobject"><img src="images/pde/select-pde-2.png" align="central"></span>
          
        </p><p>and the Spring DM and its dependencies should be available in the plug-ins view:</p><p>
		  <span class="inlinemediaobject"><img src="images/pde/select-plugins-view.png" align="left"></span>

		  <span class="inlinemediaobject"><img src="images/pde/show-plugins.png" align="central"></span>          
        </p></li></ol></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-archetype"></a>Appendix&nbsp;D.&nbsp;Spring Dynamic Modules Maven Archetype</h2></div></div></div><p>As part of the distribution, Spring DM provides a Maven <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://maven.apache.org/plugins/maven-archetype-plugin/" target="_top">archetype</a>
    which creates the basic structure of a Java project that uses Spring DM, especially useful to new users. To run the archetype (and create the new project),
    simply run the following command line: 
   	</p><pre class="programlisting">mvn archetype:generate</pre><p>
   The maven plugin will display a selection of possible archetype, from which you should pick 
   <code class="literal">spring-osgi-bundle-archetype (Spring-OSGi archetype)</code> (currently number 32), and will request input regarding the project about to be created. 
   A list of all available archetypes included with the plugin and their versions is available <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://docs.codehaus.org/display/MAVENUSER/Archetypes+List" target="_top">here</a>.
   </p><p>
   Note that it is still possible to select the osgi archetype directly from the command line (i.e. the old way of using the archetype): 
   </p><pre class="programlisting">mvn archetype:create \
-DarchetypeGroupId=org.springframework.osgi \
-DarchetypeArtifactId=spring-osgi-bundle-archetype \
-DarchetypeVersion=   \
-DgroupId=&lt;your-project-groupId&gt;  \
-DartifactId=&lt;your-project-artifactId&gt; \
-Dversion=&lt;your-project-version&gt;</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">The command above should be invoked as one line - the <code class="literal">\</code> is used as a convenience to break the long line into smaller pieces</td></tr></table></div><p>In both cases, the result of the commands is a Maven 2 project that defines two packages (one public and one private) and two Spring configurations:
    <code class="literal">src/main/resources/META-INF/spring/bundle-context.xml</code> and <code class="literal">src/main/resources/META-INF/spring/bundle-context-osgi.xml</code> 
    The project is packaged as an OSGi bundle.</p><p>Notice that by default, the project does not contain a MANIFEST.MF for your project. The Maven infrastructure will generate it, either through SpringSource
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.org/bundlor" target="_top">Bundlor</a> (the default) or Apache Felix 
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://felix.apache.org/site/maven-bundle-plugin-bnd.html" target="_top">bundle plug-in</a>. 
    To generate the manifest, run the following (from the project root):</p><pre class="programlisting">mvn package</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">To avoid the confusion between the generated artifacts and maintained files, the manifest file resides under <code class="literal">META-INF</code> folder
    while Spring configuration files under <code class="literal">src/main/resources/META-INF</code> directory.</td></tr></table></div><p>This will compile your project, pack it as a jar and create the OSGi manifest based on your classes under <code class="literal">/META-INF</code> folder (so
    that users running Eclipse PDE can use it right away.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="archetype:generated-content"></a>D.1.&nbsp;Generated Project Features At-A-Glance</h2></div></div></div><div class="itemizedlist"><ul type="disc"><li>Packaged as an OSGi bundle</li><li><code class="literal">META-INF/MANIFEST.MF</code> automatically generated</li><li><code class="literal">src/main/java/&lt;package&gt;</code> public package exported by the bundle</li><li><code class="literal">src/main/java/&lt;package&gt;/internal</code> private package, not exported by the bundle</li><li><code class="literal">src/main/resources/META-INF/spring/bundle-context.xml</code> is a Spring configuration file that defines the simple bean.</li><li><code class="literal">src/main/resources/META-INF/spring/bundle-context-osgi.xml</code> is a Spring configuration file ready for you to add bean 
   		definitions from the osgi namespace (services, references etc.)</li><li><code class="literal">.project</code>, <code class="literal">.classpath</code>, and <code class="literal">build.properties</code> files created to enable use of this 
   		project directly inside eclipse as a PDE plugin project</li></ul></div></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-tips"></a>Appendix&nbsp;E.&nbsp;Useful OSGi tips</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-tips:fragments"></a>E.1.&nbsp;OSGi Fragments</h2></div></div></div><div class="sidebar"><p class="title"><b>Check the target OSGi platform fragment support</b></p><p>Before using fragments, make sure the target OSGi environment supports them (and to what degree). Out of the OSGi platforms on
			which Spring DM is tested upon, at the time of this writing, Apache Felix does not support fragments (it simply ignores them).</p></div><p>Part of the OSGi R4 release, <span class="emphasis"><em>fragments</em></span> are a very useful and powerful feature. A fragment is 
		&#8220;<span class="quote">a bundle that is <span class="emphasis"><em>attached</em></span> to a <span class="emphasis"><em>host bundle</em></span></span>&#8221;, adding content to the target bundle. 
		A fragment cannot have its own class loader nor a bundle activator and cannot override the information already present in the host. 
		In short, through fragments, bundles can be extender with resources, classes and even manifest entries. To quote the spec again, 
		a &#8220;<span class="quote">...key use case for fragments is providing translation files for different locales. This allows the translation files to be 
		treated and shipped independently from the main application bundle.</span>&#8221;</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">For a full description on fragments, please see the OSGi specification, section 3.14.</td></tr></table></div><p>In Spring DM, fragments are useful for configuring various components such as the extenders. To do that, simply bundle the resources as you
		normally would and add an extra entry to the bundle manifest:</p><pre class="programlisting">Fragment-Host: &lt;host bundle symbolic name&gt;</pre><p>This line indicates that the containing bundle is a fragment and that it should be attached to the host specified by a symbolic name. The fragment
		and host bundle symbolic name should be different. For example, to attach a fragment (with extra configuration) the Spring DM extender, one could use
		the following manifest:</p><div class="programlistingco"><pre class="programlisting">Manifest-Version: 1.0                                                                    <span class="co"><img src="images/callouts/1.png" alt="(1)"></span>
Bundle-ManifestVersion: 2                                                                <span class="co"><img src="images/callouts/2.png" alt="(2)"></span>
Fragment-Host: org.springframework.osgi.extender                                         <span class="co"><img src="images/callouts/3.png" alt="(3)"></span>
Bundle-SymbolicName: org.mydomain.project.fragment                                       <span class="co"><img src="images/callouts/4.png" alt="(4)"></span>
Bundle-Name: my-fragment                                                                 <span class="co"><img src="images/callouts/5.png" alt="(5)"></span>
Bundle-Description: Fragment attached to Spring DM extender                              <span class="co"><img src="images/callouts/6.png" alt="(6)"></span>
</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img src="images/callouts/1.png" alt="1" border="0"></td><td valign="top" align="left"><p>Manifest version.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/2.png" alt="2" border="0"></td><td valign="top" align="left"><p>OSGi bundle version. A value of <code class="literal">1</code> (which is also the default) indicates an OSGi Release 3 bundle so it's best to 
            specify <code class="literal">2</code> to indicate an OSGi Release 4 bundle.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/3.png" alt="3" border="0"></td><td valign="top" align="left"><p>The symbolic name of the bundle to which this fragment should be attached to. In this case, the value 
         	<code class="literal">org.springframework.osgi.extender</code> points to the <code class="literal">spring-osgi-extender.jar</code>.
         	<code class="literal">Fragment-Host</code> is the <span class="emphasis"><em>key</em></span> entry which tells the OSGi platform that the containing bundle is a of a 
         	special kind - it's a fragment.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/4.png" alt="4" border="0"></td><td valign="top" align="left"><p>The fragment symbolic name.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/5.png" alt="5" border="0"></td><td valign="top" align="left"><p>The bundle name - an optional yet useful header.</p></td></tr><tr><td width="5%" valign="top" align="left"><img src="images/callouts/6.png" alt="6" border="0"></td><td valign="top" align="left"><p>The bundle description - just like the name, this header is useful for humans not for the OSGi platform itself. However, it is
         	recommended that you define it to help identify the bundle purpose.</p></td></tr></table></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/admons/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">The Manifest entries order does not matter, but they case sensitive.</td></tr></table></div><p>When multiple bundles with the same symbolic names are present, one can add the bundle version to make sure the proper wiring is done:</p><pre class="programlisting">Fragment-Host: org.springframework.osgi.extender;bundle-version=1.1.0</pre><p>The default value for <code class="literal">bundle-version</code> (when it's not specified) is <code class="literal">[0.0.0,&#8734;)</code></p></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-roadmap"></a>Appendix&nbsp;F.&nbsp;Roadmap</h2></div></div></div><p>
		This appendix documents features on the Spring Dynamic Modules
		roadmap. The design of these features specified here is subject
		to change. As a most up to date source, please see
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://jira.springframework.org/browse/OSGI" target="_top">
			our
		</a>
		issue tracker.
	</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d18e6241"></a>F.1.&nbsp;Access to Service References for Collections</h2></div></div></div><p>The current specification does not provide for access to the
      <code class="literal">ServiceReference</code> objects for services in a managed
      collection (i.e. obtained via a <code class="literal">set</code> or
      <code class="literal">list</code> declaration). A future release of Spring Dynamic
      Modules will provide an easy means of gaining access to these
      references.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d18e6255"></a>F.2.&nbsp;Start Level Integration</h2></div></div></div><p>A future release of Spring Dynamic Modules may offer the following
      additional guarantee with respect to application context creation and
      start levels:</p><p>Application context creation happens asynchronously. However, the
      extender bundle does guarantee that the creation of all application
      contexts for bundles at start level <code class="literal">n</code> will be
      complete before the creation of any application context at start level
      <code class="literal">m</code>, where <code class="literal">m &gt; n</code>. Care must
      therefore be taken not to introduce any mandatory dependencies on
      services exported by bundles with higher start levels or a deadlock will
      be introduced.</p><p>In a similar vein, when shutting down the extender bundle,
      application contexts at start level <code class="literal">m</code> will be shut
      down before application contexts at start level <code class="literal">n</code>,
      where <code class="literal">m &gt; n</code>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d18e6282"></a>F.3.&nbsp;Web Library Integration</h2></div></div></div><p>While support for generic and Spring-MVC web applications is available in 1.1.0,
      in the future we'd like to provide integration (if needed) with other popular web libraries 
      (such as JSF and Spring Web Flow) in the upcoming releases.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d18e6287"></a>F.4.&nbsp;ORM/Persistence Support</h2></div></div></div><p>Care needs to be taken when using JPA or Hibernate under OSGi as
      the persistence engines must have visibility of the persistent types and
      mapping files. The Spring Dynamic Modules project will be investigating
      an extension model to make managing this easier when persistent
      configuration is split across several bundles. See Peter Krien's <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.osgi.org/blog/2007/06/osgi-and-hibernate.html" target="_top">blog
      entry</a> on the topic for an insight into the issues.</p><p>Also, the project aims to simplify deployment of JDBC drivers and
      pooling libraries that at the moment require special <code class="literal">DynamicImport-Package</code>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d18e6300"></a>F.5.&nbsp;OSGi Standards</h2></div></div></div><p>While OSGi 4.0 is currently required, work is underway to take advantage of the
	  new features available in 4.1. SpringSource is an active participant in the 
	  <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www2.osgi.org/EEG/HomePage" target="_top">OSGi Enterprise Expert Group</a> 
	  and we hope to help many of the ideas found in the Spring Dynamic Modules project 
	  to make their way into the OSGi R5 specification.
	  Spring Dynamic Modules would obviously seek to support any such standards at that 
	  point in time.</p></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-osgi-repo"></a>Appendix&nbsp;G.&nbsp;Spring DM OSGi Repository</h2></div></div></div><p>At the moment, most libraries are not released as OSGi bundles which means they cannot be used inside the OSGi space unless they
    are embedded in other bundles. Though there are <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.aqute.biz/Code/Bnd" target="_top">tools</a> that make the bundling 
    process easy, it is desirable to have the artifacts prepacked so they can be used immediately for development.</p><p>SpringSource <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.com/repository/" target="_top">Enterprise Bundle Repository</a> (or SpringSource Repository) addresses this problem by 
    providing 
    &#8220;<span class="quote">a collection of open source libraries commonly used for developing enterprise Java applications with the Spring Framework</span>&#8221; (taken
    from the Repository <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.com/repository/app/faq" target="_top">FAQ</a>). With the availability of the Bundle Repository,
    the Spring DM old repository (see below) has been deprecated and it is being used until migrating completely to SpringSource Repository. It is highly recommended
    that users migrate as well to SpringSource Repository as it provides significantly more libraries and it is intended to be a user-facing infrastructure component. 
    </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-osgi-repo:old-repo"></a>G.1.&nbsp;Spring DM Temporary OSGi Repository</h2></div></div></div><p>Unfortunately, not all Spring DM dependencies are available in SpringSource Repository and thus Spring DM still needs to maintain some of its own 
    	dedicated Maven <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://maven.apache.org/guides/introduction/introduction-to-repositories.html" target="_top">repository</a> available
	    at <code class="literal">http://maven.springframework.org/osgi</code>.
	    
	    </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/admons/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">The repository is <span class="emphasis"><em>provided as-is</em></span> without any kind of support. The repository structure/content
	    can (and will) change until it becomes stable. Before using Spring DM repository make sure the needed artifact are not available
	    in SpringSource Repository. These being said, we hope you find it useful and we'd like to <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://jira.springframework.org/browse/OSGI" target="_top">know</a> 
	    if there are improvement that can be made to it.</td></tr></table></div><p> 
	    </p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-osgi-repo:conventions"></a>G.1.1.&nbsp;Repository Conventions</h3></div></div></div><p>Currently, all the artifacts published in the repository are marked as <code class="literal">SNAPSHOT</code>s meaning that, in time, their
		content can change. This allows clients to download possible manifest updates made to the libraries. We foresee that, as the library usage
		increases, several popular items will have the <code class="literal">SNAPSHOT</code> marker remove.
		Additionally, to differentiate the <span class="emphasis"><em>OSGi</em></span>-enabled artifacts from the original ones, all libraries are placed under
		<code class="literal">org.springframework.osgi</code> group and their names contains a <code class="literal">.osgi</code> suffix.</p><p>So for example, an OSGi version of <code class="literal">mx4j-3.0.2</code> jar is available in the Spring DM OSGi repository under at:
		<code class="literal">org/springframework/osgi/mx4j.osgi/3.0.2-SNAPSHOT/mx4j.osgi-3.0.2-SNAPSHOT.jar</code></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-osgi-repo:browsing"></a>G.1.2.&nbsp;Browsing The Repository Content</h3></div></div></div><p>The repository is currently hosted at Amazon <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://aws.amazon.com/s3" target="_top">S3</a>. To browse the repository structure,
		use a S3 compatible browser (such as <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://s3browse.com/explore/maven.springframework.org/osgi/org/springframework/osgi/" target="_top">this</a> one)
		since a vanilla web browse will not be suitable. 
		</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-osgi-repo:maven"></a>G.1.3.&nbsp;Using The Repository With Maven</h3></div></div></div><p>The use the repository, simply add it ot the <code class="literal">repositories</code> group; since the repository 
		contains <code class="literal">SNAPSHOT</code> artifacts, make sure to mark it accordingly:</p><pre class="programlisting">&lt;<span class="hl-tag">repositories</span>&gt;
  &lt;<span class="hl-tag">repository</span>&gt;
    &lt;<span class="hl-tag">id</span>&gt;spring-osgified-artifacts&lt;<span class="hl-tag">/id</span>&gt;
    &lt;<span class="hl-tag">snapshots</span>&gt;
      &lt;<span class="hl-tag">enabled</span>&gt;true&lt;<span class="hl-tag">/enabled</span>&gt;
    &lt;<span class="hl-tag">/snapshots</span>&gt;
    &lt;<span class="hl-tag">name</span>&gt;Springframework Maven OSGified Artifacts Repository&lt;<span class="hl-tag">/name</span>&gt;
    &lt;<span class="hl-tag">url</span>&gt;http://maven.springframework.org/osgi&lt;<span class="hl-tag">/url</span>&gt;
  &lt;<span class="hl-tag">/repository</span>&gt;
&lt;<span class="hl-tag">/repositories</span>&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-osgi-repo:ant"></a>G.1.4.&nbsp;Using The Repository With Ant/Ivy</h3></div></div></div><p>When using <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://ant.apache.org/" target="_top">Ant</a> consider using the excellent <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://ant.apache.org/ivy/" target="_top">Ivy</a>
		subproject for retrieving the OSGi dependencies from the Spring DM repository as Ivy can work with a Maven-style repository. Please see the 
		Ivy <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://ant.apache.org/ivy/history/latest-milestone/tutorial/start.html" target="_top">tutorial</a> for more information.</p></div></div></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-schema"></a>Appendix&nbsp;H.&nbsp;Spring Dynamic Modules Schema</h2></div></div></div><p>Spring Core Schema</p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;

&lt;xsd:schema xmlns="http://www.springframework.org/schema/osgi"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:beans="http://www.springframework.org/schema/beans"
        xmlns:tool="http://www.springframework.org/schema/tool"
        targetNamespace="http://www.springframework.org/schema/osgi"
        elementFormDefault="qualified"
        attributeFormDefault="unqualified"
        version="1.2"&gt;

	&lt;xsd:import namespace="http://www.w3.org/XML/1998/namespace"/&gt;
    &lt;xsd:import namespace="http://www.springframework.org/schema/beans"/&gt;
    &lt;xsd:import namespace="http://www.springframework.org/schema/tool"/&gt;

    &lt;xsd:annotation&gt;
        &lt;xsd:documentation&gt;&lt;![CDATA[
    Namespace support for the core services provided by Spring Dynamic Modules.
        ]]&gt;&lt;/xsd:documentation&gt;
    &lt;/xsd:annotation&gt;
    
    &lt;xsd:attributeGroup name="defaults"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation&gt;&lt;![CDATA[Defaults for Spring-DM OSGi declarations.]]&gt;
    		&lt;/xsd:documentation&gt;
    	&lt;/xsd:annotation&gt;
    	&lt;!-- attributes --&gt;
    	&lt;xsd:attribute name="default-timeout" type="xsd:long" default="30000"&gt;
    		&lt;xsd:annotation&gt;
    			&lt;xsd:documentation&gt;&lt;![CDATA[
    Default timeout (in milliseconds) for all reference (service importers) elements that do not explicitly specify one.
    Default value is 300000 ms (5 minutes).
    			]]&gt;&lt;/xsd:documentation&gt;
    		&lt;/xsd:annotation&gt;
    	&lt;/xsd:attribute&gt;
    	&lt;xsd:attribute name="default-cardinality" type="TdefaultCardinalityOptions" default="1..X"&gt;
    		&lt;xsd:annotation&gt;
    			&lt;xsd:documentation&gt;&lt;![CDATA[
    Default cardinality (of the relationship to the backing service(s)) for all OSGi references (singular or collections) 
    elements that do not explicitly specify one.
    Default value is '1..X' (resolved to '1..1' for osgi:reference and '1..N' for osgi:list/set) which means that a backing 
    service must exist (this is a mandatory service reference). A value of '0..X' (resolved to '0..1' for osgi:reference 
    and '0..N' for osgi:list/set) indicates that it is acceptable to be no backing service (an optional service reference).
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
    &lt;/xsd:attributeGroup&gt;
    
    &lt;xsd:simpleType name="TdefaultCardinalityOptions"&gt;
        &lt;xsd:restriction base="xsd:string"&gt;
            &lt;xsd:enumeration value="1..X"&gt;
            	&lt;xsd:annotation&gt;
            		&lt;xsd:documentation&gt;&lt;![CDATA[
    A backing service must exist (this is a mandatory service reference).
            		]]&gt;&lt;/xsd:documentation&gt;
            	&lt;/xsd:annotation&gt;
            &lt;/xsd:enumeration&gt;
            &lt;xsd:enumeration value="0..X"&gt;
            	&lt;xsd:annotation&gt;
            		&lt;xsd:documentation&gt;&lt;![CDATA[
    A backing service can be missing (this is an optional service reference).
            		]]&gt;&lt;/xsd:documentation&gt;
            	&lt;/xsd:annotation&gt;
            &lt;/xsd:enumeration&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;
	
    &lt;!-- reference --&gt;
    &lt;xsd:element name="reference" type="TsingleReference"&gt;
        &lt;xsd:annotation&gt;
            &lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a reference to a service obtained via the OSGi service registry.
            ]]&gt;&lt;/xsd:documentation&gt;
        &lt;/xsd:annotation&gt;
    &lt;/xsd:element&gt;

    &lt;xsd:complexType name="Treference"&gt;
        &lt;xsd:complexContent&gt;
            &lt;xsd:extension base="beans:identifiedType"&gt;
                &lt;xsd:sequence minOccurs="0" maxOccurs="1"&gt;
                	&lt;xsd:element name="interfaces" type="beans:listOrSetType" minOccurs="0" maxOccurs="1"&gt;
                    	&lt;xsd:annotation&gt;
                    		&lt;xsd:documentation&gt;&lt;![CDATA[
	The set of service interfaces that the services obtained via the registry are required to support.
    By convention, the interface attribute is a Java interface type, but may also be a (non-final)
    class type.
                    		]]&gt;&lt;/xsd:documentation&gt;
                    	&lt;/xsd:annotation&gt;
                    &lt;/xsd:element&gt;                
                    &lt;xsd:element name="listener" type="Tlistener" minOccurs="0" maxOccurs="unbounded"&gt;
                      &lt;xsd:annotation&gt;
                      	&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a listener that will receive notification when a service backing this reference is 
    bound or unbound. 
                      	]]&gt;&lt;/xsd:documentation&gt;
                      &lt;/xsd:annotation&gt;
                    &lt;/xsd:element&gt;
                &lt;/xsd:sequence&gt;
                &lt;xsd:attribute name="interface" use="optional" type="xsd:token"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    The service interface that the services obtained via the registry are required to support.
    By convention this is a Java interface type, but may also be a (non-final) class type.
                		]]&gt;&lt;/xsd:documentation&gt;
                		&lt;xsd:appinfo&gt;
                			&lt;tool:annotation&gt;
                				&lt;tool:expected-type type="java.lang.Class" /&gt;
                			&lt;/tool:annotation&gt;
                		&lt;/xsd:appinfo&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="filter" use="optional" type="xsd:string"&gt;
                      &lt;xsd:annotation&gt;
                      	&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines an OSGi filter expression that is used to constrain the set of matching services
    in the service registry. 
                      	]]&gt;&lt;/xsd:documentation&gt;
                      &lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="depends-on" type="xsd:string" use="optional"&gt;
					&lt;xsd:annotation&gt;
						&lt;xsd:documentation&gt;&lt;![CDATA[
	Used to refer to the name of another bean that this bean depends on. Ensures that the
	service registry look-up does not happen until after the dependent bean has been created 
	(most commonly used to refer to a bundle bean).
						]]&gt;&lt;/xsd:documentation&gt;
					&lt;/xsd:annotation&gt;                
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="bean-name" type="xsd:string" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Convenient shortcut for specifying a filter expression that matches on the bean-name property
    that is automatically advertised for beans published using the service element.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="context-class-loader" type="TreferenceClassLoaderOptions" default="client"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines how the context class loader is managed when invoking operations on a service
    backing this service reference. The default value is 'client' which means that the context
    class loader has visibility of the resources on this bundle's classpath. Alternate
    options are 'service-provider' which means that the context class loader has visibility of 
    resources on the bundle classpath of the bundle that exported the service, and 'unmanaged'
    which does not do any management of the context class loader.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
            &lt;/xsd:extension&gt;
        &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;
    
    &lt;xsd:simpleType name="TreferenceClassLoaderOptions"&gt;
        &lt;xsd:restriction base="xsd:NMTOKEN"&gt;
            &lt;xsd:enumeration value="client"/&gt;
            &lt;xsd:enumeration value="service-provider"/&gt;
            &lt;xsd:enumeration value="unmanaged"/&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:complexType name="Tlistener"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a listener that will be notified when the service backing the enclosing service reference element is bound or 
    unbound. Use either the 'ref' attribute or a nested bean declaration for the listener bean.
    		]]&gt;&lt;/xsd:documentation&gt;
    	&lt;/xsd:annotation&gt;
        &lt;xsd:sequence minOccurs="0" maxOccurs="1"&gt;
            &lt;!-- nested bean declaration --&gt;
            &lt;xsd:any namespace="##other" minOccurs="1" maxOccurs="1" processContents="skip"/&gt;
        &lt;/xsd:sequence&gt;

        &lt;!-- shortcut for bean references --&gt;
        &lt;xsd:attribute name="ref" type="xsd:string" use="optional"&gt;
        	&lt;xsd:annotation&gt;
        		&lt;xsd:documentation&gt;&lt;![CDATA[
    Refers by name to the bean that will receive bind and unbind events
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
        &lt;xsd:attribute name="bind-method" type="xsd:token" use="optional"&gt;
        	&lt;xsd:annotation&gt;
        		&lt;xsd:documentation&gt;&lt;![CDATA[
    The name of the method to be invoked when a backing service is bound.
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
        &lt;xsd:attribute name="unbind-method" type="xsd:token" use="optional"&gt;
        	&lt;xsd:annotation&gt;
        		&lt;xsd:documentation&gt;&lt;![CDATA[
    The name of the method to be invoked when a backing service is unbound.
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
    &lt;/xsd:complexType&gt;
    
    &lt;!-- single reference --&gt;
    &lt;xsd:complexType name="TsingleReference"&gt;
        &lt;xsd:complexContent&gt;
            &lt;xsd:extension base="Treference"&gt;
                 &lt;xsd:attribute name="cardinality" use="optional" type="TsingleReferenceCardinality"&gt;
                	&lt;xsd:annotation&gt;
                      	&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines the required cardinality of the relationship to the backing service. If not specified, 
    the default-cardinality attribute will apply. A value is '1..1' means that a backing service 
    must exist (this is a mandatory service reference). A value of '0..1' indicates that it is 
    acceptable to be no backing service (an optional service reference).
                      	]]&gt;&lt;/xsd:documentation&gt;
                      &lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
				&lt;xsd:attribute name="timeout" use="optional" type="xsd:long"&gt;
                    &lt;xsd:annotation&gt;
                      	&lt;xsd:documentation&gt;&lt;![CDATA[
    For a 'reference' element, the amount of time (in milliseconds) to wait for a backing service to be 
    available when an operation is invoked. If not specified, the default-timeout attribute will apply.
    See also the default-timeout attribute of the osgi element.
                      	]]&gt;&lt;/xsd:documentation&gt;
                      &lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
            &lt;/xsd:extension&gt;
        &lt;/xsd:complexContent&gt;
   &lt;/xsd:complexType&gt;
   
   &lt;xsd:simpleType name="TsingleReferenceCardinality"&gt;
        &lt;xsd:restriction base="xsd:token"&gt;
            &lt;xsd:enumeration value="1..1"/&gt;
            &lt;xsd:enumeration value="0..1"/&gt;
        &lt;/xsd:restriction&gt;
   &lt;/xsd:simpleType&gt;

	&lt;!-- reference collections (set, list) --&gt;
	&lt;xsd:element name="list" type="TreferenceCollection"&gt;
		&lt;xsd:annotation&gt;
			&lt;xsd:documentation source="java:org.springframework.osgi.service.importer.support.OsgiServiceCollectionProxyFactoryBean"&gt;&lt;![CDATA[
	Defines a bean of type 'List' that contains all of the services matching the given criteria.
	The list members are managed dynamically as matching backing services come and go.
			]]&gt;&lt;/xsd:documentation&gt;
			&lt;xsd:appinfo&gt;
				&lt;tool:annotation&gt;
					&lt;tool:exports type="java.util.List"/&gt;
				&lt;/tool:annotation&gt;
			&lt;/xsd:appinfo&gt;			
		&lt;/xsd:annotation&gt;
	&lt;/xsd:element&gt;

	&lt;xsd:element name="set" type="TreferenceCollection"&gt;
		&lt;xsd:annotation&gt;
			&lt;xsd:documentation source="java:org.springframework.osgi.service.importer.support.OsgiServiceCollectionProxyFactoryBean"&gt;&lt;![CDATA[
	Defines a bean of type 'Set' that contains all of the services matching the given criteria.
	The set members are managed dynamically as matching backing services come and go.
			]]&gt;&lt;/xsd:documentation&gt;
			&lt;xsd:appinfo&gt;
				&lt;tool:annotation&gt;
					&lt;tool:exports type="java.util.Set"/&gt;
				&lt;/tool:annotation&gt;
			&lt;/xsd:appinfo&gt;			
		&lt;/xsd:annotation&gt;
	&lt;/xsd:element&gt;

	&lt;xsd:complexType name="TreferenceCollection"&gt;
		&lt;xsd:complexContent&gt;
			&lt;xsd:extension base="Treference"&gt;
				&lt;xsd:sequence minOccurs="0" maxOccurs="1"&gt;
					&lt;xsd:element name="comparator" type="Tcomparator"&gt;
						&lt;xsd:annotation&gt;
							&lt;xsd:documentation source="java:java.util.Comparator"&gt;&lt;![CDATA[
	Used to define an inline bean of type Comparator that will be used to sort the matching services.
							]]&gt;&lt;/xsd:documentation&gt;
							&lt;xsd:appinfo&gt;
								&lt;tool:annotation&gt;
									&lt;tool:expected-type type="java.util.Comparator" /&gt;
  								&lt;/tool:annotation&gt;
							&lt;/xsd:appinfo&gt;
						&lt;/xsd:annotation&gt;
					&lt;/xsd:element&gt;
				&lt;/xsd:sequence&gt;
				&lt;xsd:attribute name="comparator-ref" type="xsd:string" use="optional"&gt;
					&lt;xsd:annotation&gt;
						&lt;xsd:documentation&gt;&lt;![CDATA[
	Used to refer to a named bean implementing the Comparator interface that will be used to 
	sort the matching services.
						]]&gt;&lt;/xsd:documentation&gt;
					&lt;/xsd:annotation&gt;
				&lt;/xsd:attribute&gt;
			
			    &lt;xsd:attribute name="cardinality" use="optional" type="TcollectionCardinality"&gt;
                	&lt;xsd:annotation&gt;
                      	&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines the required cardinality of the relationship to the backing services. If not specified, 
    the default-cardinality attribute will apply. A value of '1..N' means that at least one backing 
    service must exist (this is a mandatory service reference. A value of '0..N' indicates that it 
    is acceptable for there to be no backing service (an optional service reference).
                      	]]&gt;&lt;/xsd:documentation&gt;
                      &lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;

			    &lt;xsd:attribute name="greedy-proxying" use="optional" type="xsd:boolean" default="false"&gt;
                	&lt;xsd:annotation&gt;
                      	&lt;xsd:documentation&gt;&lt;![CDATA[
    Indicates whether the proxies created for the imported OSGi services will be generated using 
    just the classes specified (false) or all the classes exported by the service and visible to
    the importing bundle (true). The default value is false.
                      	]]&gt;&lt;/xsd:documentation&gt;
                      &lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;				
                				
			&lt;/xsd:extension&gt;
		&lt;/xsd:complexContent&gt;
	&lt;/xsd:complexType&gt;
	
	&lt;xsd:complexType name="Tcomparator"&gt;
		&lt;xsd:annotation&gt;
			&lt;xsd:documentation source="java:java.util.Comparator"&gt;&lt;![CDATA[
	Used to define an inline bean of type Comparator that will be used to sort the matching services.
			]]&gt;&lt;/xsd:documentation&gt;
			&lt;xsd:appinfo&gt;
				&lt;tool:annotation&gt;
					&lt;tool:exports type="java.util.Comparator" /&gt;
  				&lt;/tool:annotation&gt;
			&lt;/xsd:appinfo&gt;
		&lt;/xsd:annotation&gt;
		&lt;xsd:choice&gt;
		   &lt;xsd:element name="natural" type="TnaturalOrdering"/&gt;
     	   &lt;xsd:sequence minOccurs="1" maxOccurs="1"&gt;
        	    &lt;!-- nested bean declaration --&gt;
           		&lt;xsd:any namespace="##other" minOccurs="1" maxOccurs="1" processContents="skip"/&gt;
        	&lt;/xsd:sequence&gt;
        &lt;/xsd:choice&gt;
	&lt;/xsd:complexType&gt;
	
	&lt;xsd:complexType name="TnaturalOrdering"&gt;
		&lt;xsd:attribute name="basis" type="TorderingBasis" use="required"/&gt;
	&lt;/xsd:complexType&gt;
	
	&lt;xsd:simpleType name="TorderingBasis"&gt;
		&lt;xsd:restriction base="xsd:token"&gt;
            &lt;xsd:enumeration value="service"/&gt;
            &lt;xsd:enumeration value="service-reference"/&gt;
        &lt;/xsd:restriction&gt;
	&lt;/xsd:simpleType&gt;
	
	&lt;xsd:simpleType name="TcollectionCardinality"&gt;
        &lt;xsd:restriction base="xsd:token"&gt;
            &lt;xsd:enumeration value="1..N"/&gt;
            &lt;xsd:enumeration value="0..N"/&gt;
        &lt;/xsd:restriction&gt;
   &lt;/xsd:simpleType&gt;
	
    &lt;!-- service --&gt;
    
    &lt;xsd:element name="service" type="Tservice"/&gt;

    &lt;xsd:complexType name="TbaseService"&gt;
        &lt;xsd:complexContent&gt;
           &lt;xsd:extension base="beans:identifiedType"&gt;
                &lt;xsd:attribute name="interface" type="xsd:token" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines the interface to advertise for this service in the service registry.
                		]]&gt;&lt;/xsd:documentation&gt;
						&lt;xsd:appinfo&gt;
							&lt;tool:annotation&gt;
  								&lt;tool:expected-type type="java.lang.Class" /&gt;
  							&lt;/tool:annotation&gt;
						&lt;/xsd:appinfo&gt;  							
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="depends-on" type="xsd:string" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Used to ensure that the service is not exported to the registry before the named bean
    has been created. 
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="context-class-loader" type="TserviceClassLoaderOptions" default="unmanaged"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines how the context class loader will be managed when an operation is invoked on the 
    exported service. The default value is 'unmanaged' which means that no management of 
    the context class loader is attempted. A value of 'service-provider' guarantees that
    the context class loader will have visibility of all the resources on the class path of 
    bundle exporting the service.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="auto-export" type="TautoExportModes" default="disabled"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Enables Spring to automatically manage the set of service interfaces advertised for the
    service. By default this facility is disabled. A value of 'interfaces' advertises all 
    of the Java interfaces supported by the exported service. A value of 'class-hierarchy' 
    advertises all the Java classes in the hierarchy of the exported service. A value of 
    'all-classes' advertises all Java interfaces and classes. 
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
        	&lt;/xsd:extension&gt;
        &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;
    
    &lt;xsd:complexType name="Tservice"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation source="java:org.springframework.osgi.service.exporter.support.OsgiServiceFactoryBean"&gt;&lt;![CDATA[
    Exports the reference bean as a service in the OSGi service registry. The bean defined by this element is of 
    type org.osgi.framework.ServiceRegistration.
    		]]&gt;&lt;/xsd:documentation&gt;
			&lt;xsd:appinfo&gt;
				&lt;tool:annotation&gt;
					&lt;tool:exports type="org.osgi.framework.ServiceRegistration"/&gt;
				&lt;/tool:annotation&gt;
			&lt;/xsd:appinfo&gt;			
    	&lt;/xsd:annotation&gt;
        &lt;xsd:complexContent&gt;
            &lt;xsd:extension base="TbaseService"&gt;
            	&lt;xsd:sequence minOccurs="0" maxOccurs="1"&gt;
                    &lt;xsd:element name="interfaces" type="beans:listOrSetType" minOccurs="0" maxOccurs="1"&gt;
                    	&lt;xsd:annotation&gt;
                    		&lt;xsd:documentation&gt;&lt;![CDATA[
    The set of service interfaces to advertise in the service registry.
                    		]]&gt;&lt;/xsd:documentation&gt;
                    	&lt;/xsd:annotation&gt;
                    &lt;/xsd:element&gt;
                    &lt;xsd:element name="registration-listener" type="TserviceRegistrationListener" minOccurs="0" maxOccurs="unbounded"&gt;
                    	&lt;xsd:annotation&gt;
                    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a listener that will be notified when this service is registered or unregistered in the
    OSGi service registry.
                    		]]&gt;&lt;/xsd:documentation&gt;
                    	&lt;/xsd:annotation&gt;
                	&lt;/xsd:element&gt;
                    &lt;xsd:element name="service-properties" type="beans:mapType" minOccurs="0" maxOccurs="1"&gt;
                       	&lt;xsd:annotation&gt;
                    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines the service properties.
                    		]]&gt;&lt;/xsd:documentation&gt;
                    	&lt;/xsd:annotation&gt;
                    &lt;/xsd:element&gt;
                    &lt;!-- nested bean declaration --&gt;
                	&lt;xsd:any namespace="##other" minOccurs="0" maxOccurs="1" processContents="skip"/&gt;
                &lt;/xsd:sequence&gt;
                &lt;xsd:attribute name="ref" type="xsd:string" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Refers to the named bean to be exported as a service in the service registry.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="ranking" type="xsd:int" default="0"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Specify the service ranking to be used when advertising the service.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
            &lt;/xsd:extension&gt;
        &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;

    &lt;xsd:complexType name="TserviceRegistrationListener"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a listener that will be notified when the bean is registered or unregistered in the OSGi Service Registry. 
    Use either the 'ref' attribute or a nested bean declaration for the listener bean.
    		]]&gt;&lt;/xsd:documentation&gt;
    	&lt;/xsd:annotation&gt;
        &lt;xsd:sequence minOccurs="0" maxOccurs="1"&gt;
            &lt;!-- nested bean declaration --&gt;
            &lt;xsd:any namespace="##other" minOccurs="1" maxOccurs="1" processContents="skip"/&gt;
        &lt;/xsd:sequence&gt;

        &lt;!-- shortcut for bean references --&gt;
        &lt;xsd:attribute name="ref" type="xsd:string" use="optional"&gt;
        	&lt;xsd:annotation&gt;
        		&lt;xsd:documentation&gt;&lt;![CDATA[
    Refers by name to the bean that will receive register and unregister events.
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
        &lt;xsd:attribute name="registration-method" type="xsd:token" use="optional"&gt;
        	&lt;xsd:annotation&gt;
        		&lt;xsd:documentation&gt;&lt;![CDATA[
    The name of the method to be invoked when the service is registered.
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
        &lt;xsd:attribute name="unregistration-method" type="xsd:token" use="optional"&gt;
        	&lt;xsd:annotation&gt;
        		&lt;xsd:documentation&gt;&lt;![CDATA[
    The name of the method to be invoked when the service is unregistered.
        		]]&gt;&lt;/xsd:documentation&gt;
        	&lt;/xsd:annotation&gt;
        &lt;/xsd:attribute&gt;
    &lt;/xsd:complexType&gt;

    &lt;xsd:simpleType name="TserviceClassLoaderOptions"&gt;
        &lt;xsd:restriction base="xsd:token"&gt;
            &lt;xsd:enumeration value="service-provider"/&gt;
            &lt;xsd:enumeration value="unmanaged"/&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:simpleType name="TautoExportModes"&gt;
        &lt;xsd:restriction base="xsd:token"&gt;
            &lt;xsd:enumeration value="disabled"/&gt;
            &lt;xsd:enumeration value="interfaces"/&gt;
            &lt;xsd:enumeration value="class-hierarchy"/&gt;
            &lt;xsd:enumeration value="all-classes"/&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;!-- bundle --&gt;

    &lt;xsd:element name="bundle" type="Tbundle"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation source="java:org.springframework.osgi.bundle.BundleFactoryBean"&gt;&lt;![CDATA[
    Defines a bean representing a Bundle object. May be used to drive bean lifecycle transitions.
    		]]&gt;&lt;/xsd:documentation&gt;
			&lt;xsd:appinfo&gt;
				&lt;tool:annotation&gt;
					&lt;tool:exports type="org.osgi.framework.Bundle"/&gt;
				&lt;/tool:annotation&gt;
			&lt;/xsd:appinfo&gt;    		
    	&lt;/xsd:annotation&gt;
    &lt;/xsd:element&gt;

    &lt;xsd:complexType name="Tbundle"&gt;
        &lt;xsd:complexContent&gt;
            &lt;xsd:extension base="beans:identifiedType"&gt;
              	&lt;!-- optional nested bean declaration --&gt;
                &lt;xsd:sequence minOccurs="0" maxOccurs="1"&gt;
		    		&lt;xsd:any namespace="##other" minOccurs="1" maxOccurs="1" processContents="lax"&gt;
            		   	&lt;xsd:annotation&gt;
                    		&lt;xsd:documentation&gt;&lt;![CDATA[
    OSGi bundle to work with.
                    		]]&gt;&lt;/xsd:documentation&gt;
							&lt;xsd:appinfo&gt;
								&lt;tool:annotation&gt;
  									&lt;tool:expected-type type="org.osgi.framework.Bundle" /&gt;
  								&lt;/tool:annotation&gt;
							&lt;/xsd:appinfo&gt;  							
                    	&lt;/xsd:annotation&gt;
            		&lt;/xsd:any&gt;
        		&lt;/xsd:sequence&gt;
        		
                &lt;xsd:attribute name="symbolic-name" type="xsd:string" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    The bundle symbolic name of the bundle object. Normally used when interacting with an already
    installed bundle.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="depends-on" type="xsd:string" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Indicates that this bundle object should not be created until the named bean has been created.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
               
                &lt;xsd:attribute name="location" type="xsd:string" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Location used to install, update or/and identify a bundle.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="action" type="TbundleAction" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Lifecyle action to drive on the bundle. 'start' starts the bundle, installing if necessary.
    'stop' stops the bundle if it is currently ACTIVE. 'install' installs the bundle if it is 
    currently uninstalled. 'uninstall' stops the bundle if needed, and then uninstalls it.
    'update' installs the bundle if needed, and then invokes the Bundle.update() operation.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="destroy-action" type="TbundleAction" use="optional"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Lifecyle action to drive on the bundle. 'start' starts the bundle, installing if necessary.
    'stop' stops the bundle if it is currently ACTIVE. 'install' installs the bundle if it is 
    currently uninstalled. 'uninstall' stops the bundle if needed, and then uninstalls it.
    'update' installs the bundle if needed, and then invokes the Bundle.update() operation.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
                &lt;xsd:attribute name="start-level" type="xsd:int" use="optional" default="0"&gt;
                	&lt;xsd:annotation&gt;
                		&lt;xsd:documentation&gt;&lt;![CDATA[
    Start level to set for the bundle.
                		]]&gt;&lt;/xsd:documentation&gt;
                	&lt;/xsd:annotation&gt;
                &lt;/xsd:attribute&gt;
            &lt;/xsd:extension&gt;
        &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;

    &lt;xsd:simpleType name="TbundleAction"&gt;
        &lt;xsd:restriction base="xsd:token"&gt;
            &lt;xsd:enumeration value="start"/&gt;
            &lt;xsd:enumeration value="stop"/&gt;
            &lt;xsd:enumeration value="install"/&gt;
            &lt;xsd:enumeration value="uninstall"/&gt;
            &lt;xsd:enumeration value="update"/&gt;
        &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

&lt;/xsd:schema&gt;
    </pre><p>Spring Compendium Schema</p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;

&lt;xsd:schema xmlns="http://www.springframework.org/schema/osgi-compendium"
            xmlns:xsd="http://www.w3.org/2001/XMLSchema"
            xmlns:beans="http://www.springframework.org/schema/beans"
            xmlns:osgi="http://www.springframework.org/schema/osgi"
            xmlns:tool="http://www.springframework.org/schema/tool"
            targetNamespace="http://www.springframework.org/schema/osgi-compendium"
            elementFormDefault="qualified"
            attributeFormDefault="unqualified"
            version="1.2"&gt;

	&lt;xsd:import namespace="http://www.w3.org/XML/1998/namespace"/&gt;
    &lt;xsd:import namespace="http://www.springframework.org/schema/beans"/&gt;
    &lt;xsd:import namespace="http://www.springframework.org/schema/tool"/&gt;
    &lt;xsd:import namespace="http://www.springframework.org/schema/osgi" 
    	schemaLocation="http://www.springframework.org/schema/osgi/spring-osgi.xsd"/&gt; 
    

    &lt;xsd:annotation&gt;
        &lt;xsd:documentation&gt;&lt;![CDATA[
    Namespace support for the compendium services provided by Spring Dynamic Modules.
        ]]&gt;&lt;/xsd:documentation&gt;
    &lt;/xsd:annotation&gt;

	&lt;!-- internal reusable type --&gt;
	&lt;xsd:attributeGroup name="updateAttributes"&gt;
		&lt;xsd:attribute name="update-strategy" use="optional"&gt;
			&lt;xsd:annotation&gt;
				&lt;xsd:documentation&gt;&lt;![CDATA[
	The strategy to use when the configuration data backing the beans defined by this element is 
	updated. The default value is 'none', meaning that any update after the initial configuration
	of the beans is ignored. A value of 'bean-managed' means that the method specified in the
	'update-method' attribute will be invoked. A value of 'container-managed' means that the container
	will autowire the bean instance by name with the new property set.
				]]&gt;&lt;/xsd:documentation&gt;
			&lt;/xsd:annotation&gt;
			&lt;xsd:simpleType&gt;
				&lt;xsd:restriction base="xsd:string"&gt;
		            &lt;xsd:enumeration value="none"/&gt;
		            &lt;xsd:enumeration value="bean-managed"/&gt;
		            &lt;xsd:enumeration value="container-managed"/&gt;
		        &lt;/xsd:restriction&gt;
			&lt;/xsd:simpleType&gt;
		&lt;/xsd:attribute&gt;
		&lt;xsd:attribute name="update-method" type="xsd:string" use="optional"&gt;
			&lt;xsd:annotation&gt;
				&lt;xsd:documentation&gt;&lt;![CDATA[
	The update-method to invoke when using a 'bean-managed' update strategy.
				]]&gt;&lt;/xsd:documentation&gt;
			&lt;/xsd:annotation&gt;
		&lt;/xsd:attribute&gt;			
	&lt;/xsd:attributeGroup&gt;
    
    
    &lt;xsd:element name="managed-properties"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a bean based on the given class name and configuration, with properties autowired-by-name 
    based on the configuration stored under the given persistent id.
    		]]&gt;&lt;/xsd:documentation&gt;
    	&lt;/xsd:annotation&gt;
    	&lt;xsd:complexType&gt;
	       	&lt;xsd:attributeGroup ref="updateAttributes"/&gt;
		    &lt;xsd:attribute name="persistent-id" type="xsd:string" use="required"&gt;
				&lt;xsd:annotation&gt;
					&lt;xsd:documentation&gt;&lt;![CDATA[
	The persistent-id under which the configuration for this bean is stored in 
	the Configuration Admin service.
					]]&gt;&lt;/xsd:documentation&gt;
				&lt;/xsd:annotation&gt;
			&lt;/xsd:attribute&gt;
		&lt;/xsd:complexType&gt;
	&lt;/xsd:element&gt;
	
    &lt;!--  managed-service-factory --&gt;

    &lt;xsd:element name="managed-service-factory"&gt;
       	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a collection of beans based on the given class name, with properties autowired-by-name based
    on the configuration sets stored under the given factory persistent id.
    		]]&gt;&lt;/xsd:documentation&gt;
    	&lt;/xsd:annotation&gt;
        &lt;xsd:complexType&gt;
        	&lt;xsd:complexContent&gt;
	            &lt;xsd:extension base="osgi:TbaseService"&gt;
	            	&lt;xsd:sequence&gt;
	                    &lt;xsd:element name="interfaces" type="beans:listOrSetType" minOccurs="0" maxOccurs="1"&gt;
	                    	&lt;xsd:annotation&gt;
	                    		&lt;xsd:documentation&gt;&lt;![CDATA[
    The set of service interfaces to advertise in the service registry.
	                    		]]&gt;&lt;/xsd:documentation&gt;
	                    	&lt;/xsd:annotation&gt;
	                    &lt;/xsd:element&gt;
	                    &lt;xsd:element name="registration-listener" type="osgi:TserviceRegistrationListener" minOccurs="0" maxOccurs="unbounded"&gt;
	                    	&lt;xsd:annotation&gt;
	                    		&lt;xsd:documentation&gt;&lt;![CDATA[
    Defines a listener that will be notified when this service is registered or unregistered in the
    OSGi service registry.
	                    		]]&gt;&lt;/xsd:documentation&gt;
	                    	&lt;/xsd:annotation&gt;
	                	&lt;/xsd:element&gt;
		            	&lt;!-- the bean definition template --&gt;
	                    &lt;xsd:any namespace="##other" minOccurs="1" maxOccurs="1" processContents="skip"&gt;
	   				       	&lt;xsd:annotation&gt;
	                    		&lt;xsd:documentation&gt;&lt;![CDATA[
	Defines the service definition template.
	                    		]]&gt;&lt;/xsd:documentation&gt;
	                    	&lt;/xsd:annotation&gt;
	                    &lt;/xsd:any&gt;
		           	&lt;/xsd:sequence&gt;
		           	&lt;xsd:attribute name="factory-pid" type="xsd:string" use="required"&gt;
						&lt;xsd:annotation&gt;
							&lt;xsd:documentation&gt;&lt;![CDATA[
	The persistent-id under which the configuration for this bean is stored in 
	the Configuration Admin service.
							]]&gt;&lt;/xsd:documentation&gt;
						&lt;/xsd:annotation&gt;
					&lt;/xsd:attribute&gt;
					&lt;xsd:attributeGroup ref="updateAttributes"/&gt;
				&lt;/xsd:extension&gt;
			&lt;/xsd:complexContent&gt;
		&lt;/xsd:complexType&gt;
	&lt;/xsd:element&gt;
	
    
    &lt;!-- cm-properties --&gt;
    &lt;xsd:element name="cm-properties"&gt;
    	&lt;xsd:annotation&gt;
    		&lt;xsd:documentation source="java:org.springframework.osgi.compendium.cm.ConfigAdminPropertiesFactoryBean"&gt;&lt;![CDATA[
    Exposes the properties found in the Configuration Admin service under the given persistent id.
    		]]&gt;&lt;/xsd:documentation&gt;
			&lt;xsd:appinfo&gt;
				&lt;tool:annotation&gt;
					&lt;tool:exports type="java.util.Properties"/&gt;
				&lt;/tool:annotation&gt;
			&lt;/xsd:appinfo&gt;
    	&lt;/xsd:annotation&gt;
    	&lt;xsd:complexType&gt;
	    	&lt;xsd:complexContent&gt;
	    		&lt;xsd:extension base="beans:propsType"&gt;
	    			&lt;xsd:attribute name="id" type="xsd:ID"/&gt;
	    		    &lt;xsd:attribute name="persistent-id" type="xsd:string" use="required"&gt;
			        	&lt;xsd:annotation&gt;
	        				&lt;xsd:documentation&gt;&lt;![CDATA[
	The persistent id under which the properties reside.
	        				]]&gt;&lt;/xsd:documentation&gt;
	        			&lt;/xsd:annotation&gt;
	        		&lt;/xsd:attribute&gt;
					&lt;xsd:attribute name="local-override" type="xsd:boolean"&gt;
						&lt;xsd:annotation&gt;
							&lt;xsd:documentation&gt;&lt;![CDATA[
	Specifies whether local properties override properties from the Configuration Admin service.
	Default is "false": properties from Configuration Admin service override local defaults.
	If set to "true", local properties will override properties from Configuration Admin service.
							]]&gt;&lt;/xsd:documentation&gt;
						&lt;/xsd:annotation&gt;
					&lt;/xsd:attribute&gt;
	    		&lt;/xsd:extension&gt;
	    	&lt;/xsd:complexContent&gt;
    	&lt;/xsd:complexType&gt;
    &lt;/xsd:element&gt;

&lt;/xsd:schema&gt;
    </pre></div><div class="appendix" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-ack"></a>Appendix&nbsp;I.&nbsp;Acknowledgments</h2></div></div></div><p>Spring Dynamic Modules would like to thank (in alphabetical order) to :
    Bill Gallagher, Olivier Gruber, Richard S. Hall, BJ Hargrave, Peter Kriens,
    Martin Lippert, Jeff McAffer, Glyn Normington, Gerd Wuetherich 
    for their contributions in the development of this documentation.</p></div></div></div></body></html>